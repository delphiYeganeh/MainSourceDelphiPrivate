BEGIN TRANSACTION
GO
IF EXISTS ( SELECT 1
            FROM   sysobjects 
            WHERE  id = object_id(N'[dbo].[ACCOUNT_HAS_BALANCE]')
                   and OBJECTPROPERTY(id, N'IsProcedure') = 1 )
BEGIN
    DROP PROCEDURE [dbo].[ACCOUNT_HAS_BALANCE]
END
GO

CREATE  procedure [dbo].[ACCOUNT_HAS_BALANCE]  
	@CREDITORACCOUNTID INT,
	@DEBTORACCOUNTID INT,
	@AMOUNT BIGINT,
	@PAYTYPEID TINYINT,
	@HAS_BALANCE BIT OUTPUT  
AS  
	SET @HAS_BALANCE=1  
	  
	DECLARE  @CREDITORBALANCE BIGINT,@DEBTORBALANCE BIGINT,  
	@CREDITORACCOUNTTYPEID TINYINT,@DEBTORACCOUNTTYPEID TINYINT,  
	@CREDITOR_DEBITSTATUSID INT, @DEBTOR_DEBITSTATUSID INT  
	  
	SELECT @CREDITORACCOUNTTYPEID=ACCOUNT.ACCOUNTTYPEID,  
		   @CREDITOR_DEBITSTATUSID =DEBITSTATUSID  
	FROM ACCOUNT,ACCOUNTTYPE  
	WHERE ACCOUNT.ACCOUNTTYPEID=ACCOUNTTYPE.ACCOUNTTYPEID AND  ACCOUNTID=@CREDITORACCOUNTID  
	  
	SELECT @DEBTORACCOUNTTYPEID=ACCOUNT.ACCOUNTTYPEID,  
		   @DEBTOR_DEBITSTATUSID =DEBITSTATUSID  
	FROM ACCOUNT,ACCOUNTTYPE  
	WHERE ACCOUNT.ACCOUNTTYPEID=ACCOUNTTYPE.ACCOUNTTYPEID AND ACCOUNTID=@DEBTORACCOUNTID  
	  
	IF @CREDITORACCOUNTTYPEID=1 RETURN  
	  
	IF @DEBTORACCOUNTTYPEID=1 AND (@PAYTYPEID=1) AND DBO.Exist(@DEBTORACCOUNTID,'9')  - @AMOUNT<0  
	BEGIN  
	  SET  @HAS_BALANCE=0  
	  RETURN  
	END  
	  
	IF @CREDITOR_DEBITSTATUSID=1 AND DBO.PUREBALANCE(@CREDITORACCOUNTID,'9')+@AMOUNT>0  
	BEGIN  
	  SET  @HAS_BALANCE=0  
	  RETURN  
	END  
	  
	IF @DEBTOR_DEBITSTATUSID=2 AND DBO.PUREBALANCE(@DEBTORACCOUNTID,'9')-@AMOUNT<0  
	BEGIN  
	  SET  @HAS_BALANCE=0  
	  RETURN  
	END
GO

COMMIT
GO