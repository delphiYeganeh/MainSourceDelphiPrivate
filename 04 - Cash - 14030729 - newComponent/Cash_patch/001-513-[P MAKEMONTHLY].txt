BEGIN TRANSACTION
GO
IF EXISTS ( SELECT 1
            FROM   sysobjects 
            WHERE  id = object_id(N'[dbo].[MAKEMONTHLY]')
                   and OBJECTPROPERTY(id, N'IsProcedure') = 1 )
BEGIN
    DROP PROCEDURE [dbo].[MAKEMONTHLY]
END
GO

CREATE  procedure [dbo].[MAKEMONTHLY]
	@ACCOUNTID INT,
	@DATEFROM CHAR(7),
	@DATETO CHAR(7)      
AS      
     
	DECLARE  @MONTHAMOUNT INT,@MONTHBEGINDATE CHAR(10), @I INT      
    
	SELECT  @MONTHBEGINDATE=MONTHLYBEGINDATE      
		FROM         ACCOUNT       
		WHERE ACCOUNTID=@ACCOUNTID      
      
	IF @MONTHAMOUNT<=0 RETURN      
      
	DECLARE @MATUREDATE CHAR(10),@DAYPART CHAR(2)      
	SET @DAYPART=SUBSTRING(@MONTHBEGINDATE,9,2)      
      
	IF @DATEFROM <@MONTHBEGINDATE       
		SET @DATEFROM=@MONTHBEGINDATE      
      
	SET @MATUREDATE=SUBSTRING(@DATEFROM,1,8)+'/'+@DAYPART      
	SET @I=1      
	WHILE @MATUREDATE< DBO.SHAMSIINCDATE(@DATETO+'/01',0,1,0)      
	BEGIN   
		SET @MONTHAMOUNT=0      
        SELECT     @MONTHAMOUNT=MONTHLYTYPE_DETAIL.AMOUNT       
           FROM       MONTHLYTYPE_DETAIL INNER JOIN      
                      MONTHLYTYPE ON MONTHLYTYPE_DETAIL.MONTHLYTYPEID = MONTHLYTYPE.MONTHLYTYPEID INNER JOIN      
                      ACCOUNT ON MONTHLYTYPE.MONTHLYTYPEID = ACCOUNT.MONTHLYTYPEID      
           WHERE ACCOUNTID=@ACCOUNTID AND      
                 SUBSTRING(MONTHLYTYPE_DETAIL.MONTHLYTYPEYEAR,3,2) =SUBSTRING(@MATUREDATE,3,2)      
                 
        IF @MONTHAMOUNT=0       
            SELECT     @MONTHAMOUNT=MAX(MONTHLYTYPE_DETAIL.AMOUNT )      
            FROM         MONTHLYTYPE_DETAIL INNER JOIN      
                        MONTHLYTYPE ON MONTHLYTYPE_DETAIL.MONTHLYTYPEID = MONTHLYTYPE.MONTHLYTYPEID INNER JOIN      
                        ACCOUNT ON MONTHLYTYPE.MONTHLYTYPEID = ACCOUNT.MONTHLYTYPEID      
            WHERE ACCOUNTID=@ACCOUNTID 
				AND SUBSTRING(MONTHLYTYPE_DETAIL.MONTHLYTYPEYEAR,3,2)<SUBSTRING(@MATUREDATE,3,2)      
		
		IF @MONTHAMOUNT<>0       
		BEGIN 
			IF @DAYPART IN (30,31) AND SUBSTRING(@MATUREDATE,6,2)=12
				SET  @MATUREDATE=SUBSTRING(@MATUREDATE,1,8)+'29'

			IF NOT EXISTS( SELECT 1 
                    FROM   FORCEPAYMENT 
                    WHERE  PARENTID=@ACCOUNTID AND     
                           MATUREDATE BETWEEN DBO.SHAMSIINCDATE(@MATUREDATE,0,0,-15) AND 
                           DBO.SHAMSIINCDATE(@MATUREDATE,0,0,15) AND 
                           FORCETYPEID=2)      
				INSERT INTO FORCEPAYMENT ( PARENTID  , FORCETYPEID  , AMOUNT  , MATUREDATE,ORDERNO )      
					VALUES                   (@ACCOUNTID , 2,@MONTHAMOUNT,@MATUREDATE,@I)
			ELSE      
				UPDATE FORCEPAYMENT      
					SET AMOUNT=@MONTHAMOUNT,ORDERNO=@I,MATUREDATE=@MATUREDATE      
					WHERE PARENTID=@ACCOUNTID 
						AND MATUREDATE BETWEEN DBO.SHAMSIINCDATE(@MATUREDATE,0,0,-15) 
						AND DBO.SHAMSIINCDATE(@MATUREDATE,0,0,15) 
						AND PAYMENTID IS NULL  
						AND FORCETYPEID=2   
		END      
        
		IF @DAYPART IN (30,31) AND SUBSTRING(@MATUREDATE,6,2)=12
            SET  @MATUREDATE=SUBSTRING(@MATUREDATE,1,8)+'29'
        
		IF @DAYPART IN (31) AND SUBSTRING(@MATUREDATE,6,2)>6 AND SUBSTRING(@MATUREDATE,6,2)<>12
            SET  @MATUREDATE=SUBSTRING(@MATUREDATE,1,8)+'30'

        IF @DAYPART IN (31) AND SUBSTRING(@MATUREDATE,6,2)=6 
            SET  @MATUREDATE=SUBSTRING(@MATUREDATE,1,8)+'30'
        
		IF SUBSTRING(@MATUREDATE,6,10)='11/30' 
            SET @MATUREDATE=SUBSTRING(@MATUREDATE,1,5)+'11/29'
    
		SET @MATUREDATE=DBO.SHAMSIINCDATE(@MATUREDATE,0,1,0) 
		IF SUBSTRING(@MATUREDATE,6,2)='01'
			SET @MATUREDATE=SUBSTRING(@MATUREDATE,1,8)+@DAYPART

		SET @I=@I+1      
	END
GO

COMMIT
GO