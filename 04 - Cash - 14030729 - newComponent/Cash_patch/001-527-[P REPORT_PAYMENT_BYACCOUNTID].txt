BEGIN TRANSACTION
GO
IF EXISTS ( SELECT 1
            FROM   sysobjects 
            WHERE  id = object_id(N'[dbo].[REPORT_PAYMENT_BYACCOUNTID]')
                   and OBJECTPROPERTY(id, N'IsProcedure') = 1 )
BEGIN
    DROP PROCEDURE [dbo].[REPORT_PAYMENT_BYACCOUNTID]
END
GO

CREATE  procedure [dbo].[REPORT_PAYMENT_BYACCOUNTID]                      
                        @ACCOUNTID INT,            
                        @DATEFROM  CHAR(10),            
                        @DATETO    CHAR(10),            
                        @SUMDEBIT  BIGINT OUTPUT,            
                        @SUMCREDIT BIGINT OUTPUT ,             
                        @PAYTYPEID INT=0     ,            
                        @SORTORDER INT=1                  
AS                 
     
          
Declare @TEMPTABLE Table (PAYMENTID Int,DOCUMENTNO Int,AMOUNT Bigint,Date Varchar(30) , OTHERACCOUNTID Int,STATUS INT,SUMAMOUNT BIGINT)                      
Declare @FIRSTAMOUNT BIGINT                      
Declare @PAYMENTID INT ,@STATUS INT ,@AMOUNT BIGINT,@SUMAMOUNT BIGINT                  
Declare @FIRSTAMOUNT2 bigint 
Set @FIRSTAMOUNT2 = 0 
Declare @CalcBenefitAndWage NVARCHAR(2)
Declare @accType int
Select @CalcBenefitAndWage = LTRIM(RTRIM(VALUE)) FROM Setting WHERE LTRIM(RTRIM(VariableName)) = 'CalcBenefitAndWage'  
Select @accType = AccountTypeID FROM Account WHERE AccountID = @ACCOUNTID   
            
If @SORTORDER =1                   
Begin                 
	If @accountid=4             
	Begin            
		SELECT @FIRSTAMOUNT = SUM(Amount)                   
			FROM PAYMENT                   
			WHERE DATE <@DATEFROM  AND (  PAYTYPEID=7 )  
              
		SELECT @FIRSTAMOUNT2=SUM(CASE WHEN @ACCOUNTID=DEBTORACCOUNTID   THEN +AMOUNT ELSE -AMOUNT END)                      
			FROM PAYMENT                   
			WHERE DATE <@DATEFROM  AND ( @accountid IN(DEBTORACCOUNTID,CREDITORACCOUNTID) and  PAYTYPEID<>7 ) 
    
		SET @FIRSTAMOUNT = @FIRSTAMOUNT2 - @FIRSTAMOUNT      
                 
	End            
	Else  if @accountid=1             
	Begin            
		SELECT @FIRSTAMOUNT=SUM(CASE WHEN @ACCOUNTID=DEBTORACCOUNTID   THEN +AMOUNT ELSE -AMOUNT END)                      
			FROM PAYMENT                   
			WHERE DATE <@DATEFROM  AND ( @accountid IN(DEBTORACCOUNTID,CREDITORACCOUNTID))            
	End            
	Else            
	Begin 
		If @CalcBenefitAndWage = '0' And @accType = 1
			Select @FIRSTAMOUNT=SUM(Case When @ACCOUNTID=DEBTORACCOUNTID  Then +AMOUNT Else -AMOUNT End)                      
				From PAYMENT                      
				Where Date <@DATEFROM  AND (@ACCOUNTID IN (DEBTORACCOUNTID,CREDITORACCOUNTID)and  PAYTYPEID<>7 AND PayTypeID <>6) 
		Else
			Select @FIRSTAMOUNT=SUM(Case When @ACCOUNTID=DEBTORACCOUNTID Then +AMOUNT Else -AMOUNT End)                      
				From PAYMENT                      
				Where Date <@DATEFROM  AND (@ACCOUNTID IN (DEBTORACCOUNTID,CREDITORACCOUNTID))                          
	End             
                          
	Set @FIRSTAMOUNT=ISNULL(@FIRSTAMOUNT,0)                     
                       
	Insert Into @TEMPTABLE(PAYMENTID,DOCUMENTNO,DATE,AMOUNT,OTHERACCOUNTID,STATUS,SUMAMOUNT)                      
                   Values(0,0,@DATEFROM,ABS(@FIRSTAMOUNT),0,Case When @FIRSTAMOUNT>0 Then +1 Else -1 End,@FIRSTAMOUNT)                      
          
	IF @Accountid=4             
	Begin         
		INSERT INTO @TEMPTABLE            
			SELECT	PAYMENT.PAYMENTID,
					PAYMENT.DOCUMENTNO,
					Amount,
					DATE+TIME+CAST(PAYMENTID AS VARCHAR(10)) DATE,
					PAYMENT.CreditorAccountId OTHERACCOUNTID,
					Cast(-1 AS SmallInt) Status,
					CAST(0 AS BIGINT) SUMAMOUNT
				From	Payment  
					Inner Join Account ac1 on creditorAccountId=ac1.AccountId
				Where Date BETWEEN  @DATEFROM  and @DATETO
					And CreditorAccountId=4             
        
		INSERT INTO @TEMPTABLE          
			SELECT	PAYMENT.PAYMENTID,
					PAYMENT.DOCUMENTNO,
					Amount,
					DATE+TIME+CAST(PAYMENTID AS VARCHAR(10)) DATE,
					PAYMENT.DebtorAccountId   OTHERACCOUNTID,
					Cast(1 AS SmallInt) Status,
					CAST(0 AS BIGINT) SUMAMOUNT
				From	Payment
					Inner Join Account ac1 on DebtorAccountId=ac1.AccountId                  
				Where	Date BETWEEN  @DATEFROM  and @DATETO   
					And DebtorAccountId=4           

		INSERT INTO @TEMPTABLE            
			SELECT	PAYMENT.PAYMENTID,
					PAYMENT.DOCUMENTNO,
					Amount,
					DATE+TIME+CAST(PAYMENTID AS VARCHAR(10)) DATE,
					PAYMENT.CreditorAccountId   OTHERACCOUNTID,
					Cast(-1 AS SmallInt) Status,
					CAST(0 AS BIGINT) SUMAMOUNT
				From	Payment  
					Inner Join Account ac1 on creditorAccountId=ac1.AccountId
				Where	AccountTypeId=1
					And	PAYTYPEID=7
					And Date BETWEEN @DATEFROM  and @DATETO  

		INSERT INTO @TEMPTABLE                    
			SELECT	PAYMENT.PAYMENTID,
					PAYMENT.DOCUMENTNO,
					Amount,
					DATE+TIME+CAST(PAYMENTID AS VARCHAR(10)) DATE,
					PAYMENT.DebtorAccountId   OTHERACCOUNTID,
					1 status,
					CAST(0 AS BIGINT) SUMAMOUNT
				From	Payment  
					Inner Join Account AC2 on DebtorAccountId=ac2.AccountId
				Where	AccountTypeId=1  
					And	PAYTYPEID=7
					And	Date BETWEEN @DATEFROM  and @DATETO
	End          
	Else IF @Accountid=1             
	Begin           
		INSERT INTO @TEMPTABLE                      
			SELECT	PAYMENT.PAYMENTID,
					PAYMENT.DOCUMENTNO,
					AMOUNT,
					DATE+TIME+CAST(PAYMENTID AS VARCHAR(10)) DATE,
					CASE WHEN @ACCOUNTID=DEBTORACCOUNTID   THEN CREDITORACCOUNTID ELSE DEBTORACCOUNTID  END OTHERACCOUNTID,
					CASE WHEN @ACCOUNTID=DEBTORACCOUNTID   THEN +1 ELSE -1 END STATUS,
					CAST(0 AS BIGINT) SUMAMOUNT
				FROM	PAYMENT
				WHERE	(PAYMENT.DATE BETWEEN @DATEFROM AND @DATETO)
					And	(@accountid IN (DEBTORACCOUNTID,CREDITORACCOUNTID))                  
	End          
	Else           
	Begin  
		If @CalcBenefitAndWage = '0'  AND @accType = 1       
			INSERT INTO @TEMPTABLE
				SELECT	PAYMENT.PAYMENTID,
						PAYMENT.DOCUMENTNO,
						AMOUNT,
						DATE+TIME+CAST(PAYMENTID AS VARCHAR(10)) DATE,
						CASE WHEN @ACCOUNTID=DEBTORACCOUNTID THEN CREDITORACCOUNTID ELSE DEBTORACCOUNTID  END OTHERACCOUNTID,
						CASE WHEN @ACCOUNTID=DEBTORACCOUNTID   THEN +1 ELSE -1 END STATUS,
						CAST(0 AS BIGINT) SUMAMOUNT
					FROM	PAYMENT
					WHERE   (PAYMENT.DATE BETWEEN @DATEFROM AND @DATETO)
						And (@ACCOUNTID IN ( DEBTORACCOUNTID,CREDITORACCOUNTID))
						And (PAYMENT.PAYTYPEID = @PAYTYPEID OR 0 = @PAYTYPEID OR (payment.PayTypeSecondId = @PAYTYPEID AND @PAYTYPEID =8))
						And (Payment.PayTypeID <> 7) AND (Payment.PayTypeID <>6)
		ELSE
			INSERT INTO @TEMPTABLE
				SELECT	PAYMENT.PAYMENTID,
						PAYMENT.DOCUMENTNO,
						AMOUNT,
						DATE+TIME+CAST(PAYMENTID AS VARCHAR(10)) DATE,
						CASE WHEN @ACCOUNTID=DEBTORACCOUNTID   THEN CREDITORACCOUNTID ELSE DEBTORACCOUNTID  END OTHERACCOUNTID,
						CASE WHEN @ACCOUNTID=DEBTORACCOUNTID   THEN +1 ELSE -1 END STATUS,
						CAST(0 AS BIGINT) SUMAMOUNT
					FROM	PAYMENT
					WHERE   (PAYMENT.DATE BETWEEN @DATEFROM AND @DATETO)                      
						And (@ACCOUNTID IN ( DEBTORACCOUNTID,CREDITORACCOUNTID))                  
						And (PAYMENT.PAYTYPEID = @PAYTYPEID OR 0 = @PAYTYPEID OR (payment.PayTypeSecondId = @PAYTYPEID AND @PAYTYPEID =8))  
	End          

	SET @SUMAMOUNT=0                  
	DECLARE EMPLOYEE_CURSOR CURSOR FOR                  
				SELECT PAYMENTID,STATUS,AMOUNT                   
					FROM @TEMPTABLE                   
					ORDER BY  DATE                                     
	
	OPEN EMPLOYEE_CURSOR                
                 
	FETCH NEXT FROM EMPLOYEE_CURSOR INTO @PAYMENTID,@STATUS,@AMOUNT                  
	WHILE @@FETCH_STATUS = 0                  
	BEGIN             
                        
		SET @SUMAMOUNT=@SUMAMOUNT+(@STATUS*@AMOUNT)       

		UPDATE @TEMPTABLE
			SET SUMAMOUNT=@SUMAMOUNT
			FROM @TEMPTABLE
			WHERE PAYMENTID=@PAYMENTID

		FETCH NEXT FROM EMPLOYEE_CURSOR INTO @PAYMENTID,@STATUS,@AMOUNT
	END
	CLOSE EMPLOYEE_CURSOR
	DEALLOCATE EMPLOYEE_CURSOR

	SELECT	M.PAYMENTID,
			PAYMENT.CREDITORACCOUNTID,
			PAYMENT.DEBTORACCOUNTID,
			PAYMENT.DATE,
			PAYMENT.TIME,
			M.AMOUNT,
			PAYMENT.COMMENT,
			PAYMENT.FINANCIALNOTEID,
			PAYMENT.INSERTUSERID,
			PAYMENT.INSERTDATE,
			PAYMENT.LASTUPDATE,
			PAYMENT.LASTUSERID,
			PAYMENT.PAYTYPEID,
			PAYMENT.RELATEDID,
			CAST(PAYMENT.DOCUMENTNO AS INT) DOCUMENTNO,
			CASE WHEN STATUS>0 THEN M.AMOUNT ELSE 0 END DEBIT,
			CASE WHEN STATUS<0 THEN M.AMOUNT ELSE 0 END CREDIT,
			CASE WHEN M.PAYMENTID>0 THEN ACCOUNT.ACCOUNTTITLE ELSE 'حساب ابتداي دوره'  END ACCOUNTTITLE,
			CASE WHEN SUMAMOUNT<0 THEN 'بس' when SUMAMOUNT>0 THEN 'بد' else '-' END DEBITSTATUS,
			USERS.FULLNAME,
			ABS(SUMAMOUNT) SUMAMOUNT,
			PAYTYPETITLE,
			STATUS
		FROM	@TEMPTABLE M
			Left Join PAYMENT ON M.PAYMENTID=PAYMENT.PAYMENTID
			Left Join PAYTYPE ON PAYMENT.PAYTYPEID=PAYTYPE.PAYTYPEID
			Left Join USERS ON PAYMENT.INSERTUSERID = USERS.USERID
			Left Join ACCOUNT ON M.OTHERACCOUNTID = ACCOUNT.ACCOUNTID
			Left Join FINANCIALNOTE ON PAYMENT.FINANCIALNOTEID = FINANCIALNOTE.FINANCIALNOTEID
		WHERE (PAYMENT.PAYTYPEID = @PAYTYPEID OR 0 = @PAYTYPEID OR (payment.PayTypeSecondId = @PAYTYPEID AND @PAYTYPEID =8))
		ORDER BY M.DATE

	SELECT	@SUMCREDIT=SUM(AMOUNT)
		FROM	@TEMPTABLE
		WHERE STATUS<0

	SELECT	@SUMDEBIT=SUM(AMOUNT)
		FROM	@TEMPTABLE
		WHERE STATUS>0

	SET @SUMDEBIT=ISNULL(@SUMDEBIT,0)
	SET @SUMCREDIT=ISNULL(@SUMCREDIT,0)
End
Else
Begin 
	If @accountid=4
	Begin
		SELECT @FIRSTAMOUNT = SUM(Amount)
			FROM PAYMENT
			WHERE (DATE <@DATEFROM)  AND (PAYTYPEID=7)

		SELECT @FIRSTAMOUNT2=SUM(CASE WHEN @ACCOUNTID=DEBTORACCOUNTID   THEN +AMOUNT ELSE -AMOUNT END)
			FROM PAYMENT
			WHERE DATE <@DATEFROM  AND (@accountid IN(DEBTORACCOUNTID,CREDITORACCOUNTID) and  PAYTYPEID<>7)

		SET @FIRSTAMOUNT = @FIRSTAMOUNT2 - @FIRSTAMOUNT          
	End            
	Else	If @accountid=1
	Begin
		SELECT @FIRSTAMOUNT=SUM(CASE WHEN @ACCOUNTID=DEBTORACCOUNTID   THEN +AMOUNT ELSE -AMOUNT END)
			FROM PAYMENT
			WHERE DATE <@DATEFROM  AND ( @accountid IN(DEBTORACCOUNTID,CREDITORACCOUNTID))
	End
	Else
	Begin
		If @CalcBenefitAndWage = '0' AND @accType = 1
			SELECT @FIRSTAMOUNT=SUM(CASE WHEN @ACCOUNTID=DEBTORACCOUNTID   THEN +AMOUNT ELSE -AMOUNT END)
				FROM PAYMENT
				WHERE DATE <@DATEFROM  AND (@ACCOUNTID IN (DEBTORACCOUNTID,CREDITORACCOUNTID)and  PAYTYPEID<>7 AND PayTypeID <>6)
		ELSE --Ataie
			SELECT @FIRSTAMOUNT=SUM(CASE WHEN @ACCOUNTID=DEBTORACCOUNTID   THEN +AMOUNT ELSE -AMOUNT END)
				FROM PAYMENT
				WHERE DATE <@DATEFROM  AND (@ACCOUNTID IN (DEBTORACCOUNTID,CREDITORACCOUNTID))
	End
                          
	SET @FIRSTAMOUNT=ISNULL(@FIRSTAMOUNT,0)
                       
	INSERT INTO @TEMPTABLE(PAYMENTID,DOCUMENTNO,DATE,AMOUNT,OTHERACCOUNTID,STATUS,SUMAMOUNT)
                   VALUES(0,0,@DATEFROM,ABS(@FIRSTAMOUNT),0,CASE WHEN @FIRSTAMOUNT>0 THEN +1 ELSE -1 END,@FIRSTAMOUNT)

	If	@Accountid=4
	Begin
		INSERT INTO @TEMPTABLE            
			SELECT	PAYMENT.PAYMENTID,
					PAYMENT.DOCUMENTNO,
					Amount,
					DATE+TIME+CAST(PAYMENTID AS VARCHAR(10)) DATE,
					PAYMENT.CreditorAccountId   OTHERACCOUNTID,
					Cast(1 AS SmallInt) Status,
					CAST(0 AS BIGINT) SUMAMOUNT                   
				From Payment
					Inner Join	Account ac1 on creditorAccountId=ac1.AccountId
				Where	Date BETWEEN  @DATEFROM  and @DATETO
						And CreditorAccountId=4

		INSERT INTO @TEMPTABLE
			SELECT	PAYMENT.PAYMENTID,
					PAYMENT.DOCUMENTNO,
					Amount,
					DATE+TIME+CAST(PAYMENTID AS VARCHAR(10)) DATE,
					PAYMENT.DebtorAccountId   OTHERACCOUNTID,
					Cast(1 AS SmallInt) Status,
					CAST(0 AS BIGINT) SUMAMOUNT
				From Payment
					Inner Join Account ac1 on DebtorAccountId=ac1.AccountId
				Where	Date BETWEEN  @DATEFROM  and @DATETO
						And DebtorAccountId=4
        
		INSERT INTO @TEMPTABLE
			SELECT	PAYMENT.PAYMENTID,
					PAYMENT.DOCUMENTNO,
					Amount,
					DATE+TIME+CAST(PAYMENTID AS VARCHAR(10)) DATE,
					PAYMENT.CreditorAccountId OTHERACCOUNTID,
					Cast(1 AS SmallInt) Status,
					CAST(0 AS BIGINT) SUMAMOUNT
				From Payment
					Inner Join Account ac1 on creditorAccountId=ac1.AccountId
				Where  AccountTypeId=1
					And PAYTYPEID=7   
					And Date BETWEEN @DATEFROM  and @DATETO  --and CreditorAccountId<>4

		INSERT INTO @TEMPTABLE
		SELECT	PAYMENT.PAYMENTID,
				PAYMENT.DOCUMENTNO,
				Amount,
				DATE+TIME+CAST(PAYMENTID AS VARCHAR(10)) DATE,
				PAYMENT.DebtorAccountId OTHERACCOUNTID,
				-1 status,
				CAST(0 AS BIGINT) SUMAMOUNT
			From Payment
				Inner Join Account AC2 on DebtorAccountId=ac2.AccountId
			Where AccountTypeId=1
				And PAYTYPEID=7
				And Date BETWEEN @DATEFROM  and @DATETO
	End
	Else If @Accountid=1
	Begin
		INSERT INTO @TEMPTABLE
			SELECT	PAYMENT.PAYMENTID,
					PAYMENT.DOCUMENTNO,
					AMOUNT,
					DATE+TIME+CAST(PAYMENTID AS VARCHAR(10)) DATE,
					CASE WHEN @ACCOUNTID=DEBTORACCOUNTID   THEN CREDITORACCOUNTID ELSE DEBTORACCOUNTID  END OTHERACCOUNTID,
					CASE WHEN @ACCOUNTID=DEBTORACCOUNTID   THEN +1 ELSE -1 END STATUS,
					CAST(0 AS BIGINT) SUMAMOUNT
				FROM	PAYMENT
				WHERE	(PAYMENT.DATE BETWEEN @DATEFROM AND @DATETO)
					And	(@accountid IN (DEBTORACCOUNTID,CREDITORACCOUNTID)) 
	End
	Else
	Begin
		If @CalcBenefitAndWage = '0'  AND @accType = 1
			INSERT INTO @TEMPTABLE
				SELECT	PAYMENT.PAYMENTID,
						PAYMENT.DOCUMENTNO,
						AMOUNT,
						DATE+TIME+CAST(PAYMENTID AS VARCHAR(10)) DATE,
						CASE WHEN @ACCOUNTID=DEBTORACCOUNTID   THEN CREDITORACCOUNTID ELSE DEBTORACCOUNTID  END OTHERACCOUNTID,
						CASE WHEN @ACCOUNTID=DEBTORACCOUNTID   THEN +1 ELSE -1 END STATUS,
						CAST(0 AS BIGINT) SUMAMOUNT
					FROM	PAYMENT
					WHERE	(PAYMENT.DATE BETWEEN @DATEFROM AND @DATETO)
						And	(@ACCOUNTID IN ( DEBTORACCOUNTID,CREDITORACCOUNTID))
						And	(PAYMENT.PAYTYPEID = @PAYTYPEID OR 0 = @PAYTYPEID OR (payment.PayTypeSecondId = @PAYTYPEID AND @PAYTYPEID =8))
						And	(Payment.PayTypeID <> 7) AND (Payment.PayTypeID <>6)
		Else
			INSERT INTO @TEMPTABLE
				SELECT	PAYMENT.PAYMENTID,
						PAYMENT.DOCUMENTNO,
						AMOUNT,
						DATE+TIME+CAST(PAYMENTID AS VARCHAR(10)) DATE,
						CASE WHEN @ACCOUNTID=DEBTORACCOUNTID   THEN CREDITORACCOUNTID ELSE DEBTORACCOUNTID  END OTHERACCOUNTID,
						CASE WHEN @ACCOUNTID=DEBTORACCOUNTID   THEN +1 ELSE -1 END STATUS,
						CAST(0 AS BIGINT) SUMAMOUNT
					FROM	PAYMENT
					WHERE	(PAYMENT.DATE BETWEEN @DATEFROM AND @DATETO)
						And	(@ACCOUNTID IN ( DEBTORACCOUNTID,CREDITORACCOUNTID))
						And	(PAYMENT.PAYTYPEID = @PAYTYPEID OR 0 = @PAYTYPEID OR (payment.PayTypeSecondId = @PAYTYPEID AND @PAYTYPEID =8))
	End
         
	SET @SUMAMOUNT=0
	DECLARE EMPLOYEE_CURSOR CURSOR FOR

		SELECT PAYMENTID,STATUS,AMOUNT
			FROM @TEMPTABLE
			ORDER BY DOCUMENTNO

	OPEN EMPLOYEE_CURSOR
	FETCH NEXT FROM EMPLOYEE_CURSOR INTO @PAYMENTID,@STATUS,@AMOUNT
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @SUMAMOUNT=@SUMAMOUNT+(@STATUS*@AMOUNT)
		UPDATE @TEMPTABLE
				SET SUMAMOUNT=@SUMAMOUNT
			FROM @TEMPTABLE
			WHERE PAYMENTID=@PAYMENTID

		FETCH NEXT FROM EMPLOYEE_CURSOR INTO @PAYMENTID,@STATUS,@AMOUNT
	END
	CLOSE EMPLOYEE_CURSOR
	DEALLOCATE EMPLOYEE_CURSOR

	SELECT	M.PAYMENTID,
			PAYMENT.CREDITORACCOUNTID,
			PAYMENT.DEBTORACCOUNTID,
			PAYMENT.DATE,
			PAYMENT.TIME,
			M.AMOUNT,
			PAYMENT.COMMENT,
			PAYMENT.FINANCIALNOTEID,
			PAYMENT.INSERTUSERID,
			PAYMENT.INSERTDATE,
			PAYMENT.LASTUPDATE,
			PAYMENT.LASTUSERID,
			PAYMENT.PAYTYPEID,
			PAYMENT.RELATEDID,
			CAST(PAYMENT.DOCUMENTNO AS INT) DOCUMENTNO,
			CASE  WHEN STATUS = 1 THEN M.AMOUNT ELSE 0 END DEBIT,
			CASE  WHEN STATUS = -1 THEN M.AMOUNT ELSE 0 END CREDIT,
			USERS.FULLNAME,
			CASE WHEN M.PAYMENTID>0 THEN ACCOUNT.ACCOUNTTITLE ELSE 'حساب ابتداي دوره'  END ACCOUNTTITLE,
			CASE WHEN SUMAMOUNT<0 THEN 'بس' when SUMAMOUNT>0 THEN 'بد' else '-' END DEBITSTATUS,
			ABS(SUMAMOUNT) SUMAMOUNT,
			PAYTYPETITLE,
			STATUS
		FROM	@TEMPTABLE M
			Left Join PAYMENT ON M.PAYMENTID=PAYMENT.PAYMENTID
			Left Join PAYTYPE ON PAYMENT.PAYTYPEID=PAYTYPE.PAYTYPEID
			Left Join USERS ON PAYMENT.INSERTUSERID = USERS.USERID
			Left Join ACCOUNT ON M.OTHERACCOUNTID = ACCOUNT.ACCOUNTID
			Left Join FINANCIALNOTE  ON PAYMENT.FINANCIALNOTEID = FINANCIALNOTE.FINANCIALNOTEID                      
		WHERE (PAYMENT.PAYTYPEID = @PAYTYPEID OR 0 = @PAYTYPEID OR (payment.PayTypeSecondId = @PAYTYPEID AND @PAYTYPEID =8))
		ORDER BY M.DOCUMENTNO 

	SELECT @SUMCREDIT=SUM(AMOUNT)
		FROM @TEMPTABLE
		WHERE STATUS<0

	SELECT @SUMDEBIT=SUM(AMOUNT)
		FROM @TEMPTABLE
		WHERE STATUS>0
	
	SET @SUMDEBIT=ISNULL(@SUMDEBIT,0)
	SET @SUMCREDIT=ISNULL(@SUMCREDIT,0)
END
GO

COMMIT
GO