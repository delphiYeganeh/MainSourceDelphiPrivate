BEGIN TRANSACTION
GO
IF EXISTS ( SELECT 1
            FROM   sysobjects 
            WHERE  id = object_id(N'[dbo].[DELETE_LOAN]')
                   and OBJECTPROPERTY(id, N'IsProcedure') = 1 )
BEGIN
    DROP PROCEDURE [dbo].[DELETE_LOAN]
END
GO

CREATE  procedure [dbo].[DELETE_LOAN]
	@LOANID INT
AS         
        
Begin TRAN
 
DECLARE  @PAYMENTID INT
DECLARE  @documentno VARCHAR(10)
DECLARE  @Date VARCHAR(10)

                
SET @PAYMENTID=(SELECT PAYMENTID   FROM LOAN  WHERE LOANID=@LOANID)
SET @documentno=(SELECT documentno FROM dbo.Payment WHERE PaymentID IN (SELECT PaymentID FROM dbo.Loan WHERE LoanID=@loanId))       
SET @Date=(SELECT TOP 1 date FROM dbo.Payment WHERE PAYMENTID IN (SELECT PAYMENTID FROM LOAN  WHERE LOANID=@LOANID) )



    
 DELETE PAYMENT WHERE PAYMENTID  IN (SELECT WAGEPAYMENTID FROM LOAN  WHERE LOANID=@LOANID)          
 DELETE PAYMENT WHERE PAYMENTID  IN (SELECT PAYMENTID FROM LOAN  WHERE LOANID=@LOANID)          
 DELETE PAYMENT WHERE PAYMENTID  IN (SELECT PAYMENTID FROM FORCEPAYMENT WHERE FORCETYPEID=1 AND PARENTID=@LOANID)          
 DELETE PAYMENT WHERE RELATEDID  IN (SELECT FORCEPAYMENTID FROM FORCEPAYMENT WHERE PARENTID=@LOANID AND  FORCETYPEID=1 ) AND PayTypeID=7    

 DELETE dbo.Payment  WHERE PaymentID IN(SELECT PaymentID FROM dbo.ForcePayment WHERE ParentID=@loanId AND    FORCETYPEID=1 )
 DELETE  FROM PAYMENT WHERE Documentno =@documentno AND Date =@Date

 UPDATE FinancialNote_Detail       
 SET ForcePaymentID=NULL      
 WHERE ForcePaymentID IN (SELECT FORCEPAYMENTID FROM   FORCEPAYMENT WHERE FORCETYPEID=1 AND PARENTID=@LOANID )     
 
 DELETE FORCEPAYMENT  WHERE FORCETYPEID=1 AND PARENTID=@LOANID  
 DELETE ATTACHMENT    WHERE DOCUMENTID=@LOANID AND DOCUMENTTYPEID=2          
 DELETE LOANGAURANTOR WHERE LOANID=@LOANID          
 DELETE LOAN WHERE LOANID=@LOANID          
      
Commit Tran
GO

COMMIT
GO