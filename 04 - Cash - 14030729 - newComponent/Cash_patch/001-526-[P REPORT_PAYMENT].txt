BEGIN TRANSACTION
GO
IF EXISTS ( SELECT 1
            FROM   sysobjects 
            WHERE  id = object_id(N'[dbo].[REPORT_PAYMENT]')
                   and OBJECTPROPERTY(id, N'IsProcedure') = 1 )
BEGIN
    DROP PROCEDURE [dbo].[REPORT_PAYMENT]
END
GO

CREATE  procedure [dbo].[REPORT_PAYMENT]
(
	@WHERE VARCHAR(1000)
)  
AS  
	DECLARE @SQL NVARCHAR(4000)  
  
	SET @WHERE =ISNULL(LTRIM(@WHERE),'')  
	IF @WHERE <>'' 
		SET @WHERE=' WHERE  '+@WHERE  
  
	SET @SQL='SELECT PAYMENTID,CREDITORACCOUNT.ACCOUNTTITLE AS CREDITORACCOUNTTITLE,  
		DEBTORACCOUNT.ACCOUNTTITLE AS DEBTORACCOUNTTITLE,  
		PAYTYPE.PAYTYPETITLE,  
		PAYMENT.DATE,PAYMENT.TIME, PAYMENT.AMOUNT, PAYMENT.COMMENT, PAYMENT.INSERTDATE,CAST(PAYMENT.DOCUMENTNO AS INT) DOCUMENTNO,  
		FINANCIALNOTE_DETAIL.NOTENO, FinancialNote_Master.MATUREDATE, FINANCIALNOTE_DETAIL.AMOUNT FINANCIALNOTEAMOUNT,FINANCIALNOTETYPE.FINANCIALNOTETYPETITLE,  
		USERS.FULLNAME,ISNULL(COMMENT,PAYTYPETITLE) COMMENT2  
	FROM PAYMENT  
		INNER JOIN PAYTYPE ON PAYMENT.PAYTYPEID = PAYTYPE.PAYTYPEID  
		INNER JOIN ACCOUNT AS CREDITORACCOUNT ON PAYMENT.CREDITORACCOUNTID = CREDITORACCOUNT.ACCOUNTID  
		INNER JOIN ACCOUNT AS DEBTORACCOUNT ON PAYMENT.DEBTORACCOUNTID = DEBTORACCOUNT.ACCOUNTID  
		LEFT JOIN USERS ON PAYMENT.INSERTUSERID = USERS.USERID  
		LEFT JOIN  FinancialNote_Detail ON PAYMENT.FINANCIALNOTE_DETAILID = FinancialNote_Detail.FinancialNote_DetailID  
		left JOIN FinancialNote_Master ON FinancialNote_Detail.FinancialNote_MasterID = FinancialNote_Master.FinancialNote_MasterID
		LEFT JOIN  FINANCIALNOTETYPE ON FinancialNote_Master.FINANCIALNOTETYPEID = FINANCIALNOTETYPE.FINANCIALNOTETYPEID '  
    
	SET @SQL=@SQL+@WHERE+' ORDER BY CAST(DOCUMENTNO AS INT), PAYMENTID DESC'  
  
	EXEC SP_EXECUTESQL @SQL
GO

COMMIT
GO