BEGIN TRANSACTION
GO
IF EXISTS ( SELECT 1
            FROM   sysobjects 
            WHERE  id = object_id(N'[dbo].[GET_NEWACCOUNTNO_New]')
                   and OBJECTPROPERTY(id, N'IsProcedure') = 1 )
BEGIN
    DROP PROCEDURE [dbo].[GET_NEWACCOUNTNO_New]
END
GO

CREATE  procedure [dbo].[GET_NEWACCOUNTNO_New]           
                   @ACCOUNTTYPEID TINYINT,@NEWACCOUNTNO VARCHAR(20) OUTPUT              
AS              
               
DECLARE @PREACCOUNTNO VARCHAR(2),@ACCOUNTLENGTH TINYINT,@LoanLength TINYINT ,@OLDCODE INT              

EXEC GET_SYSTEMSETTING 'ACCOUNTLENGTH',@ACCOUNTLENGTH OUTPUT   
EXEC GET_SYSTEMSETTING 'LoanLength',@LoanLength OUTPUT   

SELECT     @PREACCOUNTNO=CASE PREACCOUNTNO WHEN ''   THEN 0           
                                           WHEN NULL THEN 0           
                                           ELSE PREACCOUNTNO           
                                           END            
FROM       ACCOUNTTYPE              
WHERE     (ACCOUNTTYPEID = @ACCOUNTTYPEID)              

SET @PREACCOUNTNO=ISNULL(LTRIM(RTRIM(@PREACCOUNTNO)),'')              

IF @PREACCOUNTNO = 20
BEGIN
	IF EXISTS(SELECT LoanNO FROM dbo.Loan)
	BEGIN
		SELECT @NEWACCOUNTNO = MAX(CAST(LoanNO AS INT)) + 1 FROM dbo.Loan
    END
	ELSE
    BEGIN
		SET @NEWACCOUNTNO = 1
    END
END
ELSE
BEGIN
	IF @ACCOUNTTYPEID<>7
		SELECT @OLDCODE=MAX(CAST(SUBSTRING(ACCOUNTNO,LEN(@PREACCOUNTNO)+1,10)AS BIGINT))              
			FROM ACCOUNT              
			WHERE 
				AccountNo NOT LIKE '%/%' And
				ACCOUNTNO LIKE @PREACCOUNTNO+'%' AND ACCOUNTTYPEID=@ACCOUNTTYPEID              
	ELSE              
		SELECT @OLDCODE=MAX(CAST(SUBSTRING(LOANNO,LEN(@PREACCOUNTNO)+1,10) AS BIGINT))              
			FROM LOAN              
			WHERE LOANNO LIKE @PREACCOUNTNO+'%'
				AND LoanNO NOT LIKE '%/%'
              
	SET @OLDCODE=ISNULL(@OLDCODE,0)              
	SET @NEWACCOUNTNO=CAST(@OLDCODE+1 AS VARCHAR(10))              

	IF @ACCOUNTTYPEID<>7      
		WHILE LEN(@NEWACCOUNTNO)<@ACCOUNTLENGTH-LEN(@PREACCOUNTNO)               
			SET @NEWACCOUNTNO='0'+@NEWACCOUNTNO   
  
	ELSE IF @ACCOUNTTYPEID=7      
		WHILE LEN(@NEWACCOUNTNO)<@LoanLENGTH-LEN(@PREACCOUNTNO)               
		SET @NEWACCOUNTNO='0'+@NEWACCOUNTNO   

	SET @NEWACCOUNTNO=@PREACCOUNTNO+ISNULL(@NEWACCOUNTNO,0)    

END
GO

COMMIT
GO