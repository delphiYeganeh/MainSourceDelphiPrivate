BEGIN TRANSACTION
GO
IF EXISTS ( SELECT 1
            FROM   sysobjects 
            WHERE  id = object_id(N'[dbo].[REPORT_LOANPOINTByNaseri]')
                   and OBJECTPROPERTY(id, N'IsProcedure') = 1 )
BEGIN
    DROP PROCEDURE [dbo].[REPORT_LOANPOINTByNaseri]
END
GO

CREATE  procedure [dbo].[REPORT_LOANPOINTByNaseri]     
@TODAY CHAR(10)     
AS      
DECLARE @LASTLOANDATE   CHAR(10),@ACCOUNTDATE CHAR(10),@REQUESTDATE CHAR(10),@POINT INT      
DECLARE @PARTDELAYPOINT INT , @MONTHLYDELAYPOINT INT, @LASTLOANPOINT INT,@LOANREQUESTPOINT INT,@BALANCEPOINT INT      
DECLARE @LoanPointSetting  INT,@MonthPointSetting INT
      
SELECT @BALANCEPOINT=VALUE      
FROM SETTING      
WHERE  VARIABLENAME='BALANCEPOINT' AND USERID=-1      
      
SELECT @PARTDELAYPOINT=VALUE      
FROM SETTING      
WHERE  VARIABLENAME='PARTDELAYPOINT' AND USERID=-1      
      
SELECT @MONTHLYDELAYPOINT=VALUE      
FROM SETTING      
WHERE  VARIABLENAME='MONTHLYDELAYPOINT' AND USERID=-1      
      
SELECT @LASTLOANPOINT=VALUE      
FROM SETTING      
WHERE  VARIABLENAME='LASTLOANPOINT' AND USERID=-1      
      
SELECT @LOANREQUESTPOINT=VALUE      
FROM SETTING      
WHERE  VARIABLENAME='LOANREQUESTPOINT' AND USERID=-1      
      
      
SELECT      
ACCOUNTID,ACCOUNTNO,ACCOUNTTITLE,ACCOUNTDATE,      
(SELECT TOP 1 LOANDATE FROM LOAN WHERE ACCOUNTID=ACC.ACCOUNTID ORDER BY LOANDATE DESC ) LASTLOANDATE,      
(SELECT TOP 1 LOANID FROM LOAN WHERE ACCOUNTID=ACC.ACCOUNTID ORDER BY LOANDATE DESC ) LASTLOANID,      
(SELECT  MAX(REQUESTDATE) FROM DBO.LOANREQUEST WHERE ACCOUNTID=ACC.ACCOUNTID  AND EXPIRED=0)  REQUESTDATE,      
CAST(0 AS INT) PARTDELAY,      
CAST(0 AS INT) MONTHLYDELAY,      
CAST(0 AS INT) AS AVGPOINT,      
CAST(0 AS INT) AS POINT,      
CAST(0 AS TINYINT) NUMBEROFPART,      
CAST(0 AS INT) LASTLOANAMOUNT,      
CAST('' AS VARCHAR(10)) LASTLOANNO,      
CAST(0 AS INT) REMAINOFLOAN INTO #M      
FROM ACCOUNT ACC      
WHERE ACCOUNTTYPEID=1      
      
UPDATE #M      
SET LASTLOANDATE=ISNULL(LASTLOANDATE,ACCOUNTDATE),      
 LASTLOANID=ISNULL(LASTLOANID,0)      
      
      
SET @LoanPointSetting  =(SELECT [VALUE] FROM SETTING WHERE VARIABLENAME ='LoanPoint')
SET @MonthPointSetting =(SELECT [VALUE] FROM SETTING WHERE VARIABLENAME ='MonthPoint')

IF @LoanPointSetting=0/*تاخير بر اساس آخرين وام */
BEGIN
		UPDATE #M       
		SET PARTDELAY= DBO.LOANDELAY(LASTLOANID,@TODAY) /*تاخير بر اساس آخرين وام */
END
   
IF @LoanPointSetting=1 /* تاخير بر اساس افتتاح حساب */
BEGIN
		UPDATE #M       
		SET PARTDELAY=dbo.LoanDelay_ByAccountId(ACCOUNTID,@TODAY) /* تاخير بر اساس افتتاح حساب */
END

IF @MonthPointSetting=0 /*تاخير بر اساس آخرين وام  */
BEGIN
		UPDATE #M       
		SET MONTHLYDELAY=DBO.MONTHLYDELAY(ACCOUNTID,ISNULL(LASTLOANDATE,ACCOUNTDATE),@TODAY) /*تاخير بر اساس آخرين وام    */
END
IF @MonthPointSetting=1 /* تاخير بر اساس افتتاح حساب */
BEGIN
		UPDATE #M       
		SET MONTHLYDELAY=DBO.MONTHLYDELAY(ACCOUNTID,ISNULL(REQUESTDATE,ACCOUNTDATE),@TODAY) /* تاخير بر اساس افتتاح حساب */
END

UPDATE #M       
SET AVGPOINT= DBO.SUMBALANCE(ACCOUNTID,LASTLOANDATE,@TODAY)/304000
    
 UPDATE #M      
SET NUMBEROFPART=(SELECT COUNT(1) FROM FORCEPAYMENT WHERE  PARENTID=#M.LASTLOANID AND FORCETYPEID=1 ) ,      
REMAINOFLOAN=(SELECT SUM(AMOUNT) FROM FORCEPAYMENT WHERE FORCETYPEID=1 AND PARENTID=#M.LASTLOANID AND PAID=0)      
      
UPDATE #M      
SET LASTLOANAMOUNT=AMOUNT,LASTLOANNO=LOANNO      
FROM #M INNER JOIN LOAN ON LOAN.LOANID=#M.LASTLOANID      
      
UPDATE #M      
SET POINT=-@MONTHLYDELAYPOINT*MONTHLYDELAY-@PARTDELAYPOINT*PARTDELAY+@BALANCEPOINT*AVGPOINT      
+@LASTLOANPOINT*ISNULL(DBO.SHAMSIDATEDIFF(LASTLOANDATE,@TODAY),0)      
+@LOANREQUESTPOINT*ISNULL(DBO.SHAMSIDATEDIFF(ISNULL(REQUESTDATE,@TODAY),@TODAY),0)      
      
SELECT * 
FROM #M
Where  (Accountid in(SELECT AccountID FROM LoanPriority))    
ORDER BY POINT ASC

UPDATE LoanPriority
SET Point = #M.point,Priority = 0 FROM LoanPriority lp
INNER JOIN #M ON lp.AccountID = #M.AccountID

CREATE TABLE LoanPriorityByNaseri 
(
	AccountID INT,
	Priority SMALLINT IDENTITY(1,1),
	Point INT,
	IsUrgency BIT
)

INSERT INTO LoanPriorityByNaseri
(
	AccountID,
	Point,
	IsUrgency
)
Select AccountID,Point,IsUrgency FROM LoanPriority ORDER BY Point Asc

TRUNCATE TABLE LoanPriority

INSERT INTO LoanPriority
(
	AccountID,
	Priority,
	Point,
	IsUrgency
)
Select AccountID,Priority,Point,IsUrgency FROM LoanPriorityByNaseri

DROP TABLE LoanPriorityByNaseri
GO

COMMIT
GO