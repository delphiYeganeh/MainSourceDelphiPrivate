BEGIN TRANSACTION
GO
IF EXISTS ( SELECT 1
            FROM   sysobjects 
            WHERE  id = object_id(N'[dbo].[REPORT_PAYMENT_BYDOCUMENTNO]')
                   and OBJECTPROPERTY(id, N'IsProcedure') = 1 )
BEGIN
    DROP PROCEDURE [dbo].[REPORT_PAYMENT_BYDOCUMENTNO]
END
GO

CREATE  procedure [dbo].[REPORT_PAYMENT_BYDOCUMENTNO]
@DOCUMENTNO VARCHAR(10),@YEAR INT =0        
AS        
DECLARE @Y VARCHAR(10)        
SET @Y = CAST(@YEAR AS  CHAR(4))     
       
SELECT     PAYMENT.*,        
           CREDITORACCOUNT.ACCOUNTTITLE AS CREDITORACCOUNTTITLE,        
           DEBTORACCOUNT.ACCOUNTTITLE   AS DEBTORACCOUNTTITLE,        
           RTRIM(PAYTYPE.PAYTYPETITLE) +  (CASE WHEN PAYMENT.PAYTYPEID = 3 THEN ( SELECT ' - ق ش '+(CAST(ORDERNO AS NVARCHAR(10)))AS ORDERNODESC FROM FORCEPAYMENT WHERE FORCEPAYMENT.PAYMENTID = PAYMENT.PAYMENTID ) END) AS PAYTYPETITLE,
           FINANCIALNOTE.NOTENO, FINANCIALNOTE.MATUREDATE, FINANCIALNOTE.AMOUNT FINANCIALNOTEAMOUNT,FINANCIALNOTETYPE.FINANCIALNOTETYPETITLE,        
           USERS.FULLNAME,    
           ISNULL(COMMENT,PAYTYPETITLE) COMMENT2 ,     
           FINANCIALNOTE_DETAIL.AMOUNT AS NOTE_DETAILAMOUNT,     
           FINANCIALNOTE_DETAIL.NOTENO AS NOTE_DETAILNOTENO,     
           FINANCIALNOTE_DETAIL.NOTEDATE AS DETAILNOTEDATE,     
           FINANCIALNOTESTATUS.FINANCIALNOTESTATUSDESC AS STATUSFINANCIALNOTESTATUSDESC,     
           FINANCIALNOTE_MASTER.FINANCIALNOTETYPEID AS MASTERFINANCIALNOTETYPEID,     
           PayType.PayTypeTitle AS NOTE_DETAILFINANCIALNOTETYPETITLE    
FROM                  FINANCIALNOTE_MASTER INNER JOIN  
                      FINANCIALNOTE_DETAIL ON FINANCIALNOTE_MASTER.FINANCIALNOTE_MASTERID = FINANCIALNOTE_DETAIL.FINANCIALNOTE_MASTERID INNER JOIN  
                      FINANCIALNOTESTATUS ON FINANCIALNOTE_DETAIL.NOTESTATUSID = FINANCIALNOTESTATUS.FINANCIALNOTESTATUSID INNER JOIN  
                      FINANCIALNOTETYPE FINANCIALNOTETYPE ON   
                      FINANCIALNOTE_MASTER.FINANCIALNOTETYPEID = FINANCIALNOTETYPE.FINANCIALNOTETYPEID RIGHT OUTER JOIN  
                      PAYMENT INNER JOIN  
                      PAYTYPE ON PAYMENT.PAYTYPEID = PAYTYPE.PAYTYPEID INNER JOIN  
                      ACCOUNT CREDITORACCOUNT ON PAYMENT.CREDITORACCOUNTID = CREDITORACCOUNT.ACCOUNTID INNER JOIN  
                      ACCOUNT DEBTORACCOUNT ON PAYMENT.DEBTORACCOUNTID = DEBTORACCOUNT.ACCOUNTID ON   
                      FINANCIALNOTE_DETAIL.FINANCIALNOTE_DETAILID = PAYMENT.FINANCIALNOTE_DETAILID LEFT OUTER JOIN  
                      USERS ON PAYMENT.INSERTUSERID = USERS.USERID LEFT OUTER JOIN  
                      FINANCIALNOTE ON FINANCIALNOTE_DETAIL.FinancialNote_MasterID = FINANCIALNOTE.FINANCIALNOTEID LEFT OUTER JOIN  
                      FINANCIALNOTETYPE FINANCIALNOTETYPE_1 ON FinancialNote_Master.FINANCIALNOTETYPEID = FINANCIALNOTETYPE_1.FINANCIALNOTETYPEID  
  
WHERE ((DOCUMENTNO = @DOCUMENTNO)OR('0' = @DOCUMENTNO)/*تمامي اسناد*/)        
    AND (Left(PAYMENT.[DATE], 4) = @Y Or @YEAR = 0)
ORDER BY CAST(PAYMENT.DOCUMENTNO AS INT), PAYMENT.[DATE]
GO

COMMIT
GO