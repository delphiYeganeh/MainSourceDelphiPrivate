BEGIN TRANSACTION
GO
IF EXISTS ( SELECT 1
            FROM   sysobjects 
            WHERE  id = object_id(N'[dbo].[Update_Rep_LOANPOINT]')
                   and OBJECTPROPERTY(id, N'IsProcedure') = 1 )
BEGIN
    DROP PROCEDURE [dbo].[Update_Rep_LOANPOINT]
END
GO

CREATE  procedure [dbo].[Update_Rep_LOANPOINT]
@ACCountID Int, @TODAY CHAR(10),@AccountNO varchar(20),@AccountTitle nvarchar(100)      
AS      
DECLARE @LASTLOANDATE   CHAR(10),@ACCOUNTDATE CHAR(10),@REQUESTDATE CHAR(10),@POINT INT      
DECLARE @PARTDELAYPOINT INT , @MONTHLYDELAYPOINT INT, @LASTLOANPOINT INT,@LOANREQUESTPOINT INT,@BALANCEPOINT INT      
DECLARE @LoanPointSetting  INT,@MonthPointSetting INT
DECLARE @GroupPoint INT 
      
SELECT @BALANCEPOINT=VALUE 
FROM SETTING      
WHERE  VARIABLENAME='BALANCEPOINT' AND USERID=-1      
      
SELECT @LASTLOANPOINT=VALUE 
FROM SETTING      
WHERE  VARIABLENAME='LASTLOANPOINT' AND USERID=-1      
      
SELECT @LOANREQUESTPOINT=VALUE 
FROM SETTING      
WHERE  VARIABLENAME='LOANREQUESTPOINT' AND USERID=-1      

SELECT @GroupPoint=isnull(VALUE, 0) 
FROM Setting 
WHERE VariableName='GroupPoint' AND UserID=-1
set @GroupPoint= ISNULL(@GroupPoint, 0)

SElect @LASTLOANDATE=LASTLOANDATE from rep_loanpoint
where ACCOUNTID=@ACCountID

UPDATE Rep_LoanPoint       
SET AVGPOINT= DBO.SUMBALANCE(@ACCountID,@LASTLOANDATE,@TODAY)/304000
WHERE ACCOUNTID=@ACCountID

     
UPDATE Rep_LoanPoint      
SET POINT=-MONTHLYDELAY - PARTDELAY
+@BALANCEPOINT*AVGPOINT      
+@LASTLOANPOINT*ISNULL(DBO.SHAMSIDATEDIFF(LASTLOANDATE,@TODAY),0)      
+@LOANREQUESTPOINT*ISNULL(DBO.SHAMSIDATEDIFF(ISNULL(REQUESTDATE,@TODAY),@TODAY),0) 
+@GroupPoint*GroupPaymentPoint
WHERE ACCOUNTID=@ACCountID
      
SELECT *      
FROM Rep_LoanPoint     
Where  (AccountNO=@AccountNO OR @AccountNO='0') AND (ACCountID=@ACCountID) AND (AccountTitle=@AccountTitle OR @AccountTitle='0' )
GO

COMMIT
GO