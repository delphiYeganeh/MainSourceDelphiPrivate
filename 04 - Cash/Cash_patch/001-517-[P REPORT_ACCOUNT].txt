BEGIN TRANSACTION
GO
IF EXISTS ( SELECT 1
            FROM   sysobjects 
            WHERE  id = object_id(N'[dbo].[REPORT_ACCOUNT]')
                   and OBJECTPROPERTY(id, N'IsProcedure') = 1 )
BEGIN
    DROP PROCEDURE [dbo].[REPORT_ACCOUNT]
END
GO

CREATE  procedure [dbo].[REPORT_ACCOUNT]
(
	@ACCOUNTTYPEID TINYINT,
	@WHERE VARCHAR(1000),
	@ROWCOUNT CHAR(100)=500
)      
AS      

	DECLARE @SQL NVARCHAR(4000)      

	SET @WHERE =ISNULL(LTRIM(@WHERE),'')      
	IF @WHERE <>'' 
		SET @WHERE=' AND  '+@WHERE      
      
	IF @ROWCOUNT=0 
		SET @SQL='SELECT '
	ELSE
		SET @SQL='SELECT TOP '+@ROWCOUNT

	SET       @SQL=@SQL+' MONTHLYTYPE.MONTHLYTYPETITLE, BANK.BANKTITLE, ACCOUNT.ACCOUNTID, ACCOUNT.ACCOUNTTITLE, ACCOUNTNO, dbo.FnYSrtToInt(AccountNo) AS AccountNoInt , ACCOUNTDATE, ACCOUNT.ISACTIVE,      
                      ACCOUNT.MONTHLYTYPEID, ACCOUNT.MONTHLYBEGINDATE, ACCOUNT.FAMILYID, ACCOUNT.ACCOUNTTYPEID, CONTACT.CONTACTID, CONTACT.PERSONALNO,      
                      FIRSTNAME, LASTNAME,LASTNAME+ISNULL('' - ''+FIRSTNAME,'''') FULLNAME, FATHERNAME, CONTACT.IDNO, CONTACT.BIRTHPLACE, CONTACT.BIRTHDATE, CONTACT.ADDRESS, CONTACT.PHONES,      
                      JOB, MEMO, USERFIELD1, USERFIELD2,      
                      CONTACTTYPEID,FAMILYTITLE,DBO.EXIST(ACCOUNT.ACCOUNTID,''9'') EXIST,    
                      DBO.TOTALEXIST(ACCOUNT.ACCOUNTID,''9'', '+Convert(nvarchar, @ACCOUNTTYPEID)+') TOTALEXIST,    
						CASE SIGN(DBO.BALANCE(ACCOUNT.ACCOUNTID,''9'')) WHEN 1 THEN ''بستانکار '' WHEN -1 THEN  ''بدهكار'' ELSE ''تسويه '' END DEBITSTATUSTITLE
				FROM ACCOUNT       
				INNER JOIN    CONTACT ON ACCOUNT.CONTACTID = CONTACT.CONTACTID       
				LEFT  JOIN    BANK ON ACCOUNT.BANKID = BANK.BANKID       
				LEFT  JOIN    MONTHLYTYPE ON ACCOUNT.MONTHLYTYPEID = MONTHLYTYPE.MONTHLYTYPEID      
				LEFT  JOIN    FAMILY ON FAMILY.FAMILYID = ACCOUNT.FAMILYID      
				WHERE     (ACCOUNT.ACCOUNTTYPEID = '+CAST(@ACCOUNTTYPEID AS VARCHAR(2))+' OR '+CAST(@ACCOUNTTYPEID AS VARCHAR(2))+'=0)'      
      
	SET @SQL=@SQL+@WHERE+' ORDER BY LASTNAME '      
	EXEC SP_EXECUTESQL @SQL
GO

COMMIT
GO