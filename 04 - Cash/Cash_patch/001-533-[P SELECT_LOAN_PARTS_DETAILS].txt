BEGIN TRANSACTION
GO
IF EXISTS ( SELECT 1
            FROM   sysobjects 
            WHERE  id = object_id(N'[dbo].[SELECT_LOAN_PARTS_DETAILS]')
                   and OBJECTPROPERTY(id, N'IsProcedure') = 1 )
BEGIN
    DROP PROCEDURE [dbo].[SELECT_LOAN_PARTS_DETAILS]
END
GO

CREATE  procedure [dbo].[SELECT_LOAN_PARTS_DETAILS]    
	@LOANID INT,
	@DATEFROM CHAR(10),
	@DATETO  CHAR(10),
	@PAID TINYINT    
AS    
	SELECT     ACCOUNTTITLE, 
			   ACCOUNTNO, 
			   PAYMENT.DATE PAYDATE,
			   LOANNO,
			   dbo.LoaN.Amount LoanAmount,    
			  (SELECT SUM(AMOUNT)+SUM(INTERESTAMOUNT)
					FROM FORCEPAYMENT   
					WHERE  PARENTID=LOAN.LOANID 
						AND FORCETYPEID=1 
						AND ORDERNO>FP.ORDERNO) REMAINAMOUNT,    
			  (FP.AMOUNT+INTERESTAMOUNT)AS AMOUNT, MATUREDATE, ORDERNO, INTERESTAMOUNT    
		FROM FORCEPAYMENT FP    
			INNER JOIN  LOAN ON FP.PARENTID = LOAN.LOANID    
			INNER JOIN  ACCOUNT ON LOAN.ACCOUNTID = ACCOUNT.ACCOUNTID    
			LEFT  JOIN  PAYMENT ON FP.PAYMENTID = PAYMENT.PAYMENTID    
		WHERE     (PARENTID = @LOANID) 
			AND (FORCETYPEID = 1)    
			AND MATUREDATE BETWEEN @DATEFROM AND @DATETO    
			AND (PAID=@PAID OR @PAID=2)
GO

COMMIT
GO