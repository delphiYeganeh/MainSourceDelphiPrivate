BEGIN TRANSACTION
GO
IF EXISTS ( SELECT 1
            FROM   sysobjects 
            WHERE  id = object_id(N'[dbo].[REPORT_LOANPOINT]')
                   and OBJECTPROPERTY(id, N'IsProcedure') = 1 )
BEGIN
    DROP PROCEDURE [dbo].[REPORT_LOANPOINT]
END
GO

CREATE  procedure [dbo].[REPORT_LOANPOINT]    
@TODAY CHAR(10),@AccountNO varchar(20),@AccountTitle nvarchar(100)      
AS      
DECLARE @LASTLOANDATE   CHAR(10),@ACCOUNTDATE CHAR(10),@REQUESTDATE CHAR(10),@POINT INT      
DECLARE @PARTDELAYPOINT INT , @MONTHLYDELAYPOINT INT, @LASTLOANPOINT INT,@LOANREQUESTPOINT INT,@BALANCEPOINT INT      
DECLARE @LoanPointSetting  INT,@MonthPointSetting INT
DECLARE @GroupPoint INT
      
SELECT @BALANCEPOINT=VALUE      
FROM SETTING      
WHERE  VARIABLENAME='BALANCEPOINT' AND USERID=-1      
      
SELECT @PARTDELAYPOINT=VALUE      
FROM SETTING      
WHERE  VARIABLENAME='PARTDELAYPOINT' AND USERID=-1      
      
SELECT @MONTHLYDELAYPOINT=VALUE      
FROM SETTING      
WHERE  VARIABLENAME='MONTHLYDELAYPOINT' AND USERID=-1      
      
SELECT @LASTLOANPOINT=VALUE      
FROM SETTING      
WHERE  VARIABLENAME='LASTLOANPOINT' AND USERID=-1      
      
SELECT @LOANREQUESTPOINT=VALUE      
FROM SETTING      
WHERE  VARIABLENAME='LOANREQUESTPOINT' AND USERID=-1      

SELECT @GroupPoint=isnull(VALUE, 0) 
FROM Setting 
WHERE VariableName='GroupPoint' AND UserID=-1
set @GroupPoint= ISNULL(@GroupPoint, 0)
      
      
SELECT      
ACCOUNTID,ACCOUNTNO,ACCOUNTTITLE,ACCOUNTDATE,      
(SELECT TOP 1 LOANDATE FROM LOAN WHERE ACCOUNTID=ACC.ACCOUNTID ORDER BY LOANDATE DESC ) LASTLOANDATE,      
(SELECT TOP 1 LOANID FROM LOAN WHERE ACCOUNTID=ACC.ACCOUNTID ORDER BY LOANDATE DESC ) LASTLOANID,      
(SELECT  MAX(REQUESTDATE) FROM DBO.LOANREQUEST WHERE ACCOUNTID=ACC.ACCOUNTID  AND EXPIRED=0)  REQUESTDATE,      
CAST(0 AS INT) PARTDELAY,      
CAST(0 AS INT) MONTHLYDELAY,      
CAST(0 AS INT) AS AVGPOINT,      
CAST(0 AS INT) AS POINT,      
CAST(0 AS TINYINT) NUMBEROFPART,      
CAST(0 AS INT) LASTLOANAMOUNT,      
CAST('' AS VARCHAR(10)) LASTLOANNO,      
CAST(0 AS INT) REMAINOFLOAN,
CAST(0 AS INT) GroupPaymentPoint--Amin Added 
INTO #M      
FROM ACCOUNT ACC      
WHERE ACCOUNTTYPEID=1 AND IsActive= 1   
      
UPDATE #M      
SET LASTLOANDATE=ISNULL(LASTLOANDATE,ACCOUNTDATE),      
 LASTLOANID=ISNULL(LASTLOANID,0)  
 

 UPDATE #M      
SET NUMBEROFPART=(SELECT COUNT(1) FROM FORCEPAYMENT WHERE  PARENTID=#M.LASTLOANID AND FORCETYPEID=1 ) ,      
REMAINOFLOAN=(SELECT SUM(AMOUNT) FROM FORCEPAYMENT WHERE FORCETYPEID=1 AND PARENTID=#M.LASTLOANID AND PAID=0)      
      
UPDATE #M      
SET LASTLOANAMOUNT=AMOUNT,LASTLOANNO=LOANNO      
FROM #M INNER JOIN LOAN ON LOAN.LOANID=#M.LASTLOANID     
      
      
SET @LoanPointSetting  =(SELECT [VALUE] FROM SETTING WHERE VARIABLENAME ='LoanPoint')
SET @MonthPointSetting =(SELECT [VALUE] FROM SETTING WHERE VARIABLENAME ='MonthPoint')

IF @LoanPointSetting=0/*تاخير بر اساس آخرين وام */
BEGIN
		UPDATE #M       
		/* Commented by Amin 91/06/05 SET PARTDELAY= DBO.LOANDELAY(LASTLOANID,@TODAY)  تاخير بر اساس آخرين وام      */
		SET PARTDELAY=Floor((@PARTDELAYPOINT*DBO.LOANDELAY(LASTLOANID,@TODAY)*(Convert(float, LastLoanAmount)*0.2))/100000)
END
   
IF @LoanPointSetting=1 /* تاخير بر اساس افتتاح حساب*/
BEGIN
		UPDATE #M       
		/* Commented by Amin 91/06/05 SET PARTDELAY=dbo.LoanDelay_ByAccountId(ACCOUNTID,@TODAY)   تاخير بر اساس افتتاح حساب*/
		SET PARTDELAY=Floor((@PARTDELAYPOINT*dbo.LoanDelay_ByAccountId(ACCOUNTID,@TODAY)*
			(Convert(float, LastLoanAmount)*0.2))/100000) -- Added by Amin 91/06/05
END
   
IF @MonthPointSetting=0 /*تاخير بر اساس آخرين وام */
BEGIN
	UPDATE #M
		/* Commented by Amin 91/06/05 SET MONTHLYDELAY=DBO.MONTHLYDELAY(ACCOUNTID,ISNULL(LASTLOANDATE,ACCOUNTDATE),@TODAY) تاخير بر اساس آخرين وام    */
		set MONTHLYDELAY=Floor(@MONTHLYDELAYPOINT*DBO.MONTHLYDELAY(ACCOUNTID,ISNULL(LASTLOANDATE,ACCOUNTDATE),@TODAY))
END
IF @MonthPointSetting=1 /* تاخير بر اساس افتتاح حساب*/
BEGIN
		UPDATE #M       
		/* Commented by Amin 91/06/05 SET MONTHLYDELAY=DBO.MONTHLYDELAY(ACCOUNTID,ISNULL(REQUESTDATE,ACCOUNTDATE),@TODAY)  تاخير بر اساس افتتاح حساب     */
		set MONTHLYDELAY=Floor(@MONTHLYDELAYPOINT*DBO.MONTHLYDELAY(ACCOUNTID,ISNULL(REQUESTDATE,ACCOUNTDATE),@TODAY))
END

UPDATE #M 
SET GroupPaymentPoint= dbo.GroupPaymentPoint(LastLoanID, ISNULL(REQUESTDATE,ACCOUNTDATE),@TODAY)

UPDATE #M       
SET AVGPOINT= DBO.SUMBALANCE(ACCOUNTID,LASTLOANDATE,@TODAY)/304000/*,      
--تعداد روز ماه ضرب در 10000 ريال      
    PARTDELAY=dbo.LoanDelay_ByAccountId(ACCOUNTID,@TODAY),-- تاخير بر اساس افتتاح حساب
    -- DBO.LOANDELAY(LASTLOANID,@TODAY), --تاخير بر اساس آخرين وام      
    MONTHLYDELAY=DBO.MONTHLYDELAY(ACCOUNTID,ISNULL(REQUESTDATE,ACCOUNTDATE),@TODAY) --تاخير بر اساس افتتاح حساب     
    -- MONTHLYDELAY=DBO.MONTHLYDELAY(ACCOUNTID,ISNULL(REQUESTDATE,ACCOUNTDATE),@TODAY) --تاخير بر اساس آخرين وام     
 */          
      
UPDATE #M      
SET POINT=-MONTHLYDELAY - PARTDELAY
+@BALANCEPOINT*AVGPOINT      
+@LASTLOANPOINT*ISNULL(DBO.SHAMSIDATEDIFF(LASTLOANDATE,@TODAY),0)      
+@LOANREQUESTPOINT*ISNULL(DBO.SHAMSIDATEDIFF(ISNULL(REQUESTDATE,@TODAY),@TODAY),0) 
+@GroupPoint*GroupPaymentPoint
      
SELECT *      
FROM #M     
Where  (AccountNO=@AccountNO OR @AccountNO='0') AND  (AccountTitle=@AccountTitle OR @AccountTitle='0' )    
ORDER BY POINT DESC

GO

COMMIT
GO