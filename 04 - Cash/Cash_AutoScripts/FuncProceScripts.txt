[SECTION_MAX_NO]=3

[BEGIN_S_NO]=1

CREATE OR ALTER FUNCTION [dbo].[ShamsiLastYearDate]
(
	@DATE datetime
)
RETURNS Varchar(10)
AS
BEGIN
	DECLARE @MDate VARCHAR(10)  , 
	        @dateTo VARCHAR(10)  , 
	        @Year char(4)   
	
	SET @MDate = CONVERT(VARCHAR, DATEPART(yyyy, @DATE)) 
		   + '/' + RIGHT('00' +CONVERT(VARCHAR, DATEPART(mm, @DATE)),2) 
		   + '/' + RIGHT('00' +CONVERT(VARCHAR, DATEPART(dd, @DATE)),2)
		  
		  
	SET @Year =  SUBSTRING(dbo.MiladiToShamsi(@MDate),1,4)  
	 
	IF @Year IN ('1399','1403','1408','1412','1465','1441','1445','1494','1498','1503','1507') 
	  SET @dateTo  =  @Year +'/12/30'
	ELSE  SET @dateTo  =  @Year +'/12/29' 	
		   
	RETURN @dateTo
END

[END_S_NO]

[BEGIN_S_NO]=2

alter PROCEDURE [dbo].[SELECT_ACCOUNT_DETAILS] @ACCOUNTID INT        
AS    
Declare @EndDate Nchar(10) = '1403/12/29'
--parsa
SET @EndDate  =  [dbo].[ShamsiLastYearDate](GETDATE())  
--parsa

SELECT  ACCOUNTID,ACCOUNTNO,ACCOUNTDATE,CONTACT.PERSONALNO,CONTACT.SIGN,CONTACT.PICTURE,        
            ISNULL(CASE WHEN ACCOUNT.ACCOUNTTYPEID IN (1,3 ,5,6) THEN ISNULL(FIRSTNAME+' ','')+LASTNAME+' ش.حساب: '+ ACCOUNTNO  ELSE ACCOUNTTITLE+' ش.حساب: '+ ACCOUNTNO END,ACCOUNTTITLE+' ش.حساب: '+ ACCOUNTNO) ACCOUNTTITLE,        
            CASE WHEN DBO.BALANCE(@ACCOUNTID,@EndDate)<0 THEN 'بدهکار'        
                   WHEN DBO.BALANCE(@ACCOUNTID,@EndDate)>0 THEN 'بستانکار'        
                   ELSE 'تسويه' END DEBITSTATUS,        
            (SELECT COUNT(1) FROM FORCEPAYMENT  INNER JOIN LOAN ON LOAN.LOANID=FORCEPAYMENT.PARENTID WHERE   FORCETYPEID=1 AND LOAN.ACCOUNTID=@ACCOUNTID AND ISNULL(FORCEPAYMENT.PAYMENTID,0)=0) NUMBEROFNOTPAIDPART ,        
     DBO.EXIST(@ACCOUNTID,@EndDate) EXIST,        
     DBO.TOTALEXIST(@ACCOUNTID,@EndDate, 0) TOTALEXIST,        
     DBO.BALANCE_BYPAYTYPEID(@ACCOUNTID,1,@EndDate) PAYBALANCE,        
     DBO.BALANCE_BYPAYTYPEID(@ACCOUNTID,2,@EndDate) MONTHLYBALANCE,  
     CASE SIGN(DBO.BALANCE(ACCOUNT.ACCOUNTID,'9')) WHEN 1 THEN 'بستانکار' WHEN -1 THEN  'بدهكار' ELSE 'تسويه' END DEBITSTATUSTITLE ,  
     CASE SIGN(DBO.BALANCE_BYPAYTYPEID(@ACCOUNTID,1,@EndDate)) WHEN 1 THEN 'بستانکار' WHEN -1 THEN  'بدهكار' ELSE 'تسويه' END PAYBALANCETitle ,  
     CASE SIGN(DBO.BALANCE_BYPAYTYPEID(@ACCOUNTID,2,@EndDate)) WHEN 1 THEN 'بستانکار' WHEN -1 THEN  'بدهكار' ELSE 'تسويه' END MONTHLYBALANCETitle ,  
     CASE SIGN(DBO.EXIST(@ACCOUNTID,@EndDate)) WHEN 1 THEN 'بستانکار' WHEN -1 THEN  'بدهكار' ELSE 'تسويه' END EXISTTitle ,
     CASE SIGN(DBO.TOTALEXIST(@ACCOUNTID,@EndDate, 0)) WHEN 1 THEN 'بستانکار' WHEN -1 THEN  'بدهكار' ELSE 'تسويه' END TOTALEXISTTitle,  

     ACCOUNT.CONTACTID ,dbo.GetPhoneNumber(ACCOUNT.CONTACTID) Phone
            
    FROM     ACCOUNT            
             LEFT JOIN MONTHLYTYPE ON ACCOUNT.MONTHLYTYPEID=MONTHLYTYPE.MONTHLYTYPEID        
             LEFT JOIN ACCOUNTTYPE ON ACCOUNT.ACCOUNTTYPEID=ACCOUNTTYPE.ACCOUNTTYPEID        
             LEFT JOIN CONTACT     ON ACCOUNT.CONTACTID=CONTACT.CONTACTID        
    WHERE ACCOUNTID=@ACCOUNTID  
		

[END_S_NO]

[BEGIN_S_NO]=3

alter PROCEDURE [dbo].[REPORT_CASHACCOUNT]
	@WHERE VARCHAR(1000), 
	@ISLOAN INT = 0
AS
	DECLARE @SQL NVARCHAR(4000)  
	--parsa 
	DECLARE @dateFrom char(10)  , @dateTo char(10)   
	SET @dateFrom = '1360/01/01'  
	SET @dateTo  =  '1403/12/29'    
	SET @dateTo =  [dbo].[ShamsiLastYearDate](GETDATE())  
	--parsa
	
	SET @WHERE = ISNULL(LTRIM(@WHERE), '')                
	IF @WHERE <> ''
	    SET @WHERE = ' AND  '+@WHERE                
	
	IF @ISLOAN <> 7
	    SET @SQL = 
	        'SELECT  BANK.BANKTITLE, ACCOUNT.ACCOUNTID, ACCOUNT.ACCOUNTTITLE, ACCOUNTNO, ACCOUNTDATE, ACCOUNT.ISACTIVE,ACCOUNT.ACCOUNTTYPEID,ACCOUNTTYPETITLE, 
						   case When  AccountId=1  then IsNull(DBO.PUREBALANCE(ACCOUNT.ACCOUNTID,'''+@dateTo+'''),0)  
							    When  AccountId=4  then  DBO.F_Soodvam ('''+@dateFrom+''' ,'''+@dateTo+''') 
							    ELSE DBO.PUREBALANCE(ACCOUNT.ACCOUNTID,'''+@dateTo+''') End as  BALANCE, 
					  CASE SIGN(DBO.PUREBALANCE(ACCOUNT.ACCOUNTID,''9'')) WHEN 1 THEN ''بستانکار '' WHEN -1 THEN  ''بدهکار '' ELSE ''تسويه '' END DEBITSTATUSTITLE 
				FROM       ACCOUNT     WITH (NOLOCK)               
				LEFT  JOIN BANK        WITH (NOLOCK)     ON ACCOUNT.BANKID = BANK.BANKID 
				INNER JOIN ACCOUNTTYPE WITH (NOLOCK) ON ACCOUNT.ACCOUNTTYPEID=ACCOUNTTYPE.ACCOUNTTYPEID
				WHERE ACCOUNT.ISACTIVE=1 '
	
	IF @ISLOAN=7
	    SET @SQL = 
	        ' SELECT BANK.BANKTITLE, ACCOUNT.ACCOUNTID,ACCOUNT.ACCOUNTTITLE,ACCOUNT.ACCOUNTNO, 
						  ACCOUNT.ACCOUNTDATE,ACCOUNT.ISACTIVE,LOANTYPE.LOANTYPEID AS ACCOUNTTYPEID,LOANTYPE.LOANTYPETITLE AS ACCOUNTTYPETITLE, 
						  case When  AccountId=1  then IsNull(DBO.PUREBALANCE(ACCOUNT.ACCOUNTID,'''+@dateTo+'''),0) + IsNull((SELECT SUM(Amount) FROM   Payment  WHERE  (PayTypeID = 7)),0) 
							   When  AccountId=4  then  DBO.F_Soodvam ('''+@dateFrom+''' ,'''+@dateTo+''')  
							   ELSE DBO.PUREBALANCE(ACCOUNT.ACCOUNTID,'''+@dateTo+''') End as  BALANCE, 
						  CASE SIGN(DBO.PUREBALANCE(ACCOUNT.ACCOUNTID,''9'')) WHEN 1 THEN ''بستانکار '' WHEN -1 THEN  ''بدهکار '' ELSE ''تسويه '' END DEBITSTATUSTITLE 
	          FROM              LOAN     WITH (NOLOCK)
				INNER JOIN      ACCOUNT  WITH (NOLOCK) ON LOAN.ACCOUNTID = ACCOUNT.ACCOUNTID 
				LEFT OUTER JOIN LOANTYPE WITH (NOLOCK) ON LOAN.LOANTYPEID = LOANTYPE.LOANTYPEID LEFT 
				OUTER JOIN      BANK     WITH (NOLOCK) ON ACCOUNT.BANKID = BANK.BANKID              
			WHERE ACCOUNT.ISACTIVE=1 '                
	
	SET @SQL = @SQL+@WHERE+' ORDER BY ACCOUNTTITLE '                
	EXEC SP_EXECUTESQL @SQL  



[END_S_NO]



