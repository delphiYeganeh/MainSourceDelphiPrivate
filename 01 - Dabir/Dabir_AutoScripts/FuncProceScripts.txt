[SECTION_MAX_NO]=15

[BEGIN_S_NO]=1


ALTER  procedure [dbo].[Sp_GetAllFromOrganizations](@isInnerOrg BIT,@groupId INT)
AS

--IF(@groupId=0)
--   SELECT distinct  fo.ID, ISNULL(fo.Title,'') Title, fo.ParentID, fo.Phone, fo.Fax, fo.Email, 
--                    fo.ResponsibleStaffer,fo.IsActive, fo.PreCode, fo.IsInnerOrg, fo.Code, fo.UniqueID 
--   FROM FromOrganizations fo INNER JOIN ChartWorkGroupDetails cwgd
--   ON fo.ID=cwgd.OrgID
--   WHERE fo.IsInnerOrg=@isInnerOrg AND cwgd.AccessForErja=1

---- small RESULT
	--SELECT  distinct  fo.ID, ISNULL(fo.Title,'') Title, fo.ParentID, fo.Phone, fo.Fax, fo.Email, 
 --                   fo.ResponsibleStaffer,fo.IsActive, fo.PreCode, fo.IsInnerOrg, fo.Code, fo.UniqueID 
	--FROM FromOrganizations fo INNER JOIN ChartWorkGroupDetails t1
 --   ON fo.ID=t1.OrgID
 --    inner join users t2 on t2.id=@groupId and (t1.OrgID=t2.FromOrgID or t1.OrgID=t2.FiveOrgID or t1.OrgID=t2.FourOrgID or t1.OrgID=t2.TreeOrgID or t1.OrgID=t2.SecondOrgID)
	--WHERE fo.IsInnerOrg=1 AND t1.AccessForErja=1
SELECT  distinct  
	fo.ID, 
	ISNULL(fo.Title,'')+'-'+ResponsibleStaffer Title, 
	fo.ParentID, 
	fo.Phone, 
	fo.Fax, 
	fo.Email, 
    fo.ResponsibleStaffer,
	fo.IsActive, 
	fo.PreCode, 
	fo.IsInnerOrg, 
	fo.Code, 
	fo.UniqueID 
from FromOrganizations fo 
inner join ChartWorkGroupDetails t1 
on t1.OrgID=fo.id 
and AccessForErja=1 
/*
and t1.GroupID in (
					SELECT  distinct  t1.GroupID
					FROM FromOrganizations fo 
					INNER JOIN ChartWorkGroupDetails t1
					ON fo.GroupID=t1.GroupID
					 inner join users t2 
					 on t2.id=@groupId  
					 and (   fo.id=t2.FromOrgID 
					      or fo.id=t2.FiveOrgID 
						  or fo.id=t2.FourOrgID 
						  or fo.id=t2.TreeOrgID 
						  or fo.id=t2.SecondOrgID
						 )	 
                   )
*/
WHERE fo.IsInnerOrg=1 
AND t1.AccessForErja=1
union 
SELECT  distinct  
	fo.ID, 
	ISNULL(fo.Title,'')+'-'+ResponsibleStaffer Title, 
	fo.ParentID, 
	fo.Phone, 
	fo.Fax, 
	fo.Email, 
	fo.ResponsibleStaffer,
	fo.IsActive, 
	fo.PreCode, 
	fo.IsInnerOrg, 
	fo.Code, 
	fo.UniqueID 
from FromOrganizations fo 
where fo.Title IN( N'دبيرخانه هاي ديگر',N'دبيرخانه  هاي ديگر',N'دبیرخانه  های دیگر')
or fo.ParentID  = (select top 1 id 
                   from FromOrganizations 
                     where Title IN( N'دبيرخانه هاي ديگر',N'دبيرخانه  هاي ديگر',N'دبیرخانه  های دیگر')
			       )


[END_S_NO]


[BEGIN_S_NO]=2

ALTER  procedure [dbo].[web_insert_ReceivedLetter]
	(@Indicator 	[int] output,
	 @LetterID 	[int] output,
	 @RecommiteId int output,
	 @ToOrgTitle 	nvarchar(100),
	 @Signerid 	[nvarchar](50),
	 @ClassificationID 	[tinyint],
	 @UrgencyID 	[smallint],
	 @Memo 	[nvarchar](500),
	 @UserID 	[int],
	 @RetroactionNo 	[nvarchar](50),
	 @UserMemo 	[nvarchar](255),
	 @FollowLetterNo 	[nvarchar](50),
	 @ToStaffer 	[nvarchar](50),
	 @fromstaffer 	[nvarchar](50),
	 @IncommingNO 	[nvarchar](50),
	 @Incommingdate 	[nvarchar](10),
	 @CenterNo 	[nvarchar](50),
	 @CenterDate 	[char](10),
	 @FromOrgID 	[int],
	 @NumberOfPage 	[tinyint],
	 @ReceiveTypeID 	[tinyint],
	@SubjectID INT,
	@SecretariatID int)
AS 
declare @ToOrgID int,@IndicatorID int ,@UserFromOrgID 	int,  @MYear int, 
        @RegistrationDate 	[char](10),	@RegistrationTime 	[varchar](5),@responsible NVARCHAR(50),@title NVARCHAR(100)
select  @ToOrgID=convert(int,@toorgtitle)
SET @fromstaffer = REPLACE(LEFT(@fromstaffer,CHARINDEX('-',@fromstaffer)),'-','')
SET @ToStaffer   = REPLACE(LEFT(@ToStaffer,CHARINDEX('-',@ToStaffer)),'-','')
       --parsa
       SET @ToOrgID   = @FromOrgID 
       SET @FromOrgID = convert(int,@toorgtitle)
      
	  SET @ToStaffer = ISNULL(( SELECT ResponsibleStaffer FROM [dbo].[FromOrganizations] WHERE ID = @ToOrgID),'')
	  SET @fromstaffer = ISNULL(( SELECT ResponsibleStaffer FROM [dbo].[FromOrganizations] WHERE ID = @FromOrgID),'')
	  --parsa
SET @title=@toorgtitle
set @toorgtitle=REPLACE(LEFT(@title,CHARINDEX('-',@title)),'-','') 

if not exists (select * from fromorganizations where replace(title,' ','')=replace(@toorgtitle,' ',''))
BEGIN
	SET @responsible=REPLACE(RIGHT(@title,LEN(@title)-CHARINDEX('-',@title)),'-','')
    IF(@toorgtitle=@responsible)
        set @responsible=''
	insert into Fromorganizations(Title,ResponsibleStaffer,parentid,isinnerorg) values(@toorgtitle,@responsible,3,0)
END

 

select @RegistrationTime=case when datepart(hour,getdate())<10 then '0'+convert(char(1),datepart(hour,getdate()))
   else convert(char(2),datepart(hour,getdate())) end +':' + convert(char(2),datepart(minute,getdate()))

set @RegistrationDate=dbo.shamsi(getdate())

set @myear=cast (substring(@RegistrationDate,1,4) as int)

if(@SecretariatID=0)
begin
SELECT     @SecretariatID=DefualtSecretariatID, @UserFromOrgID=FromOrgID
FROM         Users
where id=@userid
end

set @IndicatorID=dbo.newIndicatorid(1,1,@myear,@SecretariatID)

INSERT INTO [Letter] 
	 ( [IndicatorID],	 [MYear],	 [SecretariatID],	 [Letter_Type],	 [letterformat],	 [FromOrgID],	 [ToOrgID],
	 [Signerid],	 [ClassificationID],	 [UrgencyID],	 [Memo],	 [UserID],	 [RetroactionNo],	 [UserMemo],
	 [RegistrationDate],	 [RegistrationTime],	 [FollowLetterNo],	 [ToStaffer],	 [fromstaffer],	 [Finalized],IncommingNO ,
     Incommingdate,CenterNo,CenterDate,NumberOfPage ,ReceiveTypeID, SubjectID) 
 
VALUES 
	( 
	 @IndicatorID,	 @MYear,	 @SecretariatID,
	 1,--Letter_Type
	 1,--letterformat
	 @FromOrgID,
	 @ToOrgID,
	 @Signerid,
	 @ClassificationID,
	 @UrgencyID,
	 @Memo,
	 @UserID,
	 @RetroactionNo,
	 @UserMemo,
	 @RegistrationDate,
	 @RegistrationTime,
	 @FollowLetterNo,
	 @ToStaffer,
	 @fromstaffer,
	 1, --Finalized
      @IncommingNO , @Incommingdate,@CenterNo,@CenterDate ,@NumberOfPage ,@ReceiveTypeID, @SubjectID)

select @letterid=SCOPE_IDENTITY()

exec web_insert_NewReCommite @LetterID,3,0,@FromOrgID,'ثبت نامه',@registrationdate,@UserID,0,0,0,@RecommiteId output

select @Indicator = @IndicatorID

select @RecommiteId

[END_S_NO]


[BEGIN_S_NO]=3



ALTER  procedure [dbo].[Get_All_Letter]  
    @SecretariatID int,                  
    @Myear int,                  
    @Letter_Type int,                  
    @LetterFormat int,                  
    @Where nvarchar(4000),                  
    @Top int,                  
    @ArchiveFolderID int,                  
    @ArchiveStatus tinyint ,-- 0 ,1 and 2(= all)               
    @UserID int 
	
    As 
   
     
    IF ISNULL(LTRIM(RTRIM(@where)),'')=''
    BEGIN
		DECLARE @DO_ CHAR(10) SET @DO_ = dbo.ATF_PEY_SETTING ('ATF-PEY')
    END

    DECLARE @SqlCommand nvarchar(max),@InnerNo NVARCHAR(500)
                                     
    IF OBJECT_ID('tempdb..#s') IS NOT NULL 
		DROP TABLE #s   
                
    Set @InnerNo=dbo.InnerNoFormat('Sender','Deliver',@SecretariatID)     

    IF OBJECT_ID('tempdb..#s') IS NOT NULL 
		DROP TABLE #s
    
	CREATE TABLE #s
    (
    PEY2 NVARCHAR(200),
    ATF2 NVARCHAR(200),
    PEY NVARCHAR(100),
    ATF NVARCHAR(100),
    LetterID INT,   
    CenterNo NVARCHAR(50),                                          
    IndicatorID INT,
    MYear INT,
    SecretariatID INT,
    Letter_Type INT,
    letterformat INT,
    IncommingNO NVARCHAR(50),                                       
    FromOrgID INT,  
    IncommingDate NVARCHAR(10),
    ToOrgID INT,    
    UrgencyID INT,  
    Memo NVARCHAR(4000),                                                                                                                                                                                                                                                           
    RetroactionNo NVARCHAR(1000),                                     
    RegistrationDate CHAR(10),
    FollowLetterNo NVARCHAR(1000),                                    
    ToStaffer NVARCHAR(50),                                         
    SentLetterID INT,
    TemplateID  INT,
    UserMemo  NVARCHAR(1000),                                                                                                                                                                                                                                                      
    DeadLineDate CHAR(10),
    SenderTitle NVARCHAR(100),                                                                                         
    DeliverTitle NVARCHAR(100),                                                                                        
    has_Page BIT,
    has_WordPage BIT,
    has_file BIT,
    SubjectID INT,  
    LetterTypeTitle NVARCHAR(50),                                    
    LetterRecommites NVARCHAR(4000),                                                                                                                                                                                                                                                
    sendstatusTitle  NVARCHAR(100),                                                                                    
    InnerNo VARCHAR(500),
    InnerNoForWord VARCHAR(500),
    Archived BIT,
    ActionTypeTitle NVARCHAR(50),                                   
    SignerID NVARCHAR(200),                                           
    SignerTitle NVARCHAR(100),                                                                                         
    ReceiveTypeID INT,
    ClassificationID INT,
    ArchivePlace NVARCHAR(500),
    SubjectDescription NVARCHAR(4000),
    has_sign BIT ,   
    HasLetterForms BIT,
    FolderID INT,
    ArchivecenterID INT,
	SecretariatTitle  NVARCHAR(100),
	EmailFromDateTime Nvarchar(20),
	EmailFrom nvarchar(1000),
	EmailSubject nvarchar(2000),
	IsNetWork bit
    )

	IF @ArchiveStatus = 0
	BEGIN
		IF isnull(ltrim(rtrim(@where)),'')=''
		BEGIN
			INSERT INTO #s
			(
				PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,
				ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,
				DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,
				ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			)
			SELECT DISTINCT top (@Top)
					PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,              
					Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,'-' AS RetroactionNo,Letter.RegistrationDate,'-' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,                  
					Deliver.Title AS DeliverTitle,
					case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page, 
					case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention = 3) THEN 1 ELSE 0 END AS has_WordPage, 
					case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention > 3) OR
							(SELECT count( LetterDataID) FROM LetterData WHERE LetterID=Letter.LetterID and extention=3)>1 THEN 1 ELSE 0 END AS has_File,
					 Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,
					 at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,
					(SELECT top (1)  a.Title FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,
					Letter.SubjectDescription,dbo.has_sign(Letter.letterID) as has_sign ,dbo.HasLetterForms(Letter.Letterid) HasLetterForms,
					(SELECT top (1)  a.FolderID 
					FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b 
					ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS FolderID,
					Secretariats.SecTitle as SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			FROM Letter
			INNER JOIN sendstatus AS ss on ss.sendstatusID=Letter.sendstatusID
			INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID
			LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID
			LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID
			LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type
			LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID
			WHERE Letter.Finalized=1 AND Letter.Archived=0 AND
				  ((Letter_Type=@Letter_Type) OR (@Letter_Type=0)) AND
				  ((Secretariatid=@SecretariatID) OR (@SecretariatID<=0)) AND
				  ((myear=@Myear) OR (@Myear<=0)) AND
				  ((Letter.LetterFormat=@LetterFormat) OR (@LetterFormat<=0))/*AND
				  (letter.LetterID>=(SELECT ISNULL(MAX(letterID)-10000,0) FROM Letter))	*/
			order by letter.letterid desc
					
		END
		ELSE
		BEGIN
			Set @sqlCommand='DECLARE @DO_ CHAR(10) SET @DO_ = dbo.ATF_PEY_SETTING (''ATF-PEY'')'+
			' INSERT INTO #s'+
			'('+
				'PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,'+
				'ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,'+
				'DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,'+
				'ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			 ' )'+
			' SELECT DISTINCT top ('+CAST(@Top as varchar)+')' + 
					' PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,'+              
					'Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,''-'' AS RetroactionNo,Letter.RegistrationDate,''-'' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,'+                  
					'Deliver.Title AS DeliverTitle,'+
					' case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page,'+
					' case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention = 3) THEN 1 ELSE 0 END AS has_WordPage, '+
					' case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention > 3) OR '+
							' (SELECT count( LetterDataID) FROM LetterData WHERE LetterID=Letter.LetterID and extention=3)>1 THEN 1 ELSE 0 END AS has_File,'+
					 'Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,'+
					 'at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,'+
					' (SELECT top (1)  a.Title FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,'+
					'Letter.SubjectDescription,dbo.has_sign(Letter.letterID) as has_sign ,
					dbo.HasLetterForms(Letter.Letterid) HasLetterForms,'+
					' (SELECT top (1)  a.FolderID FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b 
					ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS FolderID,Secretariats.SecTitle SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			' FROM Letter 
			INNER JOIN sendstatus AS ss on ss.sendstatusID=Letter.sendstatusID 
			INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID'+
			' LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID'+
			' LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type'+
			' LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID'+
			' WHERE Letter.Finalized=1 AND Letter.Archived=0 AND '+
				  '((Letter_Type='+CAST(@Letter_Type AS VARCHAR(5))+') OR ('+CAST(@Letter_Type AS VARCHAR(5))+'=0)) AND '+
				  '((Secretariatid='+CAST(@SecretariatID AS VARCHAR(5))+') OR ('+CAST(@SecretariatID AS VARCHAR(5))+'<=0)) AND '+
				  '((myear='+CAST(@Myear AS VARCHAR(5))+') OR ('+CAST(@Myear AS VARCHAR(5))+'<=0)) AND '+
				  '((Letter.LetterFormat='+CAST(@LetterFormat AS VARCHAR(5))+') OR ('+CAST(@LetterFormat AS VARCHAR(55))+'<=0))'+
				  ' And ' + @where + ' order by letter.letterid desc'
			
			Exec Sp_ExecuteSql   @sqlCommand				  
		END
		
		IF @ArchiveFolderID>0
		BEGIN
			DELETE FROM #s WHERE ISNULL(FolderID,0)!=@ArchiveFolderID
		END

	END
	ELSE
	IF @ArchiveStatus=1
	BEGIN
		IF isnull(ltrim(rtrim(@where)),'')=''
		BEGIN
			INSERT INTO #s
			(
				PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,
				ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,
				DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,
				ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			)
			SELECT DISTINCT top (@Top)
					PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,              
					Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,'-' AS RetroactionNo,Letter.RegistrationDate,'-' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,                  
					Deliver.Title AS DeliverTitle,
					case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page, 
					case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention = 3) THEN 1 ELSE 0 END AS has_WordPage, 
					case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention > 3) OR
							(SELECT count( LetterDataID) FROM LetterData WHERE LetterID=Letter.LetterID and extention=3)>1 THEN 1 ELSE 0 END AS has_File,
					 Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,
					 at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,
					(SELECT top (1)  a.Title FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,
					Letter.SubjectDescription,dbo.has_sign(Letter.letterID) as has_sign ,dbo.HasLetterForms(Letter.Letterid) HasLetterForms,
					(SELECT top (1)  a.FolderID FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID 
					AND b.LetterID=Letter.LetterID) AS FolderID,Secretariats.SecTitle as SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			FROM Letter
			INNER JOIN sendstatus AS ss on ss.sendstatusID=Letter.sendstatusID
			INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID
			LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID
			LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID
			LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type
			LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID
			WHERE Letter.Finalized=1 AND Letter.Archived=1 AND
				  ((Letter_Type=@Letter_Type) OR (@Letter_Type=0)) AND
				  ((Secretariatid=@SecretariatID) OR (@SecretariatID<=0)) AND
				  ((myear=@Myear) OR (@Myear<=0)) AND
				  ((Letter.LetterFormat=@LetterFormat) OR (@LetterFormat<=0))/*AND
				  (letter.LetterID>=(SELECT ISNULL(MAX(letterID)-10000,0) FROM Letter))*/
			order by letter.letterid desc
		END
		ELSE
		BEGIN
			Set @sqlCommand='DECLARE @DO_ CHAR(10) SET @DO_ = dbo.ATF_PEY_SETTING (''ATF-PEY'')'+
			' INSERT INTO #s'+
			'('+
				'PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,'+
				'ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,'+
				'DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,'+
				'ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			')'+
			' SELECT DISTINCT top ('+CAST(@Top as varchar)+')' + 
					' PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,'+
					' Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,''-'' AS RetroactionNo,Letter.RegistrationDate,''-'' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,'+
					'Deliver.Title AS DeliverTitle,'+
					' case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page,'+
					' case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention = 3) THEN 1 ELSE 0 END AS has_WordPage, '+
					' case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention > 3) OR '+
							' (SELECT count( LetterDataID) FROM LetterData WHERE LetterID=Letter.LetterID and extention=3)>1 THEN 1 ELSE 0 END AS has_File,'+
					 'Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,'+
					 'at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,'+
					'(SELECT top (1)  a.Title FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,'+
					'Letter.SubjectDescription,dbo.has_sign(Letter.letterID) as has_sign ,dbo.HasLetterForms(Letter.Letterid) HasLetterForms,
					'+
					'(SELECT top (1)  a.FolderID FROM ArchiveFolder AS a 
					INNER JOIN LetterArchiveFolder AS b 
					ON a.FolderID=b.ArchiveFolderID 
					AND b.LetterID=Letter.LetterID) AS FolderID,Secretariats.SecTitle SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			' 
			 FROM Letter 
			  INNER JOIN sendstatus AS ss
			   on ss.sendstatusID=Letter.sendstatusID 
			   INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID
			  LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID'+
			' LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID'+
			' LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type'+
			' LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID'+
			' WHERE Letter.Finalized=1 AND Letter.Archived=1 AND '+
				  ' ((Letter_Type='+CAST(@Letter_Type AS VARCHAR(5))+') OR ('+CAST(@Letter_Type AS VARCHAR(5))+'=0)) AND '+
				  ' ((Secretariatid='+CAST(@SecretariatID AS VARCHAR(5))+') OR ('+CAST(@SecretariatID AS VARCHAR(5))+'<=0)) AND '+
				  ' ((myear='+CAST(@Myear AS VARCHAR(5))+') OR ('+CAST(@Myear AS VARCHAR(5))+'<=0)) AND '+
				  ' ((Letter.LetterFormat='+CAST(@LetterFormat AS VARCHAR(5))+') OR ('+CAST(@LetterFormat AS VARCHAR(5))+'<=0))'+
				  ' And ' + @where + ' order by letter.letterid desc'

			Exec Sp_ExecuteSql   @sqlCommand
		END	 
		 
		IF @ArchiveFolderID>0
		BEGIN
			DELETE FROM #s WHERE ISNULL(FolderID,0)!=@ArchiveFolderID
		END
		
		DELETE FROM #s WHERE LetterID NOT IN 
		(
			SELECT s.LetterID FROM #s AS s
			INNER JOIN Letter L ON s.LetterID=L.LetterID
			INNER JOIN LetterArchiveFolder laf ON laf.Letterid = L.letterid And L.LetterID = s.LetterID
			INNER JOIN Archivefolder af  on laf.ArchiveFolderID = af.FolderID              
			INNER JOIN UserAccArchive uac on uac.ArchiveFolderID = af.FolderID and uac.secid=L.SecretariatID
			WHERE ISNULL(uac.UserID, CAST(@userid as varchar(10)))= CAST(@userid as varchar(10)) And ISNULL(uac.ISAccess,1)=1 		
		)
			  
	END
	ELSE
	IF @ArchiveStatus=2
	BEGIN
		IF isnull(ltrim(rtrim(@where)),'')=''
		BEGIN
			INSERT INTO #s
			(
				PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,
				ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,
				DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,
				ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,ArchivecenterID,
				SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			)
			SELECT DISTINCT top (@Top) 
					PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,              
					Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,'-' AS RetroactionNo,Letter.RegistrationDate,'-' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,                  
					Deliver.Title AS DeliverTitle,
					case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page, 
					case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention = 3) THEN 1 ELSE 0 END AS has_WordPage, 
					case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention > 3) OR
							(SELECT count( LetterDataID) FROM LetterData WHERE LetterID=Letter.LetterID and extention=3)>1 THEN 1 ELSE 0 END AS has_File,                  
					 Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,
					 at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,
					(SELECT a.Title FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,
					Letter.SubjectDescription,dbo.has_sign(Letter.letterID) as has_sign ,dbo.HasLetterForms(Letter.Letterid) HasLetterForms,
					(SELECT top (1)  a.FolderID FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS FolderID,
					(SELECT top (1)  a.ArchiveCenterID FROM ArchiveFolder AS a 
					INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID 
					AND b.LetterID=Letter.LetterID) AS ArchiveCenterID,Secretariats.SecTitle as SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			FROM Letter
			INNER JOIN sendstatus AS ss on ss.sendstatusID=Letter.sendstatusID                  
			INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID                  
			LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID 
			LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID                  
			LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type
			LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID                  
			WHERE Letter.Finalized=1 AND Letter.Archived=1 AND
				  ((Letter_Type=@Letter_Type) OR (@Letter_Type=0)) AND
				  ((Secretariatid=@SecretariatID) OR (@SecretariatID<=0)) AND
				  ((myear=@Myear) OR (@Myear<=0)) AND
				  ((Letter.LetterFormat=@LetterFormat) OR (@LetterFormat<=0))/*AND
				  (letter.LetterID>=(SELECT ISNULL(MAX(letterID)-10000,0) FROM Letter))*/
			order by letter.letterid desc
		END
		ELSE
		BEGIN
			Set @sqlCommand='DECLARE @DO_ VarCHAR(10) SET @DO_=dbo.ATF_PEY_SETTING(''ATF-PEY'')'+
			' INSERT INTO #s'+
			'('+
				'PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,'+
				'ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,'+
				'DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,'+
				'ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,ArchivecenterID
				,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			')'+
			' SELECT DISTINCT top ('+CAST(@Top as varchar)+')' + 
					' PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,'+
					'Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,''-'' AS RetroactionNo,Letter.RegistrationDate,''-'' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,'+
					'Deliver.Title AS DeliverTitle,'+
					' case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page,'+
					' case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention = 3) THEN 1 ELSE 0 END AS has_WordPage,'+ 
					' case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention > 3) OR'+
					'(SELECT count( LetterDataID) FROM LetterData WHERE LetterID=Letter.LetterID and extention=3)>1 THEN 1 ELSE 0 END AS has_File,'+
					 'Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,'+
					 'at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,'+
					'(SELECT top (1)  a.Title FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,'+
					'Letter.SubjectDescription,
					dbo.has_sign(Letter.letterID) as has_sign ,
					dbo.HasLetterForms(Letter.Letterid) HasLetterForms,'+
					'(SELECT top (1)  a.FolderID FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS FolderID,'+
					'(SELECT a.ArchiveCenterID FROM ArchiveFolder AS a 
					INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID 
					AND b.LetterID=Letter.LetterID) AS ArchiveCenterID,Secretariats.SecTitle SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			' FROM Letter'+
			' INNER JOIN sendstatus AS ss on ss.sendstatusID=Letter.sendstatusID'+
			' INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID'+
			' LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID'+
			' LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID'+
			' LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type'+
			' LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID'+
			' WHERE Letter.Finalized=1 AND Letter.Archived=1 AND '+
				  '((Letter_Type='+CAST(@Letter_Type AS VARCHAR(5))+') OR ('+CAST(@Letter_Type AS VARCHAR(5))+'=0)) AND '+
				  '((Secretariatid='+CAST(@SecretariatID AS VARCHAR(5))+') OR ('+CAST(@SecretariatID AS VARCHAR(5))+'<=0)) AND '+
				  '((myear='+CAST(@Myear AS VARCHAR(5))+') OR ('+CAST(@Myear AS VARCHAR(5))+'<=0)) AND '+
				  '((Letter.LetterFormat='+CAST(@LetterFormat AS VARCHAR(5))+') OR ('+CAST(@LetterFormat AS VARCHAR(5))+'<=0))'+
				  ' And ' + @where + ' order by letter.letterid desc'
	
			Exec Sp_ExecuteSql   @sqlCommand
		END

		DELETE FROM #s WHERE ISNULL(FolderID,0)>0

		IF @ArchiveFolderID>0
		BEGIN
			DELETE FROM #s WHERE ISNULL(FolderID,0)!=@ArchiveFolderID
		END
	END
	ELSE
	BEGIN
		IF isnull(ltrim(rtrim(@where)),'')=''
		BEGIN
			INSERT INTO #s
			(
				PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,
				ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,
				DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,
				ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			)
			SELECT DISTINCT top (@Top)
					PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,              
					Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,'-' AS RetroactionNo,Letter.RegistrationDate,'-' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,                  
					Deliver.Title AS DeliverTitle,
					case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page, 
					case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention = 3) THEN 1 ELSE 0 END AS has_WordPage, 
					case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention > 3) OR
							(SELECT count( LetterDataID) FROM LetterData WHERE LetterID=Letter.LetterID and extention=3)>1 THEN 1 ELSE 0 END AS has_File,
					 Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,
					 at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,
					(SELECT top (1) a.Title FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,
					Letter.SubjectDescription,dbo.has_sign(Letter.letterID) as has_sign ,dbo.HasLetterForms(Letter.Letterid) HasLetterForms,
					(SELECT top (1) a.FolderID FROM ArchiveFolder AS a 
					INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID
					 AND b.LetterID=Letter.LetterID) AS FolderID,Secretariats.SecTitle as SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			FROM Letter
			INNER JOIN sendstatus AS ss on ss.sendstatusID=Letter.sendstatusID
			INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID
			LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID
			LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID
			LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type
			LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID
			WHERE Letter.Finalized=1 AND
				  ((Letter_Type=@Letter_Type) OR (@Letter_Type=0)) AND
				  ((Secretariatid=@SecretariatID) OR (@SecretariatID<=0)) AND
				  ((myear=@Myear) OR (@Myear<=0)) AND
				  ((Letter.LetterFormat=@LetterFormat) OR (@LetterFormat<=0)) /*AND
				  (letter.LetterID>=(SELECT ISNULL(MAX(letterID)-10000,0) FROM Letter)) */
			order by letter.letterid desc
		END
		ELSE
		BEGIN
			Set @sqlCommand='DECLARE @DO_ CHAR(10) SET @DO_ = dbo.ATF_PEY_SETTING (''ATF-PEY'')'+
			' INSERT INTO #s'+
			' ( '+
				'PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,'+
				'ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,'+
				'DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,'+
				'ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			')'+
			' SELECT DISTINCT top ('+CAST(@Top as varchar)+')' + 
					' PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,'+
					'Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,''-'' AS RetroactionNo,Letter.RegistrationDate,''-'' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,'+
					'Deliver.Title AS DeliverTitle,'+
					' case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page,'+
					' case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention = 3) THEN 1 ELSE 0 END AS has_WordPage, '+
					' case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention > 3) OR '+
							'(SELECT count( LetterDataID) FROM LetterData WHERE LetterID=Letter.LetterID and extention=3)>1 THEN 1 ELSE 0 END AS has_File,'+
					 'Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,'+
					' at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,'+
					'(SELECT top (1)  a.Title FROM ArchiveFolder AS a 
					INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,'+
					'Letter.SubjectDescription,dbo.has_sign(Letter.letterID) as has_sign ,
					dbo.HasLetterForms(Letter.Letterid) HasLetterForms,'+
					'(SELECT top (1)  a.FolderID FROM ArchiveFolder AS a 
					INNER JOIN LetterArchiveFolder AS b 
					ON a.FolderID=b.ArchiveFolderID 
					AND b.LetterID=Letter.LetterID) AS FolderID,Secretariats.SecTitle as SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			' FROM Letter 
			INNER JOIN sendstatus AS ss on ss.sendstatusID=Letter.sendstatusID INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID'+
			' LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID'+
			' LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type'+
			' LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID'+
			' WHERE Letter.Finalized=1 AND '+
				  '((Letter_Type='+CAST(@Letter_Type AS VARCHAR(5))+') OR ('+CAST(@Letter_Type AS VARCHAR(5))+'=0)) AND '+
				  '((Secretariatid='+CAST(@SecretariatID AS VARCHAR(5))+') OR ('+CAST(@SecretariatID AS VARCHAR(5))+'<=0)) AND '+
				 ' ((myear='+CAST(@Myear AS VARCHAR(5))+') OR ('+CAST(@Myear AS VARCHAR(5))+'<=0)) AND '+
				  '((Letter.LetterFormat='+CAST(@LetterFormat AS VARCHAR(5))+') OR ('+CAST(@LetterFormat AS VARCHAR(5))+'<=0))'+
				  ' And ' + @where + ' order by letter.letterid desc'


			Exec Sp_ExecuteSql   @sqlCommand				  
		END
		IF @ArchiveFolderID>0
		BEGIN
			DELETE FROM #s WHERE ISNULL(FolderID,0)!=@ArchiveFolderID
		END
		
	END

    DECLARE @LID INT ,@ArchPlace VARCHAR(100),@AllArchPlace VARCHAR(400)
    DECLARE cr CURSOR FOR
    SELECT DISTINCT letterid FROM #s
    GROUP BY letterid
    HAVING COUNT(*)>1

    OPEN cr 

    FETCH NEXT FROM cr INTO @LID

    WHILE @@FETCH_STATUS = 0
    BEGIN
        SET @AllArchPlace=''    
            DECLARE crin CURSOR FOR         
            SELECT ArchivePlace FROM #s WHERE letterid=@LID    
            OPEN crin 
            FETCH NEXT FROM crin INTO @ArchPlace    
            WHILE @@FETCH_STATUS = 0
            BEGIN
                SET @AllArchPlace=@AllArchPlace+' , '+@ArchPlace
                FETCH NEXT FROM crin INTO @ArchPlace
            END
            CLOSE crin
            DEALLOCATE crin        
        UPDATE #s
        SET ArchivePlace=@AllArchPlace
        WHERE letterid=@LID AND ArchivePlace=@ArchPlace
        
        DELETE FROM #s WHERE letterid=@LID AND ArchivePlace<>@AllArchPlace 
        
        FETCH NEXT FROM cr INTO @LID
    END
    CLOSE cr
    DEALLOCATE cr

	SELECT PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,
		   ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,
		   DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,
		   ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
	FROM #s
    ORDER BY RegistrationDate DESC,letterid desc


[END_S_NO]

[BEGIN_S_NO]=4

ALTER  procedure [dbo].[Sp_GetAllFromOrganizations](@isInnerOrg BIT,@groupId INT)
AS

--IF(@groupId=0)
--   SELECT distinct  fo.ID, ISNULL(fo.Title,'') Title, fo.ParentID, fo.Phone, fo.Fax, fo.Email, 
--                    fo.ResponsibleStaffer,fo.IsActive, fo.PreCode, fo.IsInnerOrg, fo.Code, fo.UniqueID 
--   FROM FromOrganizations fo INNER JOIN ChartWorkGroupDetails cwgd
--   ON fo.ID=cwgd.OrgID
--   WHERE fo.IsInnerOrg=@isInnerOrg AND cwgd.AccessForErja=1

---- small RESULT
	--SELECT  distinct  fo.ID, ISNULL(fo.Title,'') Title, fo.ParentID, fo.Phone, fo.Fax, fo.Email, 
 --                   fo.ResponsibleStaffer,fo.IsActive, fo.PreCode, fo.IsInnerOrg, fo.Code, fo.UniqueID 
	--FROM FromOrganizations fo INNER JOIN ChartWorkGroupDetails t1
 --   ON fo.ID=t1.OrgID
 --    inner join users t2 on t2.id=@groupId and (t1.OrgID=t2.FromOrgID or t1.OrgID=t2.FiveOrgID or t1.OrgID=t2.FourOrgID or t1.OrgID=t2.TreeOrgID or t1.OrgID=t2.SecondOrgID)
	--WHERE fo.IsInnerOrg=1 AND t1.AccessForErja=1
SELECT  distinct  
	fo.ID, 
	ISNULL(fo.Title,'')+'-'+ResponsibleStaffer Title, 
	fo.ParentID, 
	fo.Phone, 
	fo.Fax, 
	fo.Email, 
    fo.ResponsibleStaffer,
	fo.IsActive, 
	fo.PreCode, 
	fo.IsInnerOrg, 
	fo.Code, 
	fo.UniqueID 
from FromOrganizations fo 
inner join ChartWorkGroupDetails t1 
on t1.OrgID=fo.id 
and AccessForErja=1 
/*
and t1.GroupID in (
					SELECT  distinct  t1.GroupID
					FROM FromOrganizations fo 
					INNER JOIN ChartWorkGroupDetails t1
					ON fo.GroupID=t1.GroupID
					 inner join users t2 
					 on t2.id=@groupId  
					 and (   fo.id=t2.FromOrgID 
					      or fo.id=t2.FiveOrgID 
						  or fo.id=t2.FourOrgID 
						  or fo.id=t2.TreeOrgID 
						  or fo.id=t2.SecondOrgID
						 )	 
                   )
*/
WHERE fo.IsInnerOrg=1 
AND t1.AccessForErja=1
union 
SELECT  distinct  
	fo.ID, 
	ISNULL(fo.Title,'')+'-'+ResponsibleStaffer Title, 
	fo.ParentID, 
	fo.Phone, 
	fo.Fax, 
	fo.Email, 
	fo.ResponsibleStaffer,
	fo.IsActive, 
	fo.PreCode, 
	fo.IsInnerOrg, 
	fo.Code, 
	fo.UniqueID 
from FromOrganizations fo 
where fo.ID IN( 
 select distinct ParentID from [dbo].[FromOrganizations]
where IsInnerOrg = 0 )
or  fo.IsInnerOrg= 0

/*
where fo.Title IN( N'دبيرخانه هاي ديگر',N'دبيرخانه  هاي ديگر',N'دبيرخانه  هاي ديگر')
or fo.ParentID  = (select top 1 id 
                   from FromOrganizations 
                     where Title IN( N'دبيرخانه هاي ديگر',N'دبيرخانه  هاي ديگر',N'دبيرخانه  هاي ديگر')
			       )
				   */



[END_S_NO]

[BEGIN_S_NO]=5

ALTER PROCEDURE [dbo].[Get_All_Letter]  
    @SecretariatID int,                  
    @Myear int,                  
    @Letter_Type int,                  
    @LetterFormat int,                  
    @Where nvarchar(4000),                  
    @Top int,                  
    @ArchiveFolderID int,                  
    @ArchiveStatus tinyint ,-- 0 ,1 and 2(= all)               
    @UserID int 
	
    As 
    
	 
    IF ISNULL(LTRIM(RTRIM(@where)),'')=''
    BEGIN
		DECLARE @DO_ CHAR(10) SET @DO_ = dbo.ATF_PEY_SETTING ('ATF-PEY')
    END

    DECLARE @SqlCommand nvarchar(max),@InnerNo NVARCHAR(500)
                                     
    IF OBJECT_ID('tempdb..#s') IS NOT NULL 
		DROP TABLE #s   
                
    Set @InnerNo=dbo.InnerNoFormat('Sender','Deliver',@SecretariatID)     

    IF OBJECT_ID('tempdb..#s') IS NOT NULL 
		DROP TABLE #s
    
	CREATE TABLE #s
    (
    PEY2 NVARCHAR(200),
    ATF2 NVARCHAR(200),
    PEY NVARCHAR(100),
    ATF NVARCHAR(100),
    LetterID INT,   
    CenterNo NVARCHAR(50),                                          
    IndicatorID INT,
    MYear INT,
    SecretariatID INT,
    Letter_Type INT,
    letterformat INT,
    IncommingNO NVARCHAR(50),                                       
    FromOrgID INT,  
    IncommingDate NVARCHAR(10),
    ToOrgID INT,    
    UrgencyID INT,  
    Memo NVARCHAR(4000),                                                                                                                                                                                                                                                           
    RetroactionNo NVARCHAR(1000),                                     
    RegistrationDate CHAR(10),
    FollowLetterNo NVARCHAR(1000),                                    
    ToStaffer NVARCHAR(50),                                         
    SentLetterID INT,
    TemplateID  INT,
    UserMemo  NVARCHAR(1000),                                                                                                                                                                                                                                                      
    DeadLineDate CHAR(10),
    SenderTitle NVARCHAR(100),                                                                                         
    DeliverTitle NVARCHAR(100),                                                                                        
    has_Page BIT,
    has_WordPage BIT,
    has_file BIT,
    SubjectID INT,  
    LetterTypeTitle NVARCHAR(50),                                    
    LetterRecommites NVARCHAR(4000),                                                                                                                                                                                                                                                
    sendstatusTitle  NVARCHAR(100),                                                                                    
    InnerNo VARCHAR(500),
    InnerNoForWord VARCHAR(500),
    Archived BIT,
    ActionTypeTitle NVARCHAR(50),                                   
    SignerID NVARCHAR(200),                                           
    SignerTitle NVARCHAR(100),                                                                                         
    ReceiveTypeID INT,
    ClassificationID INT,
    ArchivePlace NVARCHAR(500),
    SubjectDescription NVARCHAR(4000),
    has_sign BIT ,   
    HasLetterForms BIT,
    FolderID INT,
    ArchivecenterID INT,
	SecretariatTitle  NVARCHAR(100),
	EmailFromDateTime Nvarchar(20),
	EmailFrom nvarchar(1000),
	EmailSubject nvarchar(2000),
	IsNetWork bit
			  
    )

	IF @ArchiveStatus = 0
	BEGIN
		IF isnull(ltrim(rtrim(@where)),'')=''
		BEGIN
			INSERT INTO #s
			(
				PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,
				ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,
				DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,
				ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			)
			SELECT DISTINCT top (@Top)
					PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,              
					Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,'-' AS RetroactionNo,Letter.RegistrationDate,'-' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,                  
					Deliver.Title AS DeliverTitle,
					case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page, 
					dbo.has_WordPage(letter.LetterID) AS has_WordPage, 
					dbo.has_file(letter.LetterID) AS has_File,
																																	
					 Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,
					 at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,
					(SELECT top (1)  a.Title FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,
					Letter.SubjectDescription,dbo.has_sign(Letter.letterID) as has_sign ,dbo.HasLetterForms(Letter.Letterid) HasLetterForms,
					(SELECT top (1)  a.FolderID 
					FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b 
					ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS FolderID,
					Secretariats.SecTitle as SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			FROM Letter
			INNER JOIN sendstatus AS ss on ss.sendstatusID=Letter.sendstatusID
			INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID
			LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID
			LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID
			LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type
			LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID
			WHERE Letter.Finalized=1 AND Letter.Archived=0 AND
				  ((Letter_Type=@Letter_Type) OR (@Letter_Type=0)) AND
				  ((Secretariatid=@SecretariatID) OR (@SecretariatID<=0)) AND
				  ((myear=@Myear) OR (@Myear<=0)) AND
				  ((Letter.LetterFormat=@LetterFormat) OR (@LetterFormat<=0))AND
				  (letter.LetterID>=(SELECT ISNULL(MAX(letterID)-10000,0) FROM Letter))	
			order by letter.letterid desc
					
		END
		ELSE
		BEGIN
			Set @sqlCommand='DECLARE @DO_ CHAR(10) SET @DO_ = dbo.ATF_PEY_SETTING (''ATF-PEY'')'+
			' INSERT INTO #s'+
			'('+
				'PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,'+
				'ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,'+
				'DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,'+
				'ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			 ' )'+
			' SELECT DISTINCT top ('+CAST(@Top as varchar)+')' + 
					' PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,'+              
					'Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,''-'' AS RetroactionNo,Letter.RegistrationDate,''-'' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,'+                  
					'Deliver.Title AS DeliverTitle,'+
					' case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page,'+
					' dbo.has_WordPage(letter.LetterID) AS has_WordPage, '+
					' dbo.has_file(letter.LetterID) AS has_File,'+
																																		
					 'Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,'+
					 'at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,'+
					' (SELECT top (1)  a.Title FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,'+
					'Letter.SubjectDescription,dbo.has_sign(Letter.letterID) as has_sign ,
					dbo.HasLetterForms(Letter.Letterid) HasLetterForms,'+
					' (SELECT top (1)  a.FolderID FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b 
					ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS FolderID,Secretariats.SecTitle SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			' FROM Letter 
			INNER JOIN sendstatus AS ss on ss.sendstatusID=Letter.sendstatusID 
			INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID'+
			' LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID'+
			' LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type'+
			' LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID'+
			' WHERE Letter.Finalized=1 AND Letter.Archived=0 AND '+
				  '((Letter_Type='+CAST(@Letter_Type AS VARCHAR(5))+') OR ('+CAST(@Letter_Type AS VARCHAR(5))+'=0)) AND '+
				  '((Secretariatid='+CAST(@SecretariatID AS VARCHAR(5))+') OR ('+CAST(@SecretariatID AS VARCHAR(5))+'<=0)) AND '+
				  '((myear='+CAST(@Myear AS VARCHAR(5))+') OR ('+CAST(@Myear AS VARCHAR(5))+'<=0)) AND '+
				  '((Letter.LetterFormat='+CAST(@LetterFormat AS VARCHAR(5))+') OR ('+CAST(@LetterFormat AS VARCHAR(55))+'<=0))'+
				  ' And ' + @where + ' order by letter.letterid desc'
			
			Exec Sp_ExecuteSql   @sqlCommand
		END
		
		IF @ArchiveFolderID>0
		BEGIN
			DELETE FROM #s WHERE ISNULL(FolderID,0)!=@ArchiveFolderID
		END

	END
	ELSE
	IF @ArchiveStatus=1
	BEGIN
		IF isnull(ltrim(rtrim(@where)),'')=''
		BEGIN
			INSERT INTO #s
			(
				PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,
				ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,
				DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,
				ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			)
			SELECT DISTINCT top (@Top)
					PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,              
					Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,'-' AS RetroactionNo,Letter.RegistrationDate,'-' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,                  
					Deliver.Title AS DeliverTitle,
					case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page, 
					dbo.has_WordPage(letter.LetterID) AS has_WordPage, 
					dbo.has_file(letter.LetterID) AS has_File,
																																	
					 Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,
					 at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,
					(SELECT top (1)  a.Title FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,
					Letter.SubjectDescription,dbo.has_sign(Letter.letterID) as has_sign ,dbo.HasLetterForms(Letter.Letterid) HasLetterForms,
					(SELECT top (1)  a.FolderID FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID 
					AND b.LetterID=Letter.LetterID) AS FolderID,Secretariats.SecTitle as SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			FROM Letter
			INNER JOIN sendstatus AS ss on ss.sendstatusID=Letter.sendstatusID
			INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID
			LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID
			LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID
			LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type
			LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID
			WHERE Letter.Finalized=1 AND Letter.Archived=1 AND
				  ((Letter_Type=@Letter_Type) OR (@Letter_Type=0)) AND
				  ((Secretariatid=@SecretariatID) OR (@SecretariatID<=0)) AND
				  ((myear=@Myear) OR (@Myear<=0)) AND
				  ((Letter.LetterFormat=@LetterFormat) OR (@LetterFormat<=0))AND
				  (letter.LetterID>=(SELECT ISNULL(MAX(letterID)-10000,0) FROM Letter))
			order by letter.letterid desc
		END
		ELSE
		BEGIN
			Set @sqlCommand='DECLARE @DO_ CHAR(10) SET @DO_ = dbo.ATF_PEY_SETTING (''ATF-PEY'')'+
			' INSERT INTO #s'+
			'('+
				'PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,'+
				'ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,'+
				'DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,'+
				'ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			')'+
			' SELECT DISTINCT top ('+CAST(@Top as varchar)+')' + 
					' PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,'+
					' Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,''-'' AS RetroactionNo,Letter.RegistrationDate,''-'' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,'+
					'Deliver.Title AS DeliverTitle,'+
					' case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page,'+
					' dbo.has_WordPage(letter.LetterID) AS has_WordPage, '+
					' dbo.has_file(letter.LetterID) AS has_File,'+
																																		
					 'Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,'+
					 'at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,'+
					'(SELECT top (1)  a.Title FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,'+
					'Letter.SubjectDescription,dbo.has_sign(Letter.letterID) as has_sign ,dbo.HasLetterForms(Letter.Letterid) HasLetterForms,
					'+
					'(SELECT top (1)  a.FolderID FROM ArchiveFolder AS a 
					INNER JOIN LetterArchiveFolder AS b 
					ON a.FolderID=b.ArchiveFolderID 
					AND b.LetterID=Letter.LetterID) AS FolderID,Secretariats.SecTitle SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			' 
			 FROM Letter 
			  INNER JOIN sendstatus AS ss
			   on ss.sendstatusID=Letter.sendstatusID 
			   INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID
			  LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID'+
			' LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID'+
			' LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type'+
			' LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID'+
			' WHERE Letter.Finalized=1 AND Letter.Archived=1 AND '+
				  ' ((Letter_Type='+CAST(@Letter_Type AS VARCHAR(5))+') OR ('+CAST(@Letter_Type AS VARCHAR(5))+'=0)) AND '+
				  ' ((Secretariatid='+CAST(@SecretariatID AS VARCHAR(5))+') OR ('+CAST(@SecretariatID AS VARCHAR(5))+'<=0)) AND '+
				  ' ((myear='+CAST(@Myear AS VARCHAR(5))+') OR ('+CAST(@Myear AS VARCHAR(5))+'<=0)) AND '+
				  ' ((Letter.LetterFormat='+CAST(@LetterFormat AS VARCHAR(5))+') OR ('+CAST(@LetterFormat AS VARCHAR(5))+'<=0))'+
				  ' And ' + @where + ' order by letter.letterid desc'

			Exec Sp_ExecuteSql   @sqlCommand
		END	 
		 
		IF @ArchiveFolderID>0
		BEGIN
			DELETE FROM #s WHERE ISNULL(FolderID,0)!=@ArchiveFolderID
		END
		
		DELETE FROM #s WHERE LetterID NOT IN 
		(
			SELECT s.LetterID FROM #s AS s
			INNER JOIN Letter L ON s.LetterID=L.LetterID
			INNER JOIN LetterArchiveFolder laf ON laf.Letterid = L.letterid And L.LetterID = s.LetterID
			INNER JOIN Archivefolder af  on laf.ArchiveFolderID = af.FolderID              
			INNER JOIN UserAccArchive uac on uac.ArchiveFolderID = af.FolderID and uac.secid=L.SecretariatID
			WHERE ISNULL(uac.UserID, CAST(@userid as varchar(10)))= CAST(@userid as varchar(10)) And ISNULL(uac.ISAccess,1)=1 		
		)
			  
	END
	ELSE
	IF @ArchiveStatus=2
	BEGIN
		IF isnull(ltrim(rtrim(@where)),'')=''
		BEGIN
			INSERT INTO #s
			(
				PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,
				ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,
				DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,
				ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,ArchivecenterID,
				SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			)
			SELECT DISTINCT top (@Top) 
					PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,              
					Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,'-' AS RetroactionNo,Letter.RegistrationDate,'-' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,                  
					Deliver.Title AS DeliverTitle,
					case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page, 
					dbo.has_WordPage(letter.LetterID) AS has_WordPage, 
					dbo.has_file(letter.LetterID) AS has_File,                  
																																					  
					 Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,
					 at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,
					(SELECT top (1) a.Title FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,
					Letter.SubjectDescription,dbo.has_sign(Letter.letterID) as has_sign ,dbo.HasLetterForms(Letter.Letterid) HasLetterForms,
					(SELECT top (1)  a.FolderID FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS FolderID,
					(SELECT top (1)  a.ArchiveCenterID FROM ArchiveFolder AS a 
					INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID 
					AND b.LetterID=Letter.LetterID) AS ArchiveCenterID,Secretariats.SecTitle as SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			FROM Letter
			INNER JOIN sendstatus AS ss on ss.sendstatusID=Letter.sendstatusID                  
			INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID                  
			LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID 
			LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID                  
			LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type
			LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID                  
			WHERE Letter.Finalized=1 AND Letter.Archived=1 AND
				  ((Letter_Type=@Letter_Type) OR (@Letter_Type=0)) AND
				  ((Secretariatid=@SecretariatID) OR (@SecretariatID<=0)) AND
				  ((myear=@Myear) OR (@Myear<=0)) AND
				  ((Letter.LetterFormat=@LetterFormat) OR (@LetterFormat<=0))AND
				  (letter.LetterID>=(SELECT ISNULL(MAX(letterID)-10000,0) FROM Letter))
			order by letter.letterid desc
		END
		ELSE
		BEGIN
			Set @sqlCommand='DECLARE @DO_ VarCHAR(10) SET @DO_=dbo.ATF_PEY_SETTING(''ATF-PEY'')'+
			' INSERT INTO #s'+
			'('+
				'PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,'+
				'ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,'+
				'DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,'+
				'ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,ArchivecenterID
				,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			')'+
			' SELECT DISTINCT top ('+CAST(@Top as varchar)+')' + 
					' PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,'+
					'Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,''-'' AS RetroactionNo,Letter.RegistrationDate,''-'' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,'+
					'Deliver.Title AS DeliverTitle,'+
					' case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page,'+
					' dbo.has_WordPage(letter.LetterID) AS has_WordPage,'+ 
					' dbo.has_file(letter.LetterID) AS has_File,'+
																																	 
					 'Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,'+
					 'at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,'+
					'(SELECT top (1)  a.Title FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,'+
					'Letter.SubjectDescription,
					dbo.has_sign(Letter.letterID) as has_sign ,
					dbo.HasLetterForms(Letter.Letterid) HasLetterForms,'+
					'(SELECT top (1)  a.FolderID FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS FolderID,'+
					'(SELECT a.ArchiveCenterID FROM ArchiveFolder AS a 
					INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID 
					AND b.LetterID=Letter.LetterID) AS ArchiveCenterID,Secretariats.SecTitle SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			' FROM Letter'+
			' INNER JOIN sendstatus AS ss on ss.sendstatusID=Letter.sendstatusID'+
			' INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID'+
			' LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID'+
			' LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID'+
			' LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type'+
			' LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID'+
			' WHERE Letter.Finalized=1 AND Letter.Archived=1 AND '+
				  '((Letter_Type='+CAST(@Letter_Type AS VARCHAR(5))+') OR ('+CAST(@Letter_Type AS VARCHAR(5))+'=0)) AND '+
				  '((Secretariatid='+CAST(@SecretariatID AS VARCHAR(5))+') OR ('+CAST(@SecretariatID AS VARCHAR(5))+'<=0)) AND '+
				  '((myear='+CAST(@Myear AS VARCHAR(5))+') OR ('+CAST(@Myear AS VARCHAR(5))+'<=0)) AND '+
				  '((Letter.LetterFormat='+CAST(@LetterFormat AS VARCHAR(5))+') OR ('+CAST(@LetterFormat AS VARCHAR(5))+'<=0))'+
				  ' And ' + @where + ' order by letter.letterid desc'
 
			Exec Sp_ExecuteSql   @sqlCommand
		END

		DELETE FROM #s WHERE ISNULL(FolderID,0)>0

		IF @ArchiveFolderID>0
		BEGIN
			DELETE FROM #s WHERE ISNULL(FolderID,0)!=@ArchiveFolderID
		END
	END
	ELSE
	BEGIN
		IF isnull(ltrim(rtrim(@where)),'')=''
		BEGIN
			INSERT INTO #s
			(
				PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,
				ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,
				DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,
				ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			)
			SELECT DISTINCT top (@Top)
					PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,              
					Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,'-' AS RetroactionNo,Letter.RegistrationDate,'-' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,                  
					Deliver.Title AS DeliverTitle,
					case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page, 
					dbo.has_WordPage(letter.LetterID) AS has_WordPage, 
					dbo.has_file(letter.LetterID) AS has_File,
																																	
					 Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,
					 at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,
					(SELECT top (1) a.Title FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,
					Letter.SubjectDescription,dbo.has_sign(Letter.letterID) as has_sign ,dbo.HasLetterForms(Letter.Letterid) HasLetterForms,
					(SELECT top (1) a.FolderID FROM ArchiveFolder AS a 
					INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID
					 AND b.LetterID=Letter.LetterID) AS FolderID,Secretariats.SecTitle as SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			FROM Letter
			INNER JOIN sendstatus AS ss on ss.sendstatusID=Letter.sendstatusID
			INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID
			LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID
			LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID
			LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type
			LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID
			WHERE Letter.Finalized=1 AND
				  ((Letter_Type=@Letter_Type) OR (@Letter_Type=0)) AND
				  ((Secretariatid=@SecretariatID) OR (@SecretariatID<=0)) AND
				  ((myear=@Myear) OR (@Myear<=0)) AND
				  ((Letter.LetterFormat=@LetterFormat) OR (@LetterFormat<=0)) AND
				  (letter.LetterID>=(SELECT ISNULL(MAX(letterID)-10000,0) FROM Letter)) 
			order by letter.letterid desc
		END
		ELSE
		BEGIN
			Set @sqlCommand='DECLARE @DO_ CHAR(10) SET @DO_ = dbo.ATF_PEY_SETTING (''ATF-PEY'')'+
			' INSERT INTO #s'+
			' ( '+
				'PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,'+
				'ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,'+
				'DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,'+
				'ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			')'+
			' SELECT DISTINCT top ('+CAST(@Top as varchar)+')' + 
					' PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,'+
					'Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,''-'' AS RetroactionNo,Letter.RegistrationDate,''-'' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,'+
					'Deliver.Title AS DeliverTitle,'+
					' case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page,'+
					' dbo.has_WordPage(letter.LetterID) AS has_WordPage, '+
					' dbo.has_file(letter.LetterID) AS has_File,'+
																																	   
					 'Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,'+
					' at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,'+
					'(SELECT top (1)  a.Title FROM ArchiveFolder AS a 
					INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,'+
					'Letter.SubjectDescription,dbo.has_sign(Letter.letterID) as has_sign ,
					dbo.HasLetterForms(Letter.Letterid) HasLetterForms,'+
					'(SELECT top (1)  a.FolderID FROM ArchiveFolder AS a 
					INNER JOIN LetterArchiveFolder AS b 
					ON a.FolderID=b.ArchiveFolderID 
					AND b.LetterID=Letter.LetterID) AS FolderID,Secretariats.SecTitle as SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			' FROM Letter 
			INNER JOIN sendstatus AS ss on ss.sendstatusID=Letter.sendstatusID INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID'+
			' LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID'+
			' LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type'+
			' LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID'+
			' WHERE Letter.Finalized=1 AND '+
				  '((Letter_Type='+CAST(@Letter_Type AS VARCHAR(5))+') OR ('+CAST(@Letter_Type AS VARCHAR(5))+'=0)) AND '+
				  '((Secretariatid='+CAST(@SecretariatID AS VARCHAR(5))+') OR ('+CAST(@SecretariatID AS VARCHAR(5))+'<=0)) AND '+
				 ' ((myear='+CAST(@Myear AS VARCHAR(5))+') OR ('+CAST(@Myear AS VARCHAR(5))+'<=0)) AND '+
				  '((Letter.LetterFormat='+CAST(@LetterFormat AS VARCHAR(5))+') OR ('+CAST(@LetterFormat AS VARCHAR(5))+'<=0))'+
				  ' And ' + @where + ' order by letter.letterid desc'


				  
			Exec Sp_ExecuteSql   @sqlCommand				  
		END
		IF @ArchiveFolderID>0
		BEGIN
			DELETE FROM #s WHERE ISNULL(FolderID,0)!=@ArchiveFolderID
		END
		
	END

    DECLARE @LID INT ,@ArchPlace VARCHAR(100),@AllArchPlace VARCHAR(400)
    DECLARE cr CURSOR FOR
    SELECT DISTINCT letterid FROM #s
    GROUP BY letterid
    HAVING COUNT(*)>1

    OPEN cr 

    FETCH NEXT FROM cr INTO @LID

    WHILE @@FETCH_STATUS = 0
    BEGIN
        SET @AllArchPlace=''    
            DECLARE crin CURSOR FOR         
            SELECT ArchivePlace FROM #s WHERE letterid=@LID    
            OPEN crin 
            FETCH NEXT FROM crin INTO @ArchPlace    
            WHILE @@FETCH_STATUS = 0
            BEGIN
                SET @AllArchPlace=@AllArchPlace+' , '+@ArchPlace
                FETCH NEXT FROM crin INTO @ArchPlace
            END
            CLOSE crin
            DEALLOCATE crin        
        UPDATE #s
        SET ArchivePlace=@AllArchPlace
        WHERE letterid=@LID AND ArchivePlace=@ArchPlace
        
        DELETE FROM #s WHERE letterid=@LID AND ArchivePlace<>@AllArchPlace 
        
        FETCH NEXT FROM cr INTO @LID
    END
    CLOSE cr
    DEALLOCATE cr

	SELECT 
			PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,
		   ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,
		   DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,
		   ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
	FROM #s
    ORDER BY RegistrationDate DESC,letterid desc



[END_S_NO]

[BEGIN_S_NO]=6

alter  PROCEDURE [dbo].[Sp_WebInbox]
	@SecretariatID int,  
	@LetterFormat tinyint,  
	@OrgID int,  
	@Proceeded bit,  
	@Type tinyint,
	@myear int,
	@date tinyint,
	@ArchiveFolderID int ,
	@where nvarchar(1000),  
	@userID int,
	@Letter_Type int,
	@DeadLine int,
	@orderClause varchar(50)=' rc.lastupdate desc,l.indicatorid desc',  
	@top int=100,
	@DayOfNow CHAR(10),
	@WebOrWin VARCHAR(50)=null  
AS  
BEGIN
	--	last modifier xax 1398/03/09

	declare        
		@sql nvarchar (4000),        
		@rw nvarchar(2000),        
		@Today char(10),        
		@Proceed bit, -- @Proceed  
		@todayToint varchar(10),    
		@Mytoday Nvarchar(10)  

SET @WebOrWin=UPPER(LTRIM(RTRIM(ISNULL(@WebOrWin,'Web'))))
				   
	IF @Mytoday='WEB' SELECT @Mytoday=dbo.Shamsi(getdate())

	if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[TempInbox]') )
	drop table [dbo].[TempInbox]

	CREATE TABLE [dbo].[TempInbox]
	( 
	MyTmp_ID INT IDENTITY(1,1) NOT NULL,	
	LetterID INT,
	SignerID NVARCHAR(1000), 
	IndicatorID INT, 
	MYear int,
	subjectid INT, 
	SecretariatID INT, 
	Letter_Type INT,   
	letterformat INT, 
	IncommingNO NVARCHAR(1000), 
	Incommingdate NVARCHAR(100),   
	ClassificationID INT,        
	UrgencyID INT, 
	Memo NVARCHAR(4000), 
	Tostaffer NVARCHAR(4000),
	SentLetterID INT,
	AttachTitle NVARCHAR(1000), 
	NumberOfAttachPages INT, 
	NumberOfPage INT, 
	ReceiveTypeID INT, 
	UserID INT, 
	RetroactionNo NVARCHAR(100),   
	UserMemo NVARCHAR(1000), 
	RegistrationDate CHAR(100),        
	toorgid INT,
	fromorgid INT,
	FollowLetterNo NVARCHAR(1000), 
	LetterRecommites NVARCHAR(1000),
	finalized BIT,
	CenterNo NVARCHAR(100),
	CenterDate CHAR(100),
	templateID INT,
	headerID INT,        
	registrationTime VARCHAR(100),
	fromstaffer NVARCHAR(4000),
	sendStatusID INT,
	LastUpdate DATETIME,
	UserTableID INT,        
	InnerNo NVARCHAR(1000), 
	OrgID INT,  
	ParentId smallINT,
	Paraph NVARCHAR(4000), 
	RecommiteDate VARCHAR(100),  
	Proceeded BIT,        
	ProceedDate VARCHAR(100), 
	ReType smallINT,
	RecommitTypeTitle NVARCHAR(1000),        
	IsInner INT,
	RecommiterTitle NVARCHAR(1000),
	sendertitle NVARCHAR(1000),
	recommiteid INT,        
	id smallINT, 
	isSecure BIT,   
	StaffMemo NVARCHAR(4000), 
	Yincommingno NVARCHAR(1000),
	PreCode NVARCHAR(100),
	IsCopy BIT,
	IsCopy_In_Dabir BIT,
	SentToDabir BIT,
	has_Page BIT,        
	has_WordPage BIT,
	has_UncheckedFollowUp BIT,
	has_ExpiredFollowUp BIT,
	LetterDataId INT,
	has_file BIT,
	DeadLineDays INT,
	ViewDate CHAR(100),
	DeadLineDate CHAR(100),
	ChildParaph VARCHAR(3000),
	ChildOrg VARCHAR(1000),  
	ActionTypeID INT, 
	UserRecomCount INT, 
	IsAnswer BIT, 
	ISFollowup BIT,
	Erja_Or_Answer_Date CHAR(10),
	ColorFlag VARCHAR(50),
	MemoAndRecomUserCount VARCHAR(4000),
	has_Sign BIT,
	row_num int
	)
	-------------------++++++++++++++++++++++++++++-------------------------------------
	-------------------+++++++++++++++++++++++++-------------------------------------      
	select @today=dbo.shamsi(getdate())        
        
	set @Proceed=@Proceeded  
	DECLARE @InnerNo NVARCHAR(500);  
	IF @WebOrWin=UPPER('WIN')  
		set @InnerNo=dbo.InnerNoFormat('TTO','Receiver',@SecretariatID)
	ELSE	   
		set @InnerNo=dbo.InnerNoFormat('TTO','Receiver',-1)
	
	--xax.98.03.06
	--set @RW='WHERE   (RC.Finallized=1) and (Rc.OrgID = '+cast(@OrgID as varchar(10))+')'
	set @RW='WHERE   (RC.Finallized=1) and (Rc.OrgID = '+cast(@OrgID as varchar(10))+' or rc.UserID='+cast(@userid as varchar(10))+')'
	--xax.98.03.06
	
	--set @RW='WHERE   (RC.Finallized=1) '

	SET @InnerNo = REPLACE(@InnerNo, 'Letter.SubjectID', 'l.SubjectID')

	IF  @ArchiveFolderID = 0
		SET @rw = @RW + ' AND (Rc.Proceeded = '+cast(@Proceeded as varchar(2))+')'  

			  
	if @myear>0  set @rw=@rw+'  and  L.myear='+cast(@myear as varchar(10))        
  
					
	if @LetterFormat>0 set @rw=@rw+' and (l.LetterFormat ='+cast( @LetterFormat as varchar(2))+')'        
	  
	--else set @rw=@rw+' and (l.LetterFormat in (0,1,2))'        
        
	if @letter_Type>0        
	set @rw=@rw+' AND (l.letter_Type = '+cast(@Letter_Type as varchar(3))+')'        
        
	if @type>0        
		  set @rw=@rw+' AND (Rc.Type = '+cast(@Type as varchar(2))+')'        
      
	if @ArchiveFolderID>0
	begin
		if exists (select * from ArchiveFolder where UserID=@userID and FolderID=@ArchiveFolderID and ParentFolderID =0)
			begin
			set @rw=@rw+' AND (ParentFolderID = '+cast(@ArchiveFolderID as varchar(10))+')'        
			end
		else
			begin
			set @rw=@rw+' AND (ArchiveFolderID = '+cast(@ArchiveFolderID as varchar(10))+')'        
			end
	end

	if @date<>0        
	begin        
	 declare @dw tinyint,@bdate char(10),@edate char(10)        
	  set @dw=datepart(dw,Getdate())    
	--Ranjbar    
	  ---select @bdate=begindate,@edate=Enddate from HistoryDateList(@today ,@dw) where id=@date     
	 -- Set @Mytoday = Cast(1300+@myear as nvarchar)+ Substring(@Today,5,6)    
	  Set @Mytoday = Cast(@myear as nvarchar)+ Substring(@Today,5,6)  	  
	  select @bdate=begindate,@edate=Enddate from HistoryDateList(@Mytoday ,@dw) where id=@date     
	--//    
        
	 set @rw=@rw+' AND (RC.RecommiteDate between '''+@bdate+''' and '''+@edate+''')'        
	end        
        
	if @SecretariatID>0        
	set @rw=@rw+' AND (SecretariatID = '+cast(@SecretariatID as varchar(10))+')'        
	else        
	set @rw=@rw+' AND (SecretariatID in (SELECT SecId FROM UserSecretariats WHERE UserId = '+cast(@userid as varchar(5))+'))'        
        
	set @todayToint=cast(dbo.ShamsiToInt(@today) as varchar(10))        
        
	--if @DeadLine between -1 and 30        
	-- set @rw=@rw+' AND ('+        
	--case when @Proceed=1 then 'case when RC.Proceeded=0 then ISNULL(ChildRecommite.DeadLineToint,'+@todayToint+') else    
	--'''+@todayToint+''' end '        
		 
	--else  'ISNULL(RC.DeadLineToint ,'+@todayToint+') ' end+' -'+@todayToint+' )<= '+cast(@DeadLine as varchar(5))        
        
	set @sql='SELECT top '+cast(@top as varchar(5))+' L.LetterID,L.SignerID, L.IndicatorID, L.MYear,l.subjectid, L.SecretariatID, L.Letter_Type,   
	L.letterformat, L.IncommingNO, L.Incommingdate,   
	L.ClassificationID,        
	L.UrgencyID, L.Memo, L.Tostaffer,l.SentLetterID,L.AttachTitle, L.NumberOfAttachPages, L.NumberOfPage, L.ReceiveTypeID, L.UserID, L.RetroactionNo,   
	L.UserMemo, L.RegistrationDate,        
	l.toorgid,l.fromorgid,L.FollowLetterNo, L.LetterRecommites,l.finalized,l.CenterNo,l.CenterDate,l.templateID,l.headerID,        
	l.registrationTime,l.fromstaffer,l.sendStatusID,L.LastUpdate,L.UserTableID,        
	'+@InnerNo+' InnerNo, PRC.OrgID,  RC.ParentId,  RC.Paraph, RC.RecommiteDate,  RC.Proceeded,        
	 RC.ProceedDate, RecommiteTypes.id ReType,RecommiteTypes.Title RecommitTypeTitle,        
	case when fo.title is null then 0 else 1 end IsInner, isnull(isnull(FO.Title,foo.title),TTO.title) RecommiterTitle,tto.title sendertitle,rc.recommiteid,        
	 rc.id,  rc.IsSecure,  
	RC.StaffMemo,  
	isnull(incommingno,indicatorid)  Yincommingno,Secretariats.PreCode,RC.IsCopy,RC.IsCopy_In_Dabir,RC.SentToDabir      
	,dbo.has_Page(l.letterid) has_Page,        
	dbo.has_WordPage(l.letterid) has_WordPage,
	dbo.has_UncheckedFollowUp(l.letterid)  has_UncheckedFollowUp,
	dbo.has_ExpiredFollowUp(l.letterid) has_ExpiredFollowUp,
	(select LetterDataID from LetterData where LetterData.LetterID=l.letterid and LetterData.extention IN(3)) as LetterDataId,       
	dbo.has_file(l.letterid) has_file, '+        
	'isnull('+        
	case when @Proceed=1 then 'RC.DeadLineToint' else 'RC.DeadLineToint' end+'-'+@todayToint+',0) DeadLineDays,'+  
	case when @Proceed=1 then 'ChildRecommite.ViewDate' else 'RC.ViewDate' end+','+    
	case when @Proceed=1 then 'RC.DeadLineDate ' else  'RC.Deadlinedate  ' end+' DeadLineDate ,'+  
	case when @Proceed=1 then 'ISNULL(ChildRecommite.Paraph,RC.Paraph) '   else ''' ''' end +' ChildParaph ,'+  
	case when @Proceed=1 then 'isnull(RecommitedOrg.Title,isnull(isnull(FO.Title,foo.title),TTO.title)) '   else ' isnull(isnull(FO.Title,foo.title),TTO.title) ' end +' ChildOrg , '+        
	case when @Proceed=1 then ' case when rc.ActionTypeID=5 then 5 else ChildRecommite.ActionTypeID end '  else  ' RC.ActionTypeID'   end +' ActionTypeID   
	'+       
      
	', (dbo.FN_GetUserRecomCount('+CAST(@OrgID as varchar)+', l.LetterID)) as UserRecomCount  ' +      
	' , RC.IsAnswer , RC.ISFollowup , RC.Erja_Or_Answer_Date, ''White'' ColorFlag ' + 
	', (Case when dbo.FN_GetUserRecomCount('+CAST(@OrgID as varchar)+', l.LetterID) > 1 then L.Memo + cast(dbo.FN_GetUserRecomCount('+CAST(@OrgID as varchar)+', l.LetterID) as varchar) else L.Memo end) as MemoAndRecomUserCount 
	, dbo.Has_Sign(l.letterid) AS Has_Sign
	, ROW_NUMBER() OVER (
      PARTITION BY l.LetterID, l.Letter_Type 
      ORDER BY l.LetterID, l.Letter_Type, PRC.OrgID Desc 
   ) row_num '  + 
	' FROM ReCommites RC        
	INNER JOIN Letter L ON RC.LetterID = L.LetterID        
	left JOIN Secretariats  ON Secretariats.Secid = L.SecretariatID
	LEFT JOIN LetterTypes ON L.Letter_Type=LetterTypes.ID        
	left JOIN ReCommites PRC ON RC.LetterID = PRC.LetterID AND PRC.ID = RC.ParentId  AND PRC.type = RC.type
	left join ReCommites rRC ON RrC.LetterID = l.LetterID AND rRC.Id=1 AND rrc.type<>1
	left JOIN FromOrganizations FoO ON FoO.ID = rRC.OrgID and rrc.orgid <> '+CAST(@OrgID as varchar)+'      
	left JOIN FromOrganizations FO ON FO.ID = PRC.OrgID        
	left JOIN FromOrganizations TTO ON TTO.ID = L.ToOrgID         
	left JOIN FromOrganizations Receiver ON Receiver.ID = L.FromOrgID         
	INNER JOIN RecommiteTypes ON RC.Type = RecommiteTypes.ID '+        
	case when @Proceed=1 then '        
	left JOIN ReCommites ChildRecommite ON RC.LetterID = ChildRecommite.LetterID AND RC.ID = ChildRecommite.ParentId  AND ChildRecommite.type =   
	RC.type         
	left JOIN FromOrganizations RecommitedOrg ON RecommitedOrg.ID = ChildRecommite.OrgID '        
	else '' end        
        
			
	if @archiveFolderID<>0          
	set @sql=@sql+'         
	Left join LetterArchiveFolder on LetterArchiveFolder.Letterid=Rc.RecommiteID 
	Left join ArchiveFolder a on a.FolderID=ArchiveFolderID '        
    
	if @DeadLine=1--تا فردا          
	set @rw=@rw+'  AND RC.DeadLineDate is not null AND dbo.ShamsiToInt(RC.DeadLineDate)-'+str(@todayToint) +'=1'
	if @DeadLine=0--تا امروز
	set @rw=@rw+' AND RC.DeadLineDate is not null AND dbo.ShamsiToInt(RC.DeadLineDate)-'+str(@todayToint) +'=0'
	if @DeadLine=-1
	set @rw=@rw+' AND RC.DeadLineDate is not null AND dbo.ShamsiToInt(RC.DeadLineDate)-'+str(@todayToint)+'<0 '      
	 if @DeadLine>1--تا آخر هفته
	 set @rw=@rw+' AND RC.DeadLineDate is not null AND dbo.ShamsiToInt(RC.DeadLineDate)-'+str(@todayToint) +' >1'

	set @sql=@sql+@rW        
        
	set @where=isnull(ltrim(rtrim(@where)),'')        
	if (@where<>'')         
	select @sql=@sql+' and '+@where ;       
        

	if isnull(ltrim(@orderClause),'')=''         
	 set @orderClause=' rc.lastupdate desc,l.indicatorid desc'        

										

	set @sql=@sql+' order by  '+@orderClause
	
	--SELECT LEN(@sql)
	PRINT @sql
	truncate table [dbo].[TempInbox]
	INSERT INTO [dbo].[TempInbox]
	EXEC(@sql)

	UPDATE [dbo].[TempInbox] 
	SET ColorFlag = 'GREEN'
	WHERE (LEN(LTRIM(RTRIM(DeadLineDate)))>0) AND
		  (
	  		((Erja_Or_Answer_Date IS NOT NULL) AND (Erja_Or_Answer_Date<=DeadLineDate)) 
	  			OR
	  		((Erja_Or_Answer_Date IS NULL ) AND (@DayOfNow<=DeadLineDate)) 
		  ) 		  

	UPDATE [dbo].[TempInbox]
	SET ColorFlag = 'RED'
	WHERE (LEN(LTRIM(RTRIM(DeadLineDate)))>0) AND
		  ( 	 
			((Erja_Or_Answer_Date IS NOT NULL) AND (Erja_Or_Answer_Date>DeadLineDate))
		  ) 	

	UPDATE [dbo].[TempInbox]
	SET ColorFlag = 'RED'
	WHERE (LEN(LTRIM(RTRIM(DeadLineDate)))>0) AND
		  (
			((Erja_Or_Answer_Date IS NULL) AND (@DayOfNow>DeadLineDate))
		  )	

	IF @ArchiveFolderID>0
	BEGIN
	delete from [TempInbox] where MyTmp_ID not in 
					   ( select min(MyTmp_ID) 
						 from [TempInbox] group by LetterID,IndicatorID,MYear)
	END	

	Delete [dbo].[TempInbox] Where row_num > 1

	SELECT * FROM [dbo].[TempInbox]

	
END


[END_S_NO]

[BEGIN_S_NO]=7


ALTER  procedure [dbo].[web_Insert_LetterData]
	(@LetterDataID 	[int] output,
	 @LetterID 	[int],
	 @PageNumber 	[tinyint],
	 @extention 	[tinyint],
	 @description [nvarchar](200)='',
	 @image [image] = null,
	 @FileName [nvarchar](100),
	 @IsTemplate [bit])

AS INSERT INTO [dbo].[LetterData] 
	 (  [LetterID],
	 [PageNumber],
	 [extention],
	 [image],
	 [description],
	 [FileName],
	 [IsTemplate]) 
 
VALUES 
	( @LetterID,
	 @PageNumber,
	 @extention,
	 @image,
	 @description,
	 @FileName,
	 @IsTemplate)

set  @LetterDataID=SCOPE_IDENTITY()

[END_S_NO]


[BEGIN_S_NO]=8
--مقدم

ALTER  procedure [dbo].[Sp_WebInbox]
	@SecretariatID int,  
	@LetterFormat tinyint,  
	@OrgID int,  
	@Proceeded bit,  
	@Type tinyint,
	@myear int,
	@date tinyint,
	@ArchiveFolderID int ,
	@where nvarchar(1000),  
	@userID int,
	@Letter_Type int,
	@DeadLine int,
	@orderClause varchar(50)=' rc.lastupdate desc,l.indicatorid desc',  
	@top int=100,
	@DayOfNow CHAR(10),
	@WebOrWin VARCHAR(50)=null  
AS  
BEGIN
	--	last modifier xax 1398/03/09

	declare        
		@sql nvarchar (4000),        
		@rw nvarchar(2000),        
		@Today char(10),        
		@Proceed bit, -- @Proceed  
		@todayToint varchar(10),    
		@Mytoday Nvarchar(10)  

SET @WebOrWin=UPPER(LTRIM(RTRIM(ISNULL(@WebOrWin,'Web'))))
	IF @Mytoday='WEB' SELECT @Mytoday=dbo.Shamsi(getdate())

	if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[TempInbox]') )
	drop table [dbo].[TempInbox]

	CREATE TABLE [dbo].[TempInbox]
	( 
	MyTmp_ID INT IDENTITY(1,1) NOT NULL,	
	LetterID INT,
	SignerID NVARCHAR(1000), 
	IndicatorID INT, 
	MYear int,
	subjectid INT, 
	SecretariatID INT, 
	Letter_Type INT,   
	letterformat INT, 
	IncommingNO NVARCHAR(1000), 
	Incommingdate NVARCHAR(100),   
	ClassificationID INT,        
	UrgencyID INT, 
	Memo NVARCHAR(4000), 
	Tostaffer NVARCHAR(4000),
	SentLetterID INT,
	AttachTitle NVARCHAR(1000), 
	NumberOfAttachPages INT, 
	NumberOfPage INT, 
	ReceiveTypeID INT, 
	UserID INT, 
	RetroactionNo NVARCHAR(100),   
	UserMemo NVARCHAR(1000), 
	RegistrationDate CHAR(100),        
	toorgid INT,
	fromorgid INT,
	FollowLetterNo NVARCHAR(1000), 
	LetterRecommites NVARCHAR(1000),
	finalized BIT,
	CenterNo NVARCHAR(100),
	CenterDate CHAR(100),
	templateID INT,
	headerID INT,        
	registrationTime VARCHAR(100),
	fromstaffer NVARCHAR(4000),
	sendStatusID INT,
	LastUpdate DATETIME,
	UserTableID INT,        
	InnerNo NVARCHAR(1000), 
	OrgID INT,  
	ParentId smallINT,
	Paraph NVARCHAR(4000), 
	RecommiteDate VARCHAR(100),  
	Proceeded BIT,        
	ProceedDate VARCHAR(100), 
	ReType smallINT,
	RecommitTypeTitle NVARCHAR(1000),        
	IsInner INT,
	RecommiterTitle NVARCHAR(1000),
	sendertitle NVARCHAR(1000),
	recommiteid INT,        
	id smallINT, 
	isSecure BIT,   
	StaffMemo NVARCHAR(4000), 
	Yincommingno NVARCHAR(1000),
	PreCode NVARCHAR(100),
	IsCopy BIT,
	IsCopy_In_Dabir BIT,
	SentToDabir BIT,
	has_Page BIT,        
	has_WordPage BIT,
	has_UncheckedFollowUp BIT,
	has_ExpiredFollowUp BIT,
	LetterDataId INT,
	has_file BIT,
	DeadLineDays INT,
	ViewDate CHAR(100),
	DeadLineDate CHAR(100),
	ChildParaph VARCHAR(3000),
	ChildOrg VARCHAR(1000),  
	ActionTypeID INT, 
	UserRecomCount INT, 
	IsAnswer BIT, 
	ISFollowup BIT,
	Erja_Or_Answer_Date CHAR(10),
	ColorFlag VARCHAR(50),
	MemoAndRecomUserCount VARCHAR(4000),
	has_Sign BIT,
	row_num int
	)
	-------------------++++++++++++++++++++++++++++-------------------------------------
	-------------------+++++++++++++++++++++++++-------------------------------------      
	select @today=dbo.shamsi(getdate())        
        
	set @Proceed=@Proceeded  
	DECLARE @InnerNo NVARCHAR(500);  
	IF @WebOrWin=UPPER('WIN')  
		set @InnerNo=dbo.InnerNoFormat('TTO','Receiver',@SecretariatID)
	ELSE	   
		set @InnerNo=dbo.InnerNoFormat('TTO','Receiver',-1)
	/*
	xax.98.03.06
	set @RW='WHERE   (RC.Finallized=1) and (Rc.OrgID = '+cast(@OrgID as varchar(10))+')'
	xax.98.03.06
	*/
	set @RW='WHERE   (RC.Finallized=1) '

	SET @InnerNo = REPLACE(@InnerNo, 'Letter.SubjectID', 'l.SubjectID')

	IF  @ArchiveFolderID = 0
		SET @rw = @RW + ' AND (Rc.Proceeded = '+cast(@Proceeded as varchar(2))+')'  

	if @myear>0  set @rw=@rw+'  and  L.myear='+cast(@myear as varchar(10))        
  
	if @LetterFormat>0 set @rw=@rw+' and (l.LetterFormat ='+cast( @LetterFormat as varchar(2))+')'        
	--else set @rw=@rw+' and (l.LetterFormat in (0,1,2))'        
        
	if @letter_Type>0        
	set @rw=@rw+' AND (l.letter_Type = '+cast(@Letter_Type as varchar(3))+')'        
        
	if @type>0        
		  set @rw=@rw+' AND (Rc.Type = '+cast(@Type as varchar(2))+')'        
      
	if @ArchiveFolderID>0
	begin
		if exists (select * from ArchiveFolder where UserID=@userID and FolderID=@ArchiveFolderID and ParentFolderID =0)
			begin
			set @rw=@rw+' AND (ParentFolderID = '+cast(@ArchiveFolderID as varchar(10))+')'        
			end
		else
			begin
			set @rw=@rw+' AND (ArchiveFolderID = '+cast(@ArchiveFolderID as varchar(10))+')'        
			end
	end

	if @date<>0        
	begin        
	 declare @dw tinyint,@bdate char(10),@edate char(10)        
	  set @dw=datepart(dw,Getdate())    
	--Ranjbar    
	  ---select @bdate=begindate,@edate=Enddate from HistoryDateList(@today ,@dw) where id=@date     
	  Set @Mytoday = Cast(1300+@myear as nvarchar)+ Substring(@Today,5,6)    
	  select @bdate=begindate,@edate=Enddate from HistoryDateList(@Mytoday ,@dw) where id=@date     
	--//    
        
	 set @rw=@rw+' AND (RC.RecommiteDate between '''+@bdate+''' and '''+@edate+''')'        
	end        
        
	if @SecretariatID>0        
	set @rw=@rw+' AND (SecretariatID = '+cast(@SecretariatID as varchar(10))+')'        
	else        
	set @rw=@rw+' AND (SecretariatID in (SELECT SecId FROM UserSecretariats WHERE UserId = '+cast(@userid as varchar(5))+'))'        
        
	set @todayToint=cast(dbo.ShamsiToInt(@today) as varchar(10))        
        
	--if @DeadLine between -1 and 30        
	-- set @rw=@rw+' AND ('+        
	--case when @Proceed=1 then 'case when RC.Proceeded=0 then ISNULL(ChildRecommite.DeadLineToint,'+@todayToint+') else    
	--'''+@todayToint+''' end '        
	--else  'ISNULL(RC.DeadLineToint ,'+@todayToint+') ' end+' -'+@todayToint+' )<= '+cast(@DeadLine as varchar(5))        
        
	set @sql='SELECT top '+cast(@top as varchar(5))+' L.LetterID,L.SignerID, L.IndicatorID, L.MYear,l.subjectid, L.SecretariatID, L.Letter_Type,   
	L.letterformat, L.IncommingNO, L.Incommingdate,   
	L.ClassificationID,        
	L.UrgencyID, L.Memo, 
	(case when  l.Letter_Type=1 then l.fromstaffer else L.Tostaffer end ) as Tostaffer,
	l.SentLetterID,L.AttachTitle, L.NumberOfAttachPages, L.NumberOfPage, L.ReceiveTypeID, L.UserID, L.RetroactionNo,   
	L.UserMemo, L.RegistrationDate,        
	l.toorgid,l.fromorgid,L.FollowLetterNo, L.LetterRecommites,l.finalized,l.CenterNo,l.CenterDate,l.templateID,l.headerID,        
	l.registrationTime,
	(case when  l.Letter_Type=1 then l.Tostaffer else l.fromstaffer end ) as fromstaffer,
	l.sendStatusID,L.LastUpdate,L.UserTableID,        
	'+@InnerNo+' InnerNo, PRC.OrgID,  RC.ParentId,  RC.Paraph, RC.RecommiteDate,  RC.Proceeded,        
	 RC.ProceedDate, RecommiteTypes.id ReType,RecommiteTypes.Title RecommitTypeTitle,        
	case when fo.title is null then 0 else 1 end IsInner, 
	(case when  l.Letter_Type=1 then tto.title else isnull(isnull(FO.Title,foo.title),TTO.title) end ) as RecommiterTitle,
	(case when  l.Letter_Type=1 then isnull(isnull(FO.Title,foo.title),TTO.title) else tto.title end ) as sendertitle,
	rc.recommiteid,        
	 rc.id,  rc.IsSecure,  
	RC.StaffMemo,  
	isnull(incommingno,indicatorid)  Yincommingno,Secretariats.PreCode,RC.IsCopy,RC.IsCopy_In_Dabir,RC.SentToDabir      
	,dbo.has_Page(l.letterid) has_Page,        
	dbo.has_WordPage(l.letterid) has_WordPage,
	dbo.has_UncheckedFollowUp(l.letterid)  has_UncheckedFollowUp,
	dbo.has_ExpiredFollowUp(l.letterid) has_ExpiredFollowUp,
	(select LetterDataID from LetterData where LetterData.LetterID=l.letterid and LetterData.extention IN(3, 9) and IsTemplate = 1) as LetterDataId,       
	dbo.has_file(l.letterid) has_file, '+        
	'isnull('+        
	case when @Proceed=1 then 'RC.DeadLineToint' else 'RC.DeadLineToint' end+'-'+@todayToint+',0) DeadLineDays,'+  
	case when @Proceed=1 then 'ChildRecommite.ViewDate' else 'RC.ViewDate' end+','+    
	case when @Proceed=1 then 'RC.DeadLineDate ' else  'RC.Deadlinedate  ' end+' DeadLineDate ,'+  
	case when @Proceed=1 then 'ISNULL(ChildRecommite.Paraph,RC.Paraph) '   else ''' ''' end +' ChildParaph ,'+  
	case when @Proceed=1 then 'isnull(RecommitedOrg.Title,isnull(isnull(FO.Title,foo.title),TTO.title)) '   else ' isnull(isnull(FO.Title,foo.title),TTO.title) ' end +' ChildOrg , '+        
	case when @Proceed=1 then ' case when rc.ActionTypeID=5 then 5 else ChildRecommite.ActionTypeID end '  else  ' RC.ActionTypeID'   end +' ActionTypeID   
	'+       
      
	', (dbo.FN_GetUserRecomCount('+CAST(@OrgID as varchar)+', l.LetterID)) as UserRecomCount  ' +      
	' , RC.IsAnswer , RC.ISFollowup , RC.Erja_Or_Answer_Date, ''White'' ColorFlag ' + 
	', (Case when dbo.FN_GetUserRecomCount('+CAST(@OrgID as varchar)+', l.LetterID) > 1 then L.Memo + cast(dbo.FN_GetUserRecomCount('+CAST(@OrgID as varchar)+', l.LetterID) as varchar) else L.Memo end) as MemoAndRecomUserCount 
	, dbo.Has_Sign(l.letterid) AS Has_Sign
	, ROW_NUMBER() OVER (
      PARTITION BY l.LetterID, l.Letter_Type 
      ORDER BY l.LetterID, l.Letter_Type, PRC.OrgID Desc 
   ) row_num '  + 
	' FROM ReCommites RC        
	INNER JOIN Letter L ON RC.LetterID = L.LetterID        
	left JOIN Secretariats  ON Secretariats.Secid = L.SecretariatID
	LEFT JOIN LetterTypes ON L.Letter_Type=LetterTypes.ID        
	left JOIN ReCommites PRC ON RC.LetterID = PRC.LetterID AND PRC.ID = RC.ParentId  AND PRC.type = RC.type
	left join ReCommites rRC ON RrC.LetterID = l.LetterID AND rRC.Id=1 AND rrc.type<>1
	left JOIN FromOrganizations FoO ON FoO.ID = rRC.OrgID and rrc.orgid <> '+CAST(@OrgID as varchar)+'      
	left JOIN FromOrganizations FO ON FO.ID = PRC.OrgID        
	left JOIN FromOrganizations TTO ON TTO.ID = L.ToOrgID         
	left JOIN FromOrganizations Receiver ON Receiver.ID = L.FromOrgID         
	INNER JOIN RecommiteTypes ON RC.Type = RecommiteTypes.ID '+        
	case when @Proceed=1 then '        
	left JOIN ReCommites ChildRecommite ON RC.LetterID = ChildRecommite.LetterID AND RC.ID = ChildRecommite.ParentId  AND ChildRecommite.type =   
	RC.type         
	left JOIN FromOrganizations RecommitedOrg ON RecommitedOrg.ID = ChildRecommite.OrgID '        
	else '' end        
        
	if @archiveFolderID<>0          
	set @sql=@sql+'         
	Left join LetterArchiveFolder on LetterArchiveFolder.Letterid=Rc.RecommiteID 
	Left join ArchiveFolder a on a.FolderID=ArchiveFolderID '        
    
	if @DeadLine=1--تا فردا          
	set @rw=@rw+'  AND RC.DeadLineDate is not null AND dbo.ShamsiToInt(RC.DeadLineDate)-'+str(@todayToint) +'=1'
	if @DeadLine=0--تا امروز
	set @rw=@rw+' AND RC.DeadLineDate is not null AND dbo.ShamsiToInt(RC.DeadLineDate)-'+str(@todayToint) +'=0'
	if @DeadLine=-1
	set @rw=@rw+' AND RC.DeadLineDate is not null AND dbo.ShamsiToInt(RC.DeadLineDate)-'+str(@todayToint)+'<0 '      
	 if @DeadLine>1--تا آخر هفته
	 set @rw=@rw+' AND RC.DeadLineDate is not null AND dbo.ShamsiToInt(RC.DeadLineDate)-'+str(@todayToint) +' >1'

	set @sql=@sql+@rW        
        
	set @where=isnull(ltrim(rtrim(@where)),'')        
	if (@where<>'')         
	select @sql=@sql+' and '+@where ;       
        
	if isnull(ltrim(@orderClause),'')=''         
	 set @orderClause=' rc.lastupdate desc,l.indicatorid desc'        

	set @sql=@sql+' order by  '+@orderClause
	
	--SELECT LEN(@sql)
	PRINT @sql
	truncate table [dbo].[TempInbox]
	INSERT INTO [dbo].[TempInbox]
	EXEC(@sql)

	UPDATE [dbo].[TempInbox] 
	SET ColorFlag = 'GREEN'
	WHERE (LEN(LTRIM(RTRIM(DeadLineDate)))>0) AND
		  (
	  		((Erja_Or_Answer_Date IS NOT NULL) AND (Erja_Or_Answer_Date<=DeadLineDate)) 
	  			OR
	  		((Erja_Or_Answer_Date IS NULL ) AND (@DayOfNow<=DeadLineDate)) 
		  ) 		  

	UPDATE [dbo].[TempInbox]
	SET ColorFlag = 'RED'
	WHERE (LEN(LTRIM(RTRIM(DeadLineDate)))>0) AND
		  ( 	 
			((Erja_Or_Answer_Date IS NOT NULL) AND (Erja_Or_Answer_Date>DeadLineDate))
		  ) 	

	UPDATE [dbo].[TempInbox]
	SET ColorFlag = 'RED'
	WHERE (LEN(LTRIM(RTRIM(DeadLineDate)))>0) AND
		  (
			((Erja_Or_Answer_Date IS NULL) AND (@DayOfNow>DeadLineDate))
		  )	

	IF @ArchiveFolderID>0
	BEGIN
	delete from [TempInbox] where MyTmp_ID not in 
					   ( select min(MyTmp_ID) 
						 from [TempInbox] group by LetterID,IndicatorID,MYear)
	END	

	Delete [dbo].[TempInbox] Where row_num > 1

	SELECT * FROM [dbo].[TempInbox]

END

[END_S_NO]

[BEGIN_S_NO]=9

ALTER PROCEDURE [dbo].[Get_All_Letter]  
    @SecretariatID int,                  
    @Myear int,                  
    @Letter_Type int,                  
    @LetterFormat int,                  
    @Where nvarchar(4000),                  
    @Top int,                  
    @ArchiveFolderID int,                  
    @ArchiveStatus tinyint ,-- 0 ,1 and 2(= all)               
    @UserID int 
	
    As 
    
	 
    IF ISNULL(LTRIM(RTRIM(@where)),'')=''
    BEGIN
		DECLARE @DO_ CHAR(10) SET @DO_ = dbo.ATF_PEY_SETTING ('ATF-PEY')
    END

    DECLARE @SqlCommand nvarchar(max),@InnerNo NVARCHAR(500)
                                     
    IF OBJECT_ID('tempdb..#s') IS NOT NULL 
		DROP TABLE #s   
                
    Set @InnerNo=dbo.InnerNoFormat('Sender','Deliver',@SecretariatID)     

    IF OBJECT_ID('tempdb..#s') IS NOT NULL 
		DROP TABLE #s
    
	CREATE TABLE #s
    (
    PEY2 NVARCHAR(200),
    ATF2 NVARCHAR(200),
    PEY NVARCHAR(100),
    ATF NVARCHAR(100),
    LetterID INT,   
    CenterNo NVARCHAR(50),                                          
    IndicatorID INT,
    MYear INT,
    SecretariatID INT,
    Letter_Type INT,
    letterformat INT,
    IncommingNO NVARCHAR(50),                                       
    FromOrgID INT,  
    IncommingDate NVARCHAR(10),
    ToOrgID INT,    
    UrgencyID INT,  
    Memo NVARCHAR(4000),                                                                                                                                                                                                                                                           
    RetroactionNo NVARCHAR(1000),                                     
    RegistrationDate CHAR(10),
    FollowLetterNo NVARCHAR(1000),                                    
    ToStaffer NVARCHAR(50),                                         
    SentLetterID INT,
    TemplateID  INT,
    UserMemo  NVARCHAR(1000),                                                                                                                                                                                                                                                      
    DeadLineDate CHAR(10),
    SenderTitle NVARCHAR(100),                                                                                         
    DeliverTitle NVARCHAR(100),                                                                                        
    has_Page BIT,
    has_WordPage BIT,
    has_file BIT,
    SubjectID INT,  
    LetterTypeTitle NVARCHAR(50),                                    
    LetterRecommites NVARCHAR(4000),                                                                                                                                                                                                                                                
    sendstatusTitle  NVARCHAR(100),                                                                                    
    InnerNo VARCHAR(500),
    InnerNoForWord VARCHAR(500),
    Archived BIT,
    ActionTypeTitle NVARCHAR(50),                                   
    SignerID NVARCHAR(200),                                           
    SignerTitle NVARCHAR(100),                                                                                         
    ReceiveTypeID INT,
    ClassificationID INT,
    ArchivePlace NVARCHAR(500),
    SubjectDescription NVARCHAR(4000),
    has_sign BIT ,   
    HasLetterForms BIT,
    FolderID INT,
    ArchivecenterID INT,
	SecretariatTitle  NVARCHAR(100),
	EmailFromDateTime Nvarchar(20),
	EmailFrom nvarchar(1000),
	EmailSubject nvarchar(2000),
	IsNetWork bit
			  
    )

	IF @ArchiveStatus = 0
	BEGIN
		IF isnull(ltrim(rtrim(@where)),'')=''
		BEGIN
			INSERT INTO #s
			(
				PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,
				ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,
				DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,
				ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			)
			SELECT DISTINCT top (@Top)
					PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,              
					Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,'-' AS RetroactionNo,Letter.RegistrationDate,'-' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,                  
					Deliver.Title AS DeliverTitle,
					case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page, 
					dbo.has_WordPage(letter.LetterID) AS has_WordPage, 
					dbo.has_file(letter.LetterID) AS has_File,
																																	
					 Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,
					 at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,
					(SELECT top (1)  a.Title FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,
					Letter.SubjectDescription,dbo.has_sign(Letter.letterID) as has_sign ,dbo.HasLetterForms(Letter.Letterid) HasLetterForms,
					(SELECT top (1)  a.FolderID 
					FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b 
					ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS FolderID,
					Secretariats.SecTitle as SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			FROM Letter
			INNER JOIN sendstatus AS ss on ss.sendstatusID=Letter.sendstatusID
			INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID
			LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID
			LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID
			LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type
			LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID
			WHERE Letter.Finalized=1 AND Letter.Archived=0 AND
				  ((Letter_Type=@Letter_Type) OR (@Letter_Type=0)) AND
				  ((Secretariatid=@SecretariatID) OR (@SecretariatID<=0)) AND
				  ((myear=@Myear) OR (@Myear<=0)) AND
				  ((Letter.LetterFormat=@LetterFormat) OR (@LetterFormat<=0))AND
				  (letter.LetterID>=(SELECT ISNULL(MAX(letterID)-10000,0) FROM Letter))	
			order by myear desc,letter.IndicatorID DESC,letter.letterid desc
					
		END
		ELSE
		BEGIN
			Set @sqlCommand='DECLARE @DO_ CHAR(10) SET @DO_ = dbo.ATF_PEY_SETTING (''ATF-PEY'')'+
			' INSERT INTO #s'+
			'('+
				'PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,'+
				'ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,'+
				'DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,'+
				'ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			 ' )'+
			' SELECT DISTINCT top ('+CAST(@Top as varchar)+')' + 
					' PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,'+              
					'Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,''-'' AS RetroactionNo,Letter.RegistrationDate,''-'' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,'+                  
					'Deliver.Title AS DeliverTitle,'+
					' case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page,'+
					' dbo.has_WordPage(letter.LetterID) AS has_WordPage, '+
					' dbo.has_file(letter.LetterID) AS has_File,'+
																																		
					 'Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,'+
					 'at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,'+
					' (SELECT top (1)  a.Title FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,'+
					'Letter.SubjectDescription,dbo.has_sign(Letter.letterID) as has_sign ,
					dbo.HasLetterForms(Letter.Letterid) HasLetterForms,'+
					' (SELECT top (1)  a.FolderID FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b 
					ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS FolderID,Secretariats.SecTitle SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			' FROM Letter 
			INNER JOIN sendstatus AS ss on ss.sendstatusID=Letter.sendstatusID 
			INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID'+
			' LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID'+
			' LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type'+
			' LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID'+
			' WHERE Letter.Finalized=1 AND Letter.Archived=0 AND '+
				  '((Letter_Type='+CAST(@Letter_Type AS VARCHAR(5))+') OR ('+CAST(@Letter_Type AS VARCHAR(5))+'=0)) AND '+
				  '((Secretariatid='+CAST(@SecretariatID AS VARCHAR(5))+') OR ('+CAST(@SecretariatID AS VARCHAR(5))+'<=0)) AND '+
				  '((myear='+CAST(@Myear AS VARCHAR(5))+') OR ('+CAST(@Myear AS VARCHAR(5))+'<=0)) AND '+
				  '((Letter.LetterFormat='+CAST(@LetterFormat AS VARCHAR(5))+') OR ('+CAST(@LetterFormat AS VARCHAR(55))+'<=0))'+
				  ' And ' + @where + ' order by myear desc,letter.IndicatorID DESC,letter.letterid desc'
			
			Exec Sp_ExecuteSql   @sqlCommand
		END
		
		IF @ArchiveFolderID>0
		BEGIN
			DELETE FROM #s WHERE ISNULL(FolderID,0)!=@ArchiveFolderID
		END

	END
	ELSE
	IF @ArchiveStatus=1
	BEGIN
		IF isnull(ltrim(rtrim(@where)),'')=''
		BEGIN
			INSERT INTO #s
			(
				PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,
				ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,
				DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,
				ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			)
			SELECT DISTINCT top (@Top)
					PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,              
					Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,'-' AS RetroactionNo,Letter.RegistrationDate,'-' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,                  
					Deliver.Title AS DeliverTitle,
					case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page, 
					dbo.has_WordPage(letter.LetterID) AS has_WordPage, 
					dbo.has_file(letter.LetterID) AS has_File,
																																	
					 Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,
					 at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,
					(SELECT top (1)  a.Title FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,
					Letter.SubjectDescription,dbo.has_sign(Letter.letterID) as has_sign ,dbo.HasLetterForms(Letter.Letterid) HasLetterForms,
					(SELECT top (1)  a.FolderID FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID 
					AND b.LetterID=Letter.LetterID) AS FolderID,Secretariats.SecTitle as SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			FROM Letter
			INNER JOIN sendstatus AS ss on ss.sendstatusID=Letter.sendstatusID
			INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID
			LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID
			LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID
			LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type
			LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID
			WHERE Letter.Finalized=1 AND Letter.Archived=1 AND
				  ((Letter_Type=@Letter_Type) OR (@Letter_Type=0)) AND
				  ((Secretariatid=@SecretariatID) OR (@SecretariatID<=0)) AND
				  ((myear=@Myear) OR (@Myear<=0)) AND
				  ((Letter.LetterFormat=@LetterFormat) OR (@LetterFormat<=0))AND
				  (letter.LetterID>=(SELECT ISNULL(MAX(letterID)-10000,0) FROM Letter))
			order by myear desc,letter.IndicatorID DESC,letter.letterid desc
		END
		ELSE
		BEGIN
			Set @sqlCommand='DECLARE @DO_ CHAR(10) SET @DO_ = dbo.ATF_PEY_SETTING (''ATF-PEY'')'+
			' INSERT INTO #s'+
			'('+
				'PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,'+
				'ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,'+
				'DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,'+
				'ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			')'+
			' SELECT DISTINCT top ('+CAST(@Top as varchar)+')' + 
					' PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,'+
					' Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,''-'' AS RetroactionNo,Letter.RegistrationDate,''-'' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,'+
					'Deliver.Title AS DeliverTitle,'+
					' case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page,'+
					' dbo.has_WordPage(letter.LetterID) AS has_WordPage, '+
					' dbo.has_file(letter.LetterID) AS has_File,'+
																																		
					 'Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,'+
					 'at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,'+
					'(SELECT top (1)  a.Title FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,'+
					'Letter.SubjectDescription,dbo.has_sign(Letter.letterID) as has_sign ,dbo.HasLetterForms(Letter.Letterid) HasLetterForms,
					'+
					'(SELECT top (1)  a.FolderID FROM ArchiveFolder AS a 
					INNER JOIN LetterArchiveFolder AS b 
					ON a.FolderID=b.ArchiveFolderID 
					AND b.LetterID=Letter.LetterID) AS FolderID,Secretariats.SecTitle SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			' 
			 FROM Letter 
			  INNER JOIN sendstatus AS ss
			   on ss.sendstatusID=Letter.sendstatusID 
			   INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID
			  LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID'+
			' LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID'+
			' LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type'+
			' LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID'+
			' WHERE Letter.Finalized=1 AND Letter.Archived=1 AND '+
				  ' ((Letter_Type='+CAST(@Letter_Type AS VARCHAR(5))+') OR ('+CAST(@Letter_Type AS VARCHAR(5))+'=0)) AND '+
				  ' ((Secretariatid='+CAST(@SecretariatID AS VARCHAR(5))+') OR ('+CAST(@SecretariatID AS VARCHAR(5))+'<=0)) AND '+
				  ' ((myear='+CAST(@Myear AS VARCHAR(5))+') OR ('+CAST(@Myear AS VARCHAR(5))+'<=0)) AND '+
				  ' ((Letter.LetterFormat='+CAST(@LetterFormat AS VARCHAR(5))+') OR ('+CAST(@LetterFormat AS VARCHAR(5))+'<=0))'+
				  ' And ' + @where + ' order by myear desc,letter.IndicatorID DESC,letter.letterid desc'

			Exec Sp_ExecuteSql   @sqlCommand
		END	 
		 
		IF @ArchiveFolderID>0
		BEGIN
			DELETE FROM #s WHERE ISNULL(FolderID,0)!=@ArchiveFolderID
		END
		
		DELETE FROM #s WHERE LetterID NOT IN 
		(
			SELECT s.LetterID FROM #s AS s
			INNER JOIN Letter L ON s.LetterID=L.LetterID
			INNER JOIN LetterArchiveFolder laf ON laf.Letterid = L.letterid And L.LetterID = s.LetterID
			INNER JOIN Archivefolder af  on laf.ArchiveFolderID = af.FolderID              
			INNER JOIN UserAccArchive uac on uac.ArchiveFolderID = af.FolderID and uac.secid=L.SecretariatID
			WHERE ISNULL(uac.UserID, CAST(@userid as varchar(10)))= CAST(@userid as varchar(10)) And ISNULL(uac.ISAccess,1)=1 		
		)
			  
	END
	ELSE
	IF @ArchiveStatus=2
	BEGIN
		IF isnull(ltrim(rtrim(@where)),'')=''
		BEGIN
			INSERT INTO #s
			(
				PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,
				ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,
				DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,
				ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,ArchivecenterID,
				SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			)
			SELECT DISTINCT top (@Top) 
					PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,              
					Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,'-' AS RetroactionNo,Letter.RegistrationDate,'-' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,                  
					Deliver.Title AS DeliverTitle,
					case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page, 
					dbo.has_WordPage(letter.LetterID) AS has_WordPage, 
					dbo.has_file(letter.LetterID) AS has_File,                  
																																					  
					 Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,
					 at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,
					(SELECT top (1) a.Title FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,
					Letter.SubjectDescription,dbo.has_sign(Letter.letterID) as has_sign ,dbo.HasLetterForms(Letter.Letterid) HasLetterForms,
					(SELECT top (1)  a.FolderID FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS FolderID,
					(SELECT top (1)  a.ArchiveCenterID FROM ArchiveFolder AS a 
					INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID 
					AND b.LetterID=Letter.LetterID) AS ArchiveCenterID,Secretariats.SecTitle as SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			FROM Letter
			INNER JOIN sendstatus AS ss on ss.sendstatusID=Letter.sendstatusID                  
			INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID                  
			LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID 
			LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID                  
			LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type
			LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID                  
			WHERE Letter.Finalized=1 AND Letter.Archived=1 AND
				  ((Letter_Type=@Letter_Type) OR (@Letter_Type=0)) AND
				  ((Secretariatid=@SecretariatID) OR (@SecretariatID<=0)) AND
				  ((myear=@Myear) OR (@Myear<=0)) AND
				  ((Letter.LetterFormat=@LetterFormat) OR (@LetterFormat<=0))AND
				  (letter.LetterID>=(SELECT ISNULL(MAX(letterID)-10000,0) FROM Letter))
			order by myear desc,letter.IndicatorID DESC,letter.letterid desc
		END
		ELSE
		BEGIN
			Set @sqlCommand='DECLARE @DO_ VarCHAR(10) SET @DO_=dbo.ATF_PEY_SETTING(''ATF-PEY'')'+
			' INSERT INTO #s'+
			'('+
				'PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,'+
				'ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,'+
				'DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,'+
				'ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,ArchivecenterID
				,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			')'+
			' SELECT DISTINCT top ('+CAST(@Top as varchar)+')' + 
					' PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,'+
					'Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,''-'' AS RetroactionNo,Letter.RegistrationDate,''-'' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,'+
					'Deliver.Title AS DeliverTitle,'+
					' case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page,'+
					' dbo.has_WordPage(letter.LetterID) AS has_WordPage,'+ 
					' dbo.has_file(letter.LetterID) AS has_File,'+
																																	 
					 'Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,'+
					 'at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,'+
					'(SELECT top (1)  a.Title FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,'+
					'Letter.SubjectDescription,
					dbo.has_sign(Letter.letterID) as has_sign ,
					dbo.HasLetterForms(Letter.Letterid) HasLetterForms,'+
					'(SELECT top (1)  a.FolderID FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS FolderID,'+
					'(SELECT a.ArchiveCenterID FROM ArchiveFolder AS a 
					INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID 
					AND b.LetterID=Letter.LetterID) AS ArchiveCenterID,Secretariats.SecTitle SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			' FROM Letter'+
			' INNER JOIN sendstatus AS ss on ss.sendstatusID=Letter.sendstatusID'+
			' INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID'+
			' LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID'+
			' LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID'+
			' LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type'+
			' LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID'+
			' WHERE Letter.Finalized=1 AND Letter.Archived=1 AND '+
				  '((Letter_Type='+CAST(@Letter_Type AS VARCHAR(5))+') OR ('+CAST(@Letter_Type AS VARCHAR(5))+'=0)) AND '+
				  '((Secretariatid='+CAST(@SecretariatID AS VARCHAR(5))+') OR ('+CAST(@SecretariatID AS VARCHAR(5))+'<=0)) AND '+
				  '((myear='+CAST(@Myear AS VARCHAR(5))+') OR ('+CAST(@Myear AS VARCHAR(5))+'<=0)) AND '+
				  '((Letter.LetterFormat='+CAST(@LetterFormat AS VARCHAR(5))+') OR ('+CAST(@LetterFormat AS VARCHAR(5))+'<=0))'+
				  ' And ' + @where + ' order by myear desc,letter.IndicatorID DESC,letter.letterid desc'
 
			Exec Sp_ExecuteSql   @sqlCommand
		END

		DELETE FROM #s WHERE ISNULL(FolderID,0)>0

		IF @ArchiveFolderID>0
		BEGIN
			DELETE FROM #s WHERE ISNULL(FolderID,0)!=@ArchiveFolderID
		END
	END
	ELSE
	BEGIN
		IF isnull(ltrim(rtrim(@where)),'')=''
		BEGIN
			INSERT INTO #s
			(
				PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,
				ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,
				DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,
				ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			)
			SELECT DISTINCT top (@Top)
					PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,              
					Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,'-' AS RetroactionNo,Letter.RegistrationDate,'-' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,                  
					Deliver.Title AS DeliverTitle,
					case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page, 
					dbo.has_WordPage(letter.LetterID) AS has_WordPage, 
					dbo.has_file(letter.LetterID) AS has_File,
																																	
					 Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,
					 at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,
					(SELECT top (1) a.Title FROM ArchiveFolder AS a INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,
					Letter.SubjectDescription,dbo.has_sign(Letter.letterID) as has_sign ,dbo.HasLetterForms(Letter.Letterid) HasLetterForms,
					(SELECT top (1) a.FolderID FROM ArchiveFolder AS a 
					INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID
					 AND b.LetterID=Letter.LetterID) AS FolderID,Secretariats.SecTitle as SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
			FROM Letter
			INNER JOIN sendstatus AS ss on ss.sendstatusID=Letter.sendstatusID
			INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID
			LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID
			LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID
			LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type
			LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID
			WHERE Letter.Finalized=1 AND
				  ((Letter_Type=@Letter_Type) OR (@Letter_Type=0)) AND
				  ((Secretariatid=@SecretariatID) OR (@SecretariatID<=0)) AND
				  ((myear=@Myear) OR (@Myear<=0)) AND
				  ((Letter.LetterFormat=@LetterFormat) OR (@LetterFormat<=0)) AND
				  (letter.LetterID>=(SELECT ISNULL(MAX(letterID)-10000,0) FROM Letter)) 
			order by myear desc,letter.IndicatorID DESC,letter.letterid desc
		END
		ELSE
		BEGIN
			Set @sqlCommand='DECLARE @DO_ CHAR(10) SET @DO_ = dbo.ATF_PEY_SETTING (''ATF-PEY'')'+
			' INSERT INTO #s'+
			' ( '+
				'PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,'+
				'ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,'+
				'DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,'+
				'ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			')'+
			' SELECT DISTINCT top ('+CAST(@Top as varchar)+')' + 
					' PEY2,ATF2,PEY,ATF,Letter.LetterID,Letter.CenterNo, Letter.IndicatorID, Letter.MYear, Letter.SecretariatID,Letter.Letter_Type, Letter.letterformat, Letter.IncommingNO , Letter.FromOrgID,Letter.IncommingDate,'+
					'Letter.ToOrgID, Letter.UrgencyID, Letter.Memo,''-'' AS RetroactionNo,Letter.RegistrationDate,''-'' AS FollowLetterNo,Letter.ToStaffer, Letter.SentLetterID, Letter.TemplateID, Letter.UserMemo,Letter.DeadLineDate, sender.Title AS SenderTitle,'+
					'Deliver.Title AS DeliverTitle,'+
					' case when exists(SELECT PageNumber FROM LetterData ld WHERE ld.LetterID=Letter.LetterID and extention in (1,2)) THEN 1 ELSE 0 END AS has_Page,'+
					' dbo.has_WordPage(letter.LetterID) AS has_WordPage, '+
					' dbo.has_file(letter.LetterID) AS has_File,'+
																																	   
					 'Letter.SubjectID, LetterTypes.Title LetterTypeTitle,Letter.LetterRecommites,ss.sendstatusTitle,dbo.InnerNo(Letter.LetterID,letter.letter_type),dbo.InnerNoForWord(Letter.LetterID),Letter.Archived,'+
					' at.ActionTypeTitle,Letter.SignerID, (Select Title from FromOrganizations FO Where(FO.ID = Letter.SignerID)) as SignerTitle,Letter.ReceiveTypeID ,Letter.ClassificationID,'+
					'(SELECT top (1)  a.Title FROM ArchiveFolder AS a 
					INNER JOIN LetterArchiveFolder AS b ON a.FolderID=b.ArchiveFolderID AND b.LetterID=Letter.LetterID) AS ArchivePlace,'+
					'Letter.SubjectDescription,dbo.has_sign(Letter.letterID) as has_sign ,
					dbo.HasLetterForms(Letter.Letterid) HasLetterForms,'+
					'(SELECT top (1)  a.FolderID FROM ArchiveFolder AS a 
					INNER JOIN LetterArchiveFolder AS b 
					ON a.FolderID=b.ArchiveFolderID 
					AND b.LetterID=Letter.LetterID) AS FolderID,Secretariats.SecTitle as SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork'+
			' FROM Letter 
			INNER JOIN sendstatus AS ss on ss.sendstatusID=Letter.sendstatusID INNER JOIN Secretariats on Secretariats.Secid=Letter.SecretariatID LEFT JOIN FromOrganizations sender ON Letter.ToOrgID = sender.ID'+
			' LEFT JOIN FromOrganizations Deliver ON Letter.FromOrgID = Deliver.ID'+
			' LEFT JOIN LetterTypes on LetterTypes.ID=Letter.Letter_type'+
			' LEFT JOIN ActionType AS at  ON at.ActionTypeID = Letter.LatestActionTypeID'+
			' WHERE Letter.Finalized=1 AND '+
				  '((Letter_Type='+CAST(@Letter_Type AS VARCHAR(5))+') OR ('+CAST(@Letter_Type AS VARCHAR(5))+'=0)) AND '+
				  '((Secretariatid='+CAST(@SecretariatID AS VARCHAR(5))+') OR ('+CAST(@SecretariatID AS VARCHAR(5))+'<=0)) AND '+
				 ' ((myear='+CAST(@Myear AS VARCHAR(5))+') OR ('+CAST(@Myear AS VARCHAR(5))+'<=0)) AND '+
				  '((Letter.LetterFormat='+CAST(@LetterFormat AS VARCHAR(5))+') OR ('+CAST(@LetterFormat AS VARCHAR(5))+'<=0))'+
				  ' And ' + @where + ' order by myear desc,letter.IndicatorID DESC,letter.letterid desc'


				  
			Exec Sp_ExecuteSql   @sqlCommand				  
		END
		IF @ArchiveFolderID>0
		BEGIN
			DELETE FROM #s WHERE ISNULL(FolderID,0)!=@ArchiveFolderID
		END
		
	END

    DECLARE @LID INT ,@ArchPlace VARCHAR(100),@AllArchPlace VARCHAR(400)
    DECLARE cr CURSOR FOR
    SELECT DISTINCT letterid FROM #s
    GROUP BY letterid
    HAVING COUNT(*)>1

    OPEN cr 

    FETCH NEXT FROM cr INTO @LID

    WHILE @@FETCH_STATUS = 0
    BEGIN
        SET @AllArchPlace=''    
            DECLARE crin CURSOR FOR         
            SELECT ArchivePlace FROM #s WHERE letterid=@LID    
            OPEN crin 
            FETCH NEXT FROM crin INTO @ArchPlace    
            WHILE @@FETCH_STATUS = 0
            BEGIN
                SET @AllArchPlace=@AllArchPlace+' , '+@ArchPlace
                FETCH NEXT FROM crin INTO @ArchPlace
            END
            CLOSE crin
            DEALLOCATE crin        
        UPDATE #s
        SET ArchivePlace=@AllArchPlace
        WHERE letterid=@LID AND ArchivePlace=@ArchPlace
        
        DELETE FROM #s WHERE letterid=@LID AND ArchivePlace<>@AllArchPlace 
        
        FETCH NEXT FROM cr INTO @LID
    END
    CLOSE cr
    DEALLOCATE cr

	SELECT 
			PEY2,ATF2,PEY,ATF,LetterID,CenterNo,IndicatorID,MYear,SecretariatID,Letter_Type,letterformat,IncommingNO,FromOrgID,IncommingDate,
		   ToOrgID,UrgencyID,Memo,RetroactionNo,RegistrationDate,FollowLetterNo,ToStaffer,SentLetterID,TemplateID,UserMemo,DeadLineDate,SenderTitle,
		   DeliverTitle,has_Page,has_WordPage,has_file,SubjectID,LetterTypeTitle,LetterRecommites,sendstatusTitle,InnerNo,InnerNoForWord,Archived,
		   ActionTypeTitle,SignerID,SignerTitle,ReceiveTypeID,ClassificationID,ArchivePlace,SubjectDescription,has_sign,HasLetterForms,FolderID,SecretariatTitle,EmailFromDateTime, EmailFrom, EmailSubject,IsNetWork
	FROM #s
    ORDER BY RegistrationDate DESC,letterid desc


[END_S_NO]

[BEGIN_S_NO]=10

alter FUNCTION [dbo].[IS_Inner_ORG]
(
	@pid INT
)
	RETURNS BIT
AS
BEGIN
	WHILE (@pid>4)
	BEGIN
		SELECT @pid = parentID FROM FromOrganizations WHERE ID = @pid
	END
	
	DECLARE @ret BIT
	--parsa
	--SET @ret = 3
	SET @ret = 0
	--parsa
	
	--SET @ret = 1
	--IF @pid > 2
    IF @pid = 2 
	    SET @ret = 1
	RETURN @ret
END

[END_S_NO]

[BEGIN_S_NO]=11

ALTER proc [dbo].[Get_LetterData_by_LetterDataID](@LetterDataID int )
as
SELECT   LetterDataID, Image, LetterData.VersionNo, LetterData.VersionDate,IsTemplate
FROM   dbo.LetterData
WHERE   (LetterDataID = @LetterDataID)

[END_S_NO]

[BEGIN_S_NO]=12

ALTER proc [dbo].[Get_LetterData_by_LetterID](@LetterID int)
as
SELECT   letterid,LetterDataID, LetterData.Extention, DESCRIPTION, LetterData.VersionNo, LetterData.VersionDate,          LetterData.archiveID, isDocument,IsTemplate
FROM  dbo.LetterData 
left JOIN  dbo.Extention ON LetterData.extention = Extention.ExtentionID
WHERE     (Extention.IsSystem = 0) AND (LetterData.LetterID = @LetterID)

[END_S_NO]

[BEGIN_S_NO]=13

ALTER PROCEDURE [dbo].[Get_All_LetterData_by_LetterID](@LetterID int)
AS
	SELECT   letterid,LetterDataID, Ex.Extention, DESCRIPTION,IMAGE,IsTemplate
	FROM dbo.LetterData LD 
        inner join Extention Ex on LD.extention = Ex.ExtentionID
	WHERE  (LetterID = @LetterID)



[END_S_NO]

[BEGIN_S_NO]=14

ALTER PROCEDURE [dbo].[insert_LetterData]
	(@LetterDataID 	[int] output,
	 @LetterID 	[int],
	 @PageNumber 	[tinyint],
	 @extention 	[tinyint])

AS INSERT INTO [dbo].[LetterData] 
	 (  [LetterID],
	 [PageNumber],
	 [extention],
         IsTemplate ) 
 
VALUES 
	( @LetterID,
	 @PageNumber,
	 @extention,
         1)

set  @LetterDataID=@@identity

[END_S_NO]

[BEGIN_S_NO]=15

ALTER function [dbo].[InnerNo]
(
	@LetterID int,@LetterTypeID INT = NULL
)  
	Returns nvarchar(200)  
begin  	
	declare @SecCode nvarchar(50),@MYear nchar(4), @IndicatorID nvarchar(10), @ToOrgCode  nvarchar(50),  
	@FromOrgCode  nvarchar(50), @LetterTypCode  nvarchar(10),@result nvarchar(4000),@UserMemo nvarchar(255),  
	@FromPrecode  nvarchar(50), @CentralNoDabir nvarchar(50)  

	DECLARE @InnerNo NVARCHAR(500), @Delimeter char(1) , 
			@LetterFormulaPart1 VARCHAR(50)
			, @LetterFormulaPart2 VARCHAR(50)
			, @LetterFormulaPart3 VARCHAR(50)
			, @LetterFormulaPart4 VARCHAR(50)
			, @LetterFormulaPart5 VARCHAR(50)
			, @LetterFormulaPart6 VARCHAR(50)
			, @SecID INT
			, @Subject NVARCHAR(4000)
			           
	SELECT  @SecCode=ltrim(isnull(Secretariats.Precode,'')),  
			@MYear=Letter.MYear,  
			@IndicatorID=Letter.IndicatorID,  
			@FromOrgCode= case when len(fromorg.code)>5  then  FromOrg.Code  else ltrim(isnull(fromorg.code,'')) end ,  
			@ToOrgCode= case when len(Toorg.code)>5  then  Toorg.Code  else ltrim(isnull(Toorg.code,'')) end ,  
			@LetterTypCode=ltrim(isnull(LetterTypes.PreCode,'')),  
			@UserMemo=ltrim(isnull(Usermemo,'')),  
			@FromPrecode=ltrim(isnull(fromorg.Precode,'')),
			@CentralNoDabir=ltrim(isnull(CenterNo,'')),
			@SecID=ISNULL(letter.SecretariatID,0),
			@Subject = s.SubjectCode		  
	FROM         Letter    
	INNER JOIN  FromOrganizations FromOrg ON Letter.FromOrgID = FromOrg.ID  
	INNER JOIN  LetterTypes ON Letter.Letter_Type = LetterTypes.ID  
	INNER JOIN  Secretariats ON Letter.SecretariatID = Secretariats.SecID
	LEFT JOIN  FromOrganizations Toorg ON Letter.ToorgID = Toorg.ID
	LEFT outer JOIN [Subject] s ON s.SubjectID = Letter.SubjectID 
	WHERE     (Letter.LetterID = @LetterID)         
	
	--IF ISNULL(@LetterID,0) > 0
	--BEGIN
	SELECT @Delimeter=ISNULL(LetterFormulaSeperator,0)
			,@LetterFormulaPart1=ISNULL(LetterFormulaPart1,0)
			,@LetterFormulaPart2=ISNULL(LetterFormulaPart2,0)
			,@LetterFormulaPart3=ISNULL(LetterFormulaPart3,0)
			,@LetterFormulaPart4=ISNULL(LetterFormulaPart4,0)
			,@LetterFormulaPart5=ISNULL(LetterFormulaPart5,0)
			,@LetterFormulaPart6=ISNULL(LetterFormulaPart6,0)  
	FROM LetterFormula WHERE SecID=@SecID and UseForWord is null  AND (letterTypeID = @LetterTypeID OR @LetterTypeID IS NULL)	

--	END
	--ELSE
	--BEGIN
	--SELECT @Delimeter=0
	--		,@LetterFormulaPart1='0'
	--		,@LetterFormulaPart2='0'
	--		,@LetterFormulaPart3='0'
	--		,@LetterFormulaPart4='0'
	--		,@LetterFormulaPart5='0'
	--		,@LetterFormulaPart6='0'

	--END

	set @result=ltrim(rtrim(cast(case  @LetterFormulaPart1--dbo.GetSystemValue('LetterFormulaPart1')--35  
					   when 0 then ''  
					   when 1 then @SecCode+@Delimeter  
					   when 2 then @MYear+@Delimeter  
					   when 3 then @IndicatorID+@Delimeter  
					   when 4 then @ToOrgCode+@Delimeter  
					   when 5 then @FromOrgCode+@Delimeter  
					   when 6 then @LetterTypCode+@Delimeter  
					   when 7 then @UserMemo+@Delimeter  
					   when 8 then @FromPrecode+@Delimeter 
					   when 9 then @CentralNoDabir+@Delimeter
					   WHEN 10 THEN ISNULL(@Subject, '') + @Delimeter end AS VARCHAR)))+  ' '+
	  
				 ltrim(rtrim(cast(case  @LetterFormulaPart2--dbo.GetSystemValue('LetterFormulaPart2')--36  
					   when 0 then ''  
					   when 1 then @SecCode+@Delimeter  
					   when 2 then @MYear+@Delimeter  
					   when 3 then @IndicatorID+@Delimeter  
					   when 4 then @ToOrgCode+@Delimeter  
					   when 5 then @FromOrgCode+@Delimeter  
					   when 6 then @LetterTypCode+@Delimeter  
					   when 7 then @UserMemo+@Delimeter   
					   when 8 then @FromPrecode+@Delimeter  
					   when 9 then @CentralNoDabir+@Delimeter
					   WHEN 10 THEN ISNULL(@Subject, '') + @Delimeter end AS VARCHAR)))+ ' '+
	  
				 ltrim(rtrim(cast(case  @LetterFormulaPart3--dbo.GetSystemValue('LetterFormulaPart3')--37  
					   when 0 then ''  
					   when 1 then @SecCode+@Delimeter  
					   when 2 then @MYear+@Delimeter  
					   when 3 then @IndicatorID+@Delimeter  
					   when 4 then @ToOrgCode+@Delimeter  
					   when 5 then @FromOrgCode+@Delimeter  
					   when 6 then @LetterTypCode+@Delimeter  
					   when 7 then @UserMemo+@Delimeter   
					   when 8 then @FromPrecode+@Delimeter
					   when 9 then @CentralNoDabir+@Delimeter
					   WHEN 10 THEN ISNULL(@Subject, '') + @Delimeter end AS VARCHAR)))+ ' '+
	  
				 ltrim(rtrim(cast(case  @LetterFormulaPart4--dbo.GetSystemValue('LetterFormulaPart4')--38  
					   when 0 then ''  
					   when 1 then @SecCode+@Delimeter  
					   when 2 then @MYear+@Delimeter  
					   when 3 then @IndicatorID+@Delimeter  
					   when 4 then @ToOrgCode+@Delimeter  
					   when 5 then @FromOrgCode+@Delimeter  
					   when 6 then @LetterTypCode+@Delimeter  
					   when 7 then @UserMemo+@Delimeter   
					   when 8 then @FromPrecode+@Delimeter
					   when 9 then @CentralNoDabir+@Delimeter 
					   WHEN 10 THEN ISNULL(@Subject, '') + @Delimeter end AS VARCHAR)))+                   
	  
				 ltrim(rtrim(cast(case  @LetterFormulaPart5--dbo.GetSystemValue('LetterFormulaPart5')--39  
					   when 0 then ''  
					   when 1 then @SecCode+@Delimeter  
					   when 2 then @MYear+@Delimeter  
					   when 3 then @IndicatorID+@Delimeter  
					   when 4 then @ToOrgCode+@Delimeter  
					   when 5 then @FromOrgCode+@Delimeter  
					   when 6 then @LetterTypCode+@Delimeter  
					   when 7 then @UserMemo+@Delimeter   
					   when 8 then @FromPrecode+@Delimeter
					   when 9 then @CentralNoDabir+@Delimeter
					   WHEN 10 THEN ISNULL(@Subject, '') + @Delimeter end AS VARCHAR)))+  ' '+                 
	  
				 ltrim(rtrim(cast(case  @LetterFormulaPart6--dbo.GetSystemValue('LetterFormulaPart6')--40  
					   when 0 then ''  
					   when 1 then @SecCode+@Delimeter  
					   when 2 then @MYear+@Delimeter  
					   when 3 then @IndicatorID+@Delimeter  
					   when 4 then @ToOrgCode+@Delimeter  
					   when 5 then @FromOrgCode+@Delimeter  
					   when 6 then @LetterTypCode+@Delimeter  
					   when 7 then @UserMemo+@Delimeter   
					   when 8 then @FromPrecode+@Delimeter
					   when 9 then @CentralNoDabir+@Delimeter
					   WHEN 10 THEN ISNULL(@Subject, '') + @Delimeter end AS VARCHAR))) +' '
	  
	while charindex('  ',@result)<>0  
	  begin  
	   Set @result=replace(@result,'  ',' ')  
	  -- Set @result=replace(@result,'/ ','/')  
	  -- Set @result=replace(@result,' /','/')  
	   Set @result = replace(@result, @Delimeter + ' ', @Delimeter)  
	   Set @result = replace(@result,' ' + @Delimeter ,@Delimeter)  
	  end   
	  
	set @result=replace(ltrim(rtrim(@result)),@Delimeter+@Delimeter,@Delimeter)  
	set @result=replace(@result,@Delimeter+@Delimeter,@Delimeter)  
	  
	  
	if substring(@result,len(@result),1)=@Delimeter  
	   set @result=substring(@result,1,len(@result)-1)  
	  
	if substring(@result,1,1)=@Delimeter  
	   set @result=substring(@result,2,len(@result)-1)  

         --parsa bug
	-- IF @Delimeter = '/'
	 --  Set @result=replace(@result,'/','|')   
         --parsa
	  
	return(@result)  
end
[END_S_NO]