BEGIN TRANSACTION

DROP PROCEDURE  IF EXISTS dbo.SELECT_ACCOUNT_DETAILS;  
go

CREATE PROCEDURE [dbo].[SELECT_ACCOUNT_DETAILS] @ACCOUNTID INT        
AS    
Declare @EndDate Nchar(10) = '1403/12/29'
--parsa
SET @EndDate  =  [dbo].[ShamsiLastYearDate](GETDATE())  
--parsa

SELECT  ACCOUNTID,ACCOUNTNO,ACCOUNTDATE,CONTACT.PERSONALNO,CONTACT.SIGN,CONTACT.PICTURE,        
            ISNULL(CASE WHEN ACCOUNT.ACCOUNTTYPEID IN (1,3 ,5,6) THEN ISNULL(FIRSTNAME+' ','')+LASTNAME+' ش.حساب: '+ ACCOUNTNO  ELSE ACCOUNTTITLE+' ش.حساب: '+ ACCOUNTNO END,ACCOUNTTITLE+' ش.حساب: '+ ACCOUNTNO) ACCOUNTTITLE,        
            CASE WHEN DBO.BALANCE(@ACCOUNTID,@EndDate)<0 THEN 'بدهکار'        
                   WHEN DBO.BALANCE(@ACCOUNTID,@EndDate)>0 THEN 'بستانکار'        
                   ELSE 'تسويه' END DEBITSTATUS,        
            (SELECT COUNT(1) FROM FORCEPAYMENT  INNER JOIN LOAN ON LOAN.LOANID=FORCEPAYMENT.PARENTID WHERE   FORCETYPEID=1 AND LOAN.ACCOUNTID=@ACCOUNTID AND ISNULL(FORCEPAYMENT.PAYMENTID,0)=0) NUMBEROFNOTPAIDPART ,        
     DBO.EXIST(@ACCOUNTID,@EndDate) EXIST,        
     DBO.TOTALEXIST(@ACCOUNTID,@EndDate, 0) TOTALEXIST,        
     DBO.BALANCE_BYPAYTYPEID(@ACCOUNTID,1,@EndDate) PAYBALANCE,        
     DBO.BALANCE_BYPAYTYPEID(@ACCOUNTID,2,@EndDate) MONTHLYBALANCE,  
     CASE SIGN(DBO.BALANCE(ACCOUNT.ACCOUNTID,'9')) WHEN 1 THEN 'بستانکار' WHEN -1 THEN  'بدهكار' ELSE 'تسويه' END DEBITSTATUSTITLE ,  
     CASE SIGN(DBO.BALANCE_BYPAYTYPEID(@ACCOUNTID,1,@EndDate)) WHEN 1 THEN 'بستانکار' WHEN -1 THEN  'بدهكار' ELSE 'تسويه' END PAYBALANCETitle ,  
     CASE SIGN(DBO.BALANCE_BYPAYTYPEID(@ACCOUNTID,2,@EndDate)) WHEN 1 THEN 'بستانکار' WHEN -1 THEN  'بدهكار' ELSE 'تسويه' END MONTHLYBALANCETitle ,  
     CASE SIGN(DBO.EXIST(@ACCOUNTID,@EndDate)) WHEN 1 THEN 'بستانکار' WHEN -1 THEN  'بدهكار' ELSE 'تسويه' END EXISTTitle ,
     CASE SIGN(DBO.TOTALEXIST(@ACCOUNTID,@EndDate, 0)) WHEN 1 THEN 'بستانکار' WHEN -1 THEN  'بدهكار' ELSE 'تسويه' END TOTALEXISTTitle,  

     ACCOUNT.CONTACTID ,dbo.GetPhoneNumber(ACCOUNT.CONTACTID) Phone
            
    FROM     ACCOUNT            
             LEFT JOIN MONTHLYTYPE ON ACCOUNT.MONTHLYTYPEID=MONTHLYTYPE.MONTHLYTYPEID        
             LEFT JOIN ACCOUNTTYPE ON ACCOUNT.ACCOUNTTYPEID=ACCOUNTTYPE.ACCOUNTTYPEID        
             LEFT JOIN CONTACT     ON ACCOUNT.CONTACTID=CONTACT.CONTACTID        
    WHERE ACCOUNTID=@ACCOUNTID  

GO

COMMIT
GO
