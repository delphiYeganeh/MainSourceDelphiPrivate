BEGIN TRANSACTION

DROP PROCEDURE  IF EXISTS dbo.REPORT_CASHACCOUNT;  
go

CREATE PROCEDURE [dbo].[REPORT_CASHACCOUNT]
	@WHERE VARCHAR(1000), 
	@ISLOAN INT = 0
AS
	DECLARE @SQL NVARCHAR(4000)  
	--parsa 
	DECLARE @dateFrom char(10)  , @dateTo char(10)   
	SET @dateFrom = '1360/01/01'  
	SET @dateTo  =  '1403/12/29'    
	SET @dateTo =  [dbo].[ShamsiLastYearDate](GETDATE())  
	--parsa
	
	SET @WHERE = ISNULL(LTRIM(@WHERE), '')                
	IF @WHERE <> ''
	    SET @WHERE = ' AND  '+@WHERE                
	
	IF @ISLOAN <> 7
	    SET @SQL = 
	        'SELECT  BANK.BANKTITLE, ACCOUNT.ACCOUNTID, ACCOUNT.ACCOUNTTITLE, ACCOUNTNO, ACCOUNTDATE, ACCOUNT.ISACTIVE,ACCOUNT.ACCOUNTTYPEID,ACCOUNTTYPETITLE, 
						   case When  AccountId=1  then IsNull(DBO.PUREBALANCE(ACCOUNT.ACCOUNTID,'''+@dateTo+'''),0)  
							    When  AccountId=4  then  DBO.F_Soodvam ('''+@dateFrom+''' ,'''+@dateTo+''') 
							    ELSE DBO.PUREBALANCE(ACCOUNT.ACCOUNTID,'''+@dateTo+''') End as  BALANCE, 
					  CASE SIGN(DBO.PUREBALANCE(ACCOUNT.ACCOUNTID,''9'')) WHEN 1 THEN ''بستانکار '' WHEN -1 THEN  ''بدهکار '' ELSE ''تسويه '' END DEBITSTATUSTITLE 
				FROM       ACCOUNT     WITH (NOLOCK)               
				LEFT  JOIN BANK        WITH (NOLOCK)     ON ACCOUNT.BANKID = BANK.BANKID 
				INNER JOIN ACCOUNTTYPE WITH (NOLOCK) ON ACCOUNT.ACCOUNTTYPEID=ACCOUNTTYPE.ACCOUNTTYPEID
				WHERE ACCOUNT.ISACTIVE=1 '
	
	IF @ISLOAN=7
	    SET @SQL = 
	        ' SELECT BANK.BANKTITLE, ACCOUNT.ACCOUNTID,ACCOUNT.ACCOUNTTITLE,ACCOUNT.ACCOUNTNO, 
						  ACCOUNT.ACCOUNTDATE,ACCOUNT.ISACTIVE,LOANTYPE.LOANTYPEID AS ACCOUNTTYPEID,LOANTYPE.LOANTYPETITLE AS ACCOUNTTYPETITLE, 
						  case When  AccountId=1  then IsNull(DBO.PUREBALANCE(ACCOUNT.ACCOUNTID,'''+@dateTo+'''),0) + IsNull((SELECT SUM(Amount) FROM   Payment  WHERE  (PayTypeID = 7)),0) 
							   When  AccountId=4  then  DBO.F_Soodvam ('''+@dateFrom+''' ,'''+@dateTo+''')  
							   ELSE DBO.PUREBALANCE(ACCOUNT.ACCOUNTID,'''+@dateTo+''') End as  BALANCE, 
						  CASE SIGN(DBO.PUREBALANCE(ACCOUNT.ACCOUNTID,''9'')) WHEN 1 THEN ''بستانکار '' WHEN -1 THEN  ''بدهکار '' ELSE ''تسويه '' END DEBITSTATUSTITLE 
	          FROM              LOAN     WITH (NOLOCK)
				INNER JOIN      ACCOUNT  WITH (NOLOCK) ON LOAN.ACCOUNTID = ACCOUNT.ACCOUNTID 
				LEFT OUTER JOIN LOANTYPE WITH (NOLOCK) ON LOAN.LOANTYPEID = LOANTYPE.LOANTYPEID LEFT 
				OUTER JOIN      BANK     WITH (NOLOCK) ON ACCOUNT.BANKID = BANK.BANKID              
			WHERE ACCOUNT.ISACTIVE=1 '                
	
	SET @SQL = @SQL+@WHERE+' ORDER BY ACCOUNTTITLE '                
	EXEC SP_EXECUTESQL @SQL  
GO

COMMIT
GO

