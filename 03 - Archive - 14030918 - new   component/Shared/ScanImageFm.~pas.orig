unit ScanImageFm;

interface

uses
  BaseUnit,Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, ExtCtrls, DBCtrls, ComCtrls, StdCtrls, Mask, Buttons, DB, ADODB,
  ExtDlgs, xpWindow, ExtActns, ActnList, DBActns, XPStyleActnCtrls, ActnMan,
  ieview, imageenview, dbimageen, ievect, dbimageenvect,
  rulerbox, iegradientbar, histogrambox, iemview, iemio, hvideocap,
  videocap, imageenproc, imageen, dbcgrids, imageenio, Spin , FileCtrl ,
  ShellApi , hyieutils ,hyiedefs , Printers, OleCtrls, ScanLibCtl_TLB,
  Grids, DBGrids, YRotateLabel, YDbgrid, Menus, IdBaseComponent, IdCoder,
  IdCoder3to4, IdCoderMIME, TntDialogs, TntExtDlgs,
  {HKH Owner Unit}
  BaseUnits,
  StrUtils, IdComponent, IdTCPConnection, IdTCPClient, IdFTP, AdvObj,
  BaseGrid, AdvGrid, DBAdvGrid,
  AdvDropDown, AdvColorPickerDropDown   ,AdvUtil, ImgList, cxGraphics,
  cxControls, cxLookAndFeels, cxLookAndFeelPainters, dxSkinsCore,
  dxSkinBlack, dxSkinBlue, dxSkinBlueprint, dxSkinCaramel, dxSkinCoffee,
  dxSkinDarkRoom, dxSkinDarkSide, dxSkinDevExpressDarkStyle,
  dxSkinDevExpressStyle, dxSkinFoggy, dxSkinGlassOceans,
  dxSkinHighContrast, dxSkiniMaginary, dxSkinLilian, dxSkinLiquidSky,
  dxSkinLondonLiquidSky, dxSkinMcSkin, dxSkinMoneyTwins,
  dxSkinOffice2007Black, dxSkinOffice2007Blue, dxSkinOffice2007Green,
  dxSkinOffice2007Pink, dxSkinOffice2007Silver, dxSkinOffice2010Black,
  dxSkinOffice2010Blue, dxSkinOffice2010Silver, dxSkinPumpkin, dxSkinSeven,
  dxSkinSevenClassic, dxSkinSharp, dxSkinSharpPlus, dxSkinSilver,
  dxSkinSpringTime, dxSkinStardust, dxSkinSummer2008,
  dxSkinTheAsphaltWorld, dxSkinsDefaultPainters, dxSkinValentine,
  dxSkinVS2010, dxSkinWhiteprint, dxSkinXmas2008Blue, cxNavigator,
  cxDBNavigator, TntExtCtrls;

type
  TFmScanImage = class(TMBaseForm)
    Panel1: TPanel;
    Panel2: TPanel;
    Panel3: TPanel;
    Panel4: TPanel;
    Panel5: TPanel;
    xpBitBtn1: TBitBtn;
    FitToPage: TBitBtn;
    SpeedButton5: TBitBtn;
    SpeedButton1: TBitBtn;
    ActionManager1: TActionManager;
    Aclose: TAction;
    Aprintt: TAction;
    Scan: TAction;
    OpenFile: TAction;
    ADelete: TAction;
    SaveAs: TAction;
    Timer: TTimer;
    ColorDialog: TColorDialog;
    SavePictureDialog: TSavePictureDialog;
    OpenPictureDialogT: TOpenPictureDialog;
    ImageEnIO1: TImageEnIO;
    xpBitBtn2: TBitBtn;
    BBScan: TBitBtn;
    BBSaveToFile: TBitBtn;
    ImageEnProc1: TImageEnProc;
    BBSaveAllToFiles: TBitBtn;
    BBOpenFile: TBitBtn;
    ColorDialog1: TColorDialog;
    ImageEnMView1: TImageEnMView;
    FontDialog1: TFontDialog;
    LabelZoom: TLabel;
    ImageEnMIO1: TImageEnMIO;
    SBSettings: TSpeedButton;
    BitBtn1: TBitBtn;
    ActSelScanner: TAction;
    BBAllScanImage: TBitBtn;
    Timer1: TTimer;
    ASaveAll: TAction;
    Action1: TAction;
    SBDelAllData: TSpeedButton;
    Panel6: TPanel;
    PageControl1: TPageControl;
    BrushTab: TTabSheet;
    SpeedButton12: TSpeedButton;
    SpeedButton13: TSpeedButton;
    SpeedButton9: TSpeedButton;
    SpeedButton4: TSpeedButton;
    SpeedButton6: TSpeedButton;
    SpeedButton11: TSpeedButton;
    SpeedButton10: TSpeedButton;
    Label1: TLabel;
    Label7: TLabel;
    SBBrush: TSpeedButton;
    SBZoom: TSpeedButton;
    SpeedButton3: TSpeedButton;
    Bevel2: TBevel;
    Bevel1: TBevel;
    Bevel3: TBevel;
    SBResize: TSpeedButton;
    BBUndo: TBitBtn;
    BitBtn9: TBitBtn;
    BitBtn3: TBitBtn;
    BitBtn7: TBitBtn;
    SpinEdit1: TSpinEdit;
    BitBtn2: TBitBtn;
    CBHideObjects: TCheckBox;
    RGPenType: TRadioGroup;
    SEBrushSize: TSpinEdit;
    BrushColor: TPanel;
    YRotateLabel1: TYRotateLabel;
    YRotateLabel2: TYRotateLabel;
    Panel7: TPanel;
    acShowAllPages: TAction;
    acShowSelectedPages: TAction;
    PopupMenu1: TPopupMenu;
    acShowNotColorPages: TAction;
    N5: TMenuItem;
    acAttachColor: TAction;
    qAttachColor: TADOQuery;
    qGetColor: TADOQuery;
    qGetColorColor: TStringField;
    PageControl2: TPageControl;
    TabSheet1: TTabSheet;
    TabSheet2: TTabSheet;
    DBGrid2: TDBGrid;
    dsqSelectedColor: TDataSource;
    PopupMenu2: TPopupMenu;
    N1: TMenuItem;
    N2: TMenuItem;
    N3: TMenuItem;
    N4: TMenuItem;
    DBColor: TDBEdit;
    QCheckActionAccess: TADOQuery;
    QCheckActionAccessHasAccess: TBooleanField;
    N6: TMenuItem;
    N7: TMenuItem;
    N8: TMenuItem;
    acDeAttachColor: TAction;
    N9: TMenuItem;
    ImageEnView1: TImageEnView;
    IdDecoderMIME1: TIdDecoderMIME;
    SaveDialog1: TSaveDialog;
    OpenPictureDialog: TTntOpenPictureDialog;
    acSettings: TAction;
    IdFTP1: TIdFTP;
    Button1: TButton;
    Action2: TAction;
    ImageList1: TImageList;
    ImageList2: TImageList;
    TreeView1: TTreeView;
    N10: TMenuItem;
    N11: TMenuItem;
    DBN1: TDBNavigator;
    ImageEnDBVect1: TImageEnDBVect;
    ImageEnDBView1: TImageEnDBView;
    SpeedButton7: TSpeedButton;
    SBReplacePic: TSpeedButton;
    SBGoToPAge: TSpeedButton;
    Label2: TLabel;
    ImageEnVect1: TImageEnVect;
    StaticText1: TStaticText;
    cxDBNavigator2: TcxDBNavigator;
    Edit1: TEdit;
    Panel8: TPanel;
    Label5: TLabel;
    SpeedButton2: TSpeedButton;
    Label6: TLabel;
    DBLkCBListItemsID: TDBLookupComboBox;
    DBENotes: TDBEdit;
    pb1: TProgressBar;
    procedure FormShow(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure DBN1Click(Sender: TObject; Button: TNavigateBtn);
    procedure xpBitBtn1Click(Sender: TObject);
    procedure FitToPageClick(Sender: TObject);
    procedure SpeedButton5Click(Sender: TObject);
    procedure SpeedButton4Click(Sender: TObject);
    procedure SpeedButton9Click(Sender: TObject);
    procedure OpenFileExecute(Sender: TObject);
    procedure OpenFileExecute_SQL(Sender: TObject);
    procedure SaveAsExecute(Sender: TObject);
    procedure BitBtn2Click(Sender: TObject);
    procedure BitBtn3Click(Sender: TObject);
    procedure BitBtn7Click(Sender: TObject);
    procedure ImageEnDBView3Click(Sender: TObject);
    procedure DBN1BeforeAction(Sender: TObject; Button: TNavigateBtn);
    procedure ScanExecute(Sender: TObject);
    procedure ScanSQl;
    procedure BrushColorClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure CreateBrush(Sender: TObject);
    procedure BitBtn9Click(Sender: TObject);
    procedure ImageEnMView1ImageSelect(Sender: TObject; idx: Integer);
    procedure RGOperationClick(Sender: TObject);
    procedure RGPenTypeClick(Sender: TObject);
    procedure SEBrushSizeChange(Sender: TObject);
    procedure ImageEnDBVect1MouseDown(Sender: TObject;
      Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure ImageEnDBVect1MouseMove(Sender: TObject; Shift: TShiftState;
      X, Y: Integer);
    procedure SpeedButton1Click(Sender: TObject);
    procedure SpeedButton3Click(Sender: TObject);
    procedure SBZoomClick(Sender: TObject);
    procedure SpeedButton13Click(Sender: TObject);
    procedure SpeedButton12Click(Sender: TObject);
    procedure ImageEnDBVect1NewObject(Sender: TObject; hobj: Integer);
    procedure ImageEnDBVect1KeyUp(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure SpeedButton6Click(Sender: TObject);
    procedure SpeedButton10Click(Sender: TObject);
    procedure SpeedButton11Click(Sender: TObject);
    procedure SignPicExecute(Sender: TObject);
    procedure CBHideObjectsClick(Sender: TObject);
    procedure BBUndoClick(Sender: TObject);
    procedure FormKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure SBBrushClick(Sender: TObject);
    procedure ImageEnIO1AcquireBitmap(Sender: TObject; ABitmap: TIEBitmap;
      var Handled: Boolean);
    procedure AprinttExecute(Sender: TObject);
    procedure BBAllScanImageClick(Sender: TObject);
    procedure ActSelScannerExecute(Sender: TObject);
    procedure SpeedButton2Click(Sender: TObject);
    procedure SBResizeClick(Sender: TObject);
    procedure SBDelAllDataClick(Sender: TObject);
    procedure SBGoToPageClick(Sender: TObject);
    procedure Timer1Timer(Sender: TObject);
    procedure ASaveAllExecute(Sender: TObject);
    procedure SBReplacePicClick(Sender: TObject);
    procedure SpeedButton7Click(Sender: TObject);
    procedure YRotateLabel1Click(Sender: TObject);
    procedure YRotateLabel2Click(Sender: TObject);
    procedure DBGrid1DrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure acShowSelectedPagesExecute(Sender: TObject);
        procedure acShowSelectedPagesExecute1(ColorID:String);
    procedure acShowAllPagesExecute(Sender: TObject);
    procedure acShowNotColorPagesExecute(Sender: TObject);
    procedure acAttachColorExecute(Sender: TObject);
    procedure DBGrid2DrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure PageControl2Change(Sender: TObject);
    procedure DBGrid2DblClick(Sender: TObject);
    procedure acDeAttachColorExecute(Sender: TObject);
    procedure ImageEnVect1KeyUp(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure ImageEnVect1MouseDown(Sender: TObject; Button: TMouseButton;
      Shift: TShiftState; X, Y: Integer);
    procedure ImageEnVect1MouseMove(Sender: TObject; Shift: TShiftState; X,
      Y: Integer);
    procedure ImageEnVect1NewObject(Sender: TObject; hobj: Integer);
    procedure ImageEnVect1ViewChange(Sender: TObject; Change: Integer);
    procedure ImageEnDBView1ViewChange(Sender: TObject; Change: Integer);
    procedure BitBtn4Click(Sender: TObject);
    procedure acSettingsExecute(Sender: TObject);
    procedure DBAdvGrid1DblClick(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure DBAdvGrid2ClickCell(Sender: TObject; ARow, ACol: Integer);
    procedure DBAdvGrid2GetAlignment(Sender: TObject; ARow, ACol: Integer;
      var HAlign: TAlignment; var VAlign: TVAlignment);
    procedure Action2Execute(Sender: TObject);
    procedure ImageEnView1Click(Sender: TObject);
    procedure ImageEnVect1Click(Sender: TObject);
    procedure ImageEnMView1Click(Sender: TObject);
    procedure ImageEnDBView1Click(Sender: TObject);
    procedure TreeView1Click(Sender: TObject);
    procedure TreeView1GetSelectedIndex(Sender: TObject; Node: TTreeNode);
    procedure DBGrid2CellClick(Column: TColumn);
    procedure TreeView1DblClick(Sender: TObject);
    procedure N11Click(Sender: TObject);
  private
    StartX , StartY , LastX , LastY:integer;
    LeyerIndex :integer;
     _DownloadSetting:TDownloadSetting;
    _BaseSQLConnection:TBaseSQLConnection;
    _SaveFileType:String;
    _IMGDPI:String;
    Edit : Boolean;
    procedure SavenadLoadInDB(FileNames:String);
    function FindColors(NodeName:String):string;
    procedure InitializeDBADVGroup;
    procedure InitDBGrid2;
    Procedure ControlEnabled(Anabled:Boolean);
    Procedure Exec_UserLog(ActionName:String);
    procedure FillData(aFileName:String);
    procedure FillData_SQL(aFileName:String);
    procedure EnableScan(aConAnable:Boolean);
    procedure SetTextFontColor;
    procedure ControlAnable(anable:Boolean);
    procedure ShowPageFromAll;
    procedure ShowNotPageFromAll;
    function  GetColor(ColorID:Integer):String;
    function  CheckAccessColors(ActionName:String):Boolean;
    Function UploadFileToFTP(Source:string;UploadFile:String):String;
        procedure ItializeDownloadSetting;
        procedure LoadImages;
        procedure AddNodeINTreeView(LDestNode: TTreeNode;_ID:String);
        function FindID(_Name:String):String;
  public
    _MyPuletColors:String;
    QUICK_SCAN : Boolean;
    _MyLetterID:String;
    _JpegFIleChange:TImageFile;
    letterformat,ReceiveTypeID : integer;
    LetterID : Integer;
    RReadOnly : Boolean;
    _ColorsID:String;
    function CreateBitmapSolidColor(Width,Height:Word;Color:TColor;const FileName : TFileName):Integer;
    procedure ChangeMultyTifToTifsAndSave(aFileName:String);
    procedure ChangeJPGToTifAndSave(FileName:String);
    Procedure Close_Open_QrLetterData;
    procedure ShowPageCount;
    procedure LoadAndShow(filename : string);
    procedure LoadAndShow_SQL(filename : string);
  end;

Var
  FmScanImage: TFmScanImage;
  ValueColorID,SelecttionColorId,flag : Integer;

implementation

Uses Dmu, ScanImageDM , YShamsiDate , BusinessLayer, UMain, UPagePreview,
  InsertText, AllScanImageFm, ImageDataFM, Settingsu, PicProgressFm,
  WaitPleaseFM, PrintFm, EZTwain, ADOInt, UAddDocument, DateUtils;

{$R *.dfm}

function TFmScanImage.CreateBitmapSolidColor(Width,Height:Word;Color:TColor;const FileName : TFileName):Integer;
var
 bmp : TBitmap;
begin
 bmp := TBitmap.Create;
 try
   bmp.PixelFormat := pf24bit;
   bmp.Width := Width;
   bmp.Height := Height;
   bmp.Canvas.Brush.Color := Color;
   bmp.Canvas.FillRect(Rect(0, 0, Width, Height));
   ImageList2.Add(bmp,bmp);
   Result := ImageList2.Count - 1;
 finally
   bmp.Free;
 end;
end;

procedure SetWinControlBiDi(Control: TWinControl);
var
 ExStyle: Longint;
begin
 ExStyle := GetWindowLong(Control.Handle, GWL_EXSTYLE);
 SetWindowLong(Control.Handle, GWL_EXSTYLE, ExStyle or WS_EX_RTLREADING or WS_EX_RIGHT
   or WS_EX_LAYOUTRTL or WS_EX_NOINHERITLAYOUT );
end;

Procedure TFmScanImage.Close_Open_QrLetterData;
begin
   With DMScanImage do
   begin
      QrLetterData.Close;
      QrLetterData.Parameters.ParamByName('Pa_LetterID').Value := LetterID;
      QrLetterData.Open;
//      DBN1.DataSource:=DMScanImage.DSLetterData;
//      ImageEnDBView1.DataSource:=DMScanImage.DSLetterData;
      ImageEnDBView1.Update;
   end;
end;

procedure TFmScanImage.EnableScan(aConAnable:Boolean);
begin
  inherited;
{  DataSetPost1.Enabled := aConAnable;
  Bpost.Enabled := aConAnable;

  EditBitBtn.Enabled := not aConAnable;
  AEDit.Enabled := not aConAnable;

  DataSetCancel1.Enabled := aConAnable;
  CancelBitBtn.Enabled := aConAnable;

  ScanBitBtn.Enabled := aConAnable;
  Scan.Enabled := aConAnable;

  WritePan.Visible := aConAnable;
  if _kartable then
     RecommitePanel.Visible := not aConAnable;
 } end;


procedure TFmScanImage.FormShow(Sender: TObject);
var
   I, UserIdCreator : Integer;
   _Query:String;
   LDestNode: TTreeNode;
   AQry : TADOQuery;
begin
   inherited;
     AQry := TADOQuery.Create(Self);
     try
      AQry.Connection := Dm.YeganehConnection;
      AQry.Close;
      AQry.SQL.Text := 'Select UserID From Letter Where LetterId = ' + Dm.SelectLetter;
      AQry.Open;
      UserIdCreator := AQry.FieldByName('UserId').AsInteger;
     finally
      FreeAndNil(AQry);
     end;
     if not Dm.UsersShowAllDoc.AsBoolean then
       if Dm.UsersId.AsInteger <> UserIdCreator then
        begin
         DBN1.VisibleButtons := [nbPrior,nbFirst,nbLast,nbNext];
         SBDelAllData.Enabled := False;
         Edit := True;
        end;
   ImageList2.Clear;
  _SaveFileType:=_BaseSQLConnection.GetKeyvalue('SaveFileType');
  _IMGDPI:=_BaseSQLConnection.GetKeyvalue('IMGDPI');
  if _SaveFileType='2' then
   ImageEnDBView1.DataField:='Image'
  else
   ImageEnDBView1.DataField:='FileType';
  SetWinControlBiDi(TreeView1);
  TreeView1.Refresh;
  try
   _Query:='SELECT * FROM DefineColors where  parent =0 Order by Id Desc';
   Dm.qDefineColors.SQL.Clear;
   Dm.qDefineColors.SQL.Add(_Query);
   Dm.qDefineColors.Open;

//Add Father
   TreeView1.Items.Clear;
   Dm.qDefineColors.First;
   repeat
     try
    LDestNode:=TreeView1.Items.AddFirst(nil, Dm.qDefineColors.FieldByName('Descriptions').asstring);
    LDestNode.ImageIndex := CreateBitmapSolidColor(16,16,StringToColor(Dm.qDefineColors.FieldByName('Color').asString),'');
    AddNodeINTreeView(LDestNode,Dm.qDefineColors.FieldByName('ID').asstring);
    except

    end;
    Dm.qDefineColors.Next;
   until Dm.qDefineColors.Eof;


   Dm.qDefineColors.RecNo:=1;
    (*Hamed_Ansari
    DBAdvGrid2.Cells[0,0]:='';
    DBAdvGrid2.Cells[1,0]:='';
    DBAdvGrid2.Cells[2,0]:='';
    DBAdvGrid2.Cells[3,0]:='';
    DBAdvGrid2.Cells[4,0]:='';
    DBAdvGrid2.Cells[5,0]:='';
    DBAdvGrid2.Cells[6,0]:='';
    *)
   Button1.Click;

  except

  end  ;

  try
   ItializeDownloadSetting;
//   MainForm.RefreshQuery;
  if Assigned(FrAddDocument) then
   _MyLetterID := IntToStr(FrAddDocument.Select_LetterLetterID.AsInteger)
  else
   _MyLetterID := Dm.Get_All_LetterLetterID.AsString;


  except

  end;

  try
   if not dm.GetActionAccess(ADelete.Name,self.Tag) then
   begin
     SBDelAllData.Hide;
     dbn1.VisibleButtons:=DBN1.VisibleButtons-[nbDelete];
   end;
   if not dm.GetActionAccess(Action1.Name,self.Tag) then
   begin
     dbn1.VisibleButtons:=DBN1.VisibleButtons-[nbEdit,nbPost,nbInsert];
   end;

   except

   end;
     DMScanImage := TDMScanImage.Create(Self);
    With DMScanImage do
    begin
       Close_Open_QrLetterData;
       //QrLetterData.First;
       LetterID2 := LetterID;

       QrListItems.Close;
       QrListItems.Parameters.ParamByName('UsersID').Value := _UserId;
       QrListItems.Open;
    end;
//    end;
  ImageEnDBView1.Align := alClient;
  ImageEnDBView1.Repaint;
  DBNav_Setup(DBN1);

  ControlEnabled(False);
  //BrushColor.Color := $00FF6C6C;
  ControlAnable(False);
  PageControl1.Enabled := False;
  Align := alClient;
  Timer1.Enabled := True;
  ImageEnProc1.AttachedImageEn := ImageEnVect1;
  ImageEnIO1.AttachedImageEn   := ImageEnVect1;
  ImageEnMIO1.AttachedMView    := ImageEnMView1;

  if QUICK_SCAN then
  BEGIN
  DMScanImage.QrSelImage.Append;
  ControlEnabled(True);
  BBScan.Click;
  END;
  ValueColorID := -1;

 //   FitToPageClick(Self);
 if Dm.GetValue(2104) = 0 then
   FitToPageClick(Self);
 if Dm.GetValue(2104) = 1 then
   SpeedButton5Click(Self);
 if Dm.GetValue(2104) = 2 then
   SpeedButton1Click(Self);
 flag := 0;
// acShowNotColorPagesExecute(Application)
end;

procedure TFmScanImage.FormClose(Sender: TObject;
  var Action: TCloseAction);
var
 AQry : TADOQuery;
begin
   inherited;
   AQry := TADOQuery.Create(nil);
   try
    AQry.Connection := Dm.YeganehConnection;
    AQry.Close;
    AQry.SQL.Text := ' update letter set Has_Page = dbo.has_Page(letterid), ' +
                     ' Has_WordPage = dbo.has_WordPage(letterid), ' +
                     ' Has_File = dbo.has_file(letterid) from Letter Where LetterID = ' + IntToStr(LetterID);
    AQry.ExecSQL;
   finally
    FreeAndNil(AQry);
   end;
   With DMScanImage do
   begin
      QrLetterData.Close;
      QrSelImage.Close;
   end;
   FreeAndNil(DMScanImage);
end;

procedure TFmScanImage.DBN1Click(Sender: TObject; Button: TNavigateBtn);
begin
  inherited;
  if Button = nbInsert then
  begin
     if Not(DMScanImage.QrSelImage.State = dsInsert) then
     begin
//        ShowMessage(DMScanImage.QrSelImage.FieldByName('LetterID').AsString+' -- ' +DMScanImage._LetterID);
//        DMScanImage.QrSelImage.Append;
        DMScanImage.QrSelImage.Insert;
        if DMScanImage._LetterID<>'' then
        DMScanImage.QrSelImage.FieldByName('LetterID').value:=DMScanImage._LetterID;
     end  ;
     ControlEnabled(True);
  end;

  if Button = nbEdit then
  begin

     ControlEnabled(True);
     Exec_insert_UserLog('EditPicture',DMScanImage.QrLetterDataLetterID.AsInteger);
     Dm.Insert_LetterEdit(DMScanImage.QrLetterDataLetterID.AsInteger,'ÊÌ—«Ì‘  ’ÊÌ—');
  end;

  if Button = nbCancel then
  begin
     DMScanImage.QrSelImage.Cancel;
     While ImageEnVect1.LayersCount > 1 do
        ImageEnVect1.LayersRemove(ImageEnVect1.LayersCount-1);
     //For Refresh Image
     ImageEnVect1.Refresh;
     ControlEnabled(False);
  end;

  if Button = nbDelete then
  begin
     //«” ›«œÂ ‘Êœ DBN1BeforeAction ·ÿ›« »Ã«Ì «Ì‰ —ÊÌœ«œ «“ —ÊÌœ«œ
  end;


//  ImageEnDBVect1.FitToWidth;
  try
  if (Button = nbInsert) and (PageControl2.ActivePageIndex = 0) and (DBGrid2.SelectedField.Text = '›«ﬁœ —‰ê') then
   Edit1.Color := clBtnFace
  else
  if (_MyPuletColors <> '') and (_MyPuletColors <> '›«ﬁœ —‰ê') and (_MyPuletColors <> ' „«„ „Ê«—œ') then
    Edit1.Color:= StringToColor(_MyPuletColors)
   else
    Edit1.Color := clBtnFace;
  except
  end;
  ImageEndbView1.FitToWidth;
//     try
//      if DMScanImage.QrSelImageColorID.AsInteger=0  then
//      begin
//        Edit1.Color:= clWindow;
//        Edit1.Visible:=false;
//
//        end
//        else
//        begin
//        Edit1.Color:= StringToColor(GetColor(DMScanImage.QrSelImageColorID.AsInteger));
//        Edit1.Visible:=True;
//        end;
//
//
//
//
//   except
//
//   end;
end;

Procedure TFmScanImage.FillData(aFileName:String);
var
 FileName: string;
SaveFileName,SaveFileUrl, ShowImageURL:string;
begin
   With DMScanImage do
   begin
      Application.ProcessMessages;
          Sleep(1500);
      if Not(QrLetterData.State in [dsEdit,dsInsert]) then
         Exit;
      {Ranjbar 89.05.15}
      //QrSelImage.Append;
      if QrLetterData.State=dsinsert then
         QrSelImage_Insert.Append
      else
         QrSelImage_Insert.Edit;
      //---
//       qAttachColor.Parameters.ParamByName('ColorID').Value:=Label3.Caption;
      QrSelImage_InsertImage.LoadFromFile(aFileName);
      if (UpperCase(File_GetFileExt(aFileName)) = 'TIF')or(UpperCase(File_GetFileExt(aFileName)) = 'TIFF') then
         QrSelImage_InsertExtention.AsInteger := 2 //TIFF or Jpeg
      else
         QrSelImage_InsertExtention.AsInteger := 1; //JPEG Format
      ImageEnVect1.LayersRemove(1);//
      QrSelImage_InsertLastUpdate.AsDateTime := Now;
      QrSelImage_InsertLetterID.AsInteger := fmScanImage.LetterID;
      if QrSelImage_Insert.State = dsInsert then
         QrSelImage_InsertPageNumber.AsInteger := Dm.YeganehConnection.Execute('Select IsNull(Max(PageNumber),0)+1 As NextPageNumber '+
                 ' from LetterData Where Extention <3 And LetterID = '+QrSelImage_InsertLetterID.AsString).Fields[0].value;
      {Ranjbar 90.03.18 ID=378} //And ID=105
      QrSelImage_InsertIsCorrectedImage.AsBoolean := True;
      //---
      if ValueColorID <> -1 then
        QrSelImage_InsertColorID.AsInteger := ValueColorID ;
      QrSelImage_Insert.Post;
            if QrSelImage_Insertextention.AsInteger=1 then
               FileName := Dm.File_AddressAddress.AsString + Trim(QrSelImage_InsertLetterID.AsString)+'_'+IntToStr(QrSelImage_InsertPageNumber.AsInteger)+'.jpg'
               //FileName := '\\192.168.88.39\d\a\0\' + Trim(QrSelImage_InsertLetterID.AsString)+'_'+IntToStr(QrSelImage_InsertPageNumber.AsInteger)+'.jpg'
            else
               //FileName := '\\192.168.88.39\d\a\0\' + Trim(QrSelImage_InsertLetterID.AsString)+'_'+IntToStr(QrSelImage_InsertPageNumber.AsInteger)+'.tiff';
               FileName := Dm.File_AddressAddress.AsString + Trim(QrSelImage_InsertLetterID.AsString)+'_'+IntToStr(QrSelImage_InsertPageNumber.AsInteger)+'.tiff';

              SaveFileUrl:= _MyLetterID+ FormatDateTime('hhmmss',now)+ExtractFileExt(aFileName);
              SaveFileName:= UploadFileToFTP(aFileName,SaveFileUrl);


            DMScanImage.ADOQuery1.Close;
            DMScanImage.ADOQuery1.Parameters.ParamByName('path').Value :=  SaveFileName;
            DMScanImage.ADOQuery1.Parameters.ParamByName('URL').Value :=  SaveFileName;
            DMScanImage.ADOQuery1.Parameters.ParamByName('Pa_LetterDataID').Value := QrSelImage_InsertLetterDataID.AsInteger;
//            DMScanImage.ADOQuery1.Parameters.ParamByName('Pa_LetterDataID').Value := _MyLetterID ;//QrSelImage_InsertLetterDataID.AsInteger;
            DMScanImage.ADOQuery1.ExecSQL;
//            QrSelImage_InsertImage.SaveToFile(FileName);
     {
      QrLetterData.Close;
      QrLetterData.Parameters.ParamByName('Pa_LetterID').Value := LetterID;
      QrLetterData.Open;
         QrLetterData.First;
         while not QrLetterData.Eof do
         begin
            Sleep(1);
            if DMScanImage.QrSelImageextention.AsInteger=1 then
               FileName := 'F:\0\' + Trim(DMScanImage.QrSelImageLetterID.AsString)+'_'+IntToStr(DMScanImage.QrLetterData.RecNo)+'.jpg'
            else
               FileName := 'F:\0\' + Trim(DMScanImage.QrSelImageLetterID.AsString)+'_'+IntToStr(DMScanImage.QrLetterData.RecNo)+'.tiff';
            DMScanImage.QrSelImageImage.SaveToFile(FileName);

            DMScanImage.ADOQuery1.Close;
            DMScanImage.ADOQuery1.Parameters.ParamByName('path').Value :=  FileName;
            DMScanImage.ADOQuery1.Parameters.ParamByName('Pa_LetterDataID').Value := IntToStr(QrLetterDataLetterDataID.AsInteger);
            DMScanImage.ADOQuery1.ExecSQL;
            QrLetterData.Next;
         end;
        // ShellExecute(Handle, 'Open',Pchar(FileName),nil,nil,SW_SHOWNORMAL);


     QrSelImageImage.SaveToFile(FileName);}
   //   QrSelImageImage.SaveToFile('F:\0\text.jpg');
//      ShellExecute(Handle, 'Open',Pchar('F:\0\text.jpg'),nil,nil,SW_SHOWNORMAL);
      {ADOQuery1.close;
      ADOQuery1.Parameters.ParamByName('Pa_LetterDataID').Value := IntToStr(QrLetterDataLetterDataID.AsInteger);
      ADOQuery1.ExecSQL;}



    //+IntToStr(QrLetterDataLetterDataID.AsInteger))
      //
      //Commented By Hamed_Ansari_990128
      //ADOQuery2.Close;
      //ADOQuery2.ExecSQL;
      Application.ProcessMessages;
   end;
end;

procedure TFmScanImage.xpBitBtn1Click(Sender: TObject);
begin
  inherited;
   Close;
end;
{Ranjbar 89.06.06 ID=3}
//Procedure TFmScanImage.Exec_UserLog(SenderTag:Integer);
Procedure TFmScanImage.Exec_UserLog(ActionName:String);
begin
  Try
     {Ranjbar 89.06.06 ID=3}
     //Exec_insert_UserLog(7000+SenderTag,LetterID);
     Exec_insert_UserLog(ActionName,LetterID);
     //---
  except
  end;
end;

Procedure TFmScanImage.ControlEnabled(Anabled:Boolean);
begin
   BBScan.Enabled := Anabled;
   BBOpenFile.Enabled := Anabled;
   if not Anabled then
   begin
      ImageEnVect1.LayersRemove(1);
      ImageEnVect1.Visible := false;    
   end;
end;

procedure TFmScanImage.FitToPageClick(Sender: TObject);
begin
  inherited;
    flag := 1;
//  ImageEnDBVect1.Fit;
  ImageEnDBView1.Fit;
  if ImageEnVect1.Visible then
     ImageEnVect1.FitToWidth;
  LabelZoom .Caption :='»“—ê‰„«ÌÌ  :    '+ FloatToStr( Round(ImageEnDBView1.Zoom) )+'%';
end;

procedure TFmScanImage.SpeedButton5Click(Sender: TObject);
begin
  inherited;
//  ImageEnDBVect1.FitToWidth;
 flag := 1;
  ImageEnDBView1.AutoFit := False;
  ImageEnDBView1.FitToWidth;
  if ImageEnVect1.Visible then
     ImageEnVect1.FitToWidth;
  LabelZoom .Caption :='»“—ê‰„«ÌÌ  :    '+ FloatToStr( Round(ImageEnDBView1.Zoom) )+'%';
end;

procedure TFmScanImage.SpeedButton4Click(Sender: TObject);
begin
  inherited;
  SpeedButton3Click(sender);
  ImageEnVect1.ObjBoxHighlight[-1] := False;
  ImageEnVect1.ObjPenColor[-1] := clYellow;
  ImageEnVect1.ObjBrushStyle[-1] := bsClear;
  ImageEnVect1.ObjMemoCharsBrushStyle[-1] := bsClear;
  ImageEnVect1.MouseInteractVt := [miPutBox];
end;

procedure TFmScanImage.SpeedButton9Click(Sender: TObject);
begin
  inherited;
  SpeedButton3Click(sender);
  ImageEnVect1.Proc.Rotate(180);
end;

procedure TFmScanImage.OpenFileExecute(Sender: TObject);
Var
   I,j,fn:integer;
   IsJpegFormat, isEdit:Boolean;
   FileNamePath : String;
   fs : TFileStream;
           var
    SaveFileUrl:string;
    ID:Integer;
    SaveFileName:string;
    ShowImageURL:String;
    FileNames:String;
begin
  inherited;
  if _SaveFileType='2' then
    begin
      OpenFileExecute_SQL(Sender);
      with TADOQuery.Create(Nil) do
      begin
       SQL.Clear;
       SQL.Add('delete from letterdata where pagenumber is null')   ;
       try
       Connection:=dm.YeganehConnection;
       ExecSQL;
       except
       end;
      free;
      end;
       try
       if ValueColorID<>-1 then
       except
       end;
    end
    else
      begin
              try
               if (_MyPuletColors <> '') and (_MyPuletColors <> '›«ﬁœ —‰ê') and (_MyPuletColors <> ' „«„ „Ê«—œ') then
                Edit1.Color:= StringToColor(_MyPuletColors);
              except
              end;
              if Not(DMScanImage.QrLetterData.State in [dsEdit,dsInsert]) then
                 Exit;

              IsJpegFormat :=  dm.GetValue(55);
              IsJpegFormat :=  dm.GetSystemValue(27);
              if IsJpegFormat then
                 OpenPictureDialog.filterindex := 1//Filter := 'JPEG Image File (*.jpg;*.jpeg)|*.jpeg;*.jpg'
              else
                 OpenPictureDialog.filterindex := 2;//Filter := 'Tiff(*.Tif)|*.Tif';

              if DMScanImage.QrLetterData.State =dsEdit then
                  isEdit := true;
              if isEdit then
              begin
                 OpenPictureDialog.Filter := 'JPEG Image File (*.jpg;*.jpeg)|*.jpeg;*.jpg' ;
              end
              else
              begin
                 OpenPictureDialog.Filter := 'JPEG Image File (*.jpg , *.jpeg)|*.jpeg;*.jpg|Tiff(*.tif , *.tiff)|*.tif;*.tiff';
              end;
              fn := DMScanImage.QrLetterDataLetterDataID.AsInteger;
              if OpenPictureDialog.Execute then
              begin
                 Try
                    Screen.Cursor := crHourGlass;
                    BBOpenFile.Enabled := False;
                    if (not IsJpegFormat) and (OpenPictureDialog.filterindex <> 2) then
                       if MessageDlg(' ’«ÊÌ— »’Ê—  ”Ì«Â Ê ”›Ìœ –ŒÌ—Â ‘Ê‰œø',mtConfirmation,[mbYes,mbNo],0)= mrNo then
                           IsJpegFormat := true;
                    For I:=0 to OpenPictureDialog.Files.Count-1 do
                    begin


                      FileNames:=OpenPictureDialog.Files.Strings[I];
                      SaveFileUrl:='C:\temp\tempimportimg'+ExtractFileExt(FileNames);
                      if FileExists(SaveFileUrl) then DeleteFile(SaveFileUrl);



                      CopyFile( Pansichar(FileNames), Pansichar(SaveFileUrl), False);
                      if _SaveFileType='2' then
                          SavenadLoadInDB(SaveFileUrl)
                      else
                       FillData(SaveFileUrl);



            //            _JpegFIleChange.SetBMPFileDPI(SaveFileUrl,StrToInt(  _BaseSQLConnection.GetKeyvalue('IMGDPI')));

                      {
                       if (UpperCase(File_GetFileExt(SaveFileUrl))='TIF')or(UpperCase(File_GetFileExt(SaveFileUrl))='TIFF')then
                       begin
                             ChangeMultyTifToTifsAndSave(SaveFileUrl);  //›«Ì· TIFF œ— Â— ’Ê—  »’Ê—  TIFF –ŒÌ—Â ‘Êœ
                       end
                       else if IsJpegFormat then  //›«Ì· JPG œ— ’Ê— Ì òÂ ›—„  Â„ JPG »«‘œ »« »’Ê—  JPG –ŒÌ—Â ‘Êœ
                       begin
                             FillData(SaveFileUrl);
                       end
                       else     // ›«Ì· JPG œ— ’Ê— Ì òÂ ›—„  TIFF »«‘œ Ê ÃÊ«» ”Ê«· »«·« YES »«‘œ »«Ìœ »’Ê—  TIFF –ŒÌ—Â ‘Êœ.
                       begin
                          if not FileExists(_TempPath+'\4.tif') then
                          begin
                              fs:=TFileStream.Create(_TempPath+'\4.tif',fmCreate);
                              idDecoderMIME1.DecodeToStream('SUkqAPQAAADIAAAAAQAAAMgAAAABAAAA///////////////////////////////////////////////+Tf'
                                    +'QMyTeYNkIHCdP1r6+vrX19fWvr6+tfXINA+vrr0v9L119del/peuvrr0v9L'
                                    +'119del/peuvrr669L119dfXXpeuvrr669L119dfXXpeuvrr669L119dfXXpeuvr/S/66X/XiQUzYO6f3/v//////31/fVq1JuMDS//////////'
                                    +'//////9qGFJuTDPH/////////////////////////////////////////////////////4AIAIBMA/gAEAAEAAAAAAAAAAAEEAAEAAAATAwAA'
                                    +'AQEEAAEAAAATAwAAAgEDAAEAAAABAAAAAwEDAAEAAAAEAAAABgEDAAEAAAAAAAAACgEDAAEAAAABAAAAEQEEAAEAAAA'
                                    +'YAAAAFQEDAAEAAAABAAAAFgEEAAEAAAATAwAAFwEEAAEAAADcAAAAGgEFAAEAAAAIAAAAGwEFAAEAAAAQAAAAHAEDAAEAAAABA'
                                    +'AAAJAEEAAEAAAAAAAAAJQEEAAEAAAAAAAAAKAEDAAEAAAACAAAAKQEDAAIAAAAAAAAARwEDAAEAAAAAAAAAAAAAAA==',fs);
                              fs.WriteBuffer(fs,fs.InstanceSize);
                              fs.Destroy;
                          end;
                          ChangeJPGToTifAndSave(SaveFileUrl);
                       end;
                       }
                    end;
                    Close_Open_QrLetterData;

                    if (DMScanImage.QrLetterData.State in [dsInsert,dsEdit]) then
                       DBN1.BtnClick(nbCancel);
                    Close_Open_QrLetterData;
                    DMScanImage.QrLetterData.Last;
                 Finally
            //        ImageEnDBVect1.FitToWidth;
                   // ImageEnDBView1.FitToWidth;
                    BBOpenFile.Enabled := True;
                    Screen.Cursor := crDefault;

                   if Dm.GetValue(2104) = 0 then
                     FitToPageClick(Self);
                   if Dm.GetValue(2104) = 1 then
                     SpeedButton5Click(Self);
                   if Dm.GetValue(2104) = 2 then
                     SpeedButton1Click(Self);

                 End;
              end;

              {Ranjbar 89.06.06 ID=3}
              //Exec_UserLog(TAction(Sender).Tag);
              Exec_UserLog(TAction(Sender).Name);
              //---

              {Ranjbar 89.07.08 ID=12}
              //LetterEdit À»   €ÌÌ—«  «⁄„«· ‘œÂ —ÊÌ ”‰œ œ— ÃœÊ·
              Dm.Insert_LetterEdit(LetterID,'«ÌÃ«œ  ’«ÊÌ— ÃœÌœ');
              Exec_insert_UserLog('InsertFile',LetterID);
              ControlEnabled(False);
              if isEdit then
                  DMScanImage.QrLetterData.Locate('LetterDataID',fn,[]);
              ImageEnDBView1.FitToWidth;
              //---
             if Dm.GetValue(2104) = 0 then
               FitToPageClick(Self);
             if Dm.GetValue(2104) = 1 then
               SpeedButton5Click(Self);
             if Dm.GetValue(2104) = 2 then
               SpeedButton1Click(Self);
               // Append Colors in Import Image
            //   if _CanAttachColor then
            //    begin
            //        try
            //          if Strtoint(Label3.Caption)>0 then
            //          begin
            //
            //              begin
            //                  qAttachColor.Close;
            //  //                qAttachColor.Parameters.ParamByName('ColorID').Value:=Dm.qDefineColorsID.AsInteger;
            //                  qAttachColor.Parameters.ParamByName('ColorID').Value:=Label3.Caption;
            //
            //                  qAttachColor.Parameters.ParamByName('LetterDataID').Value:=DMScanImage.QrSelImageLetterDataID.AsInteger;
            //                  qAttachColor.ExecSQL;
            //                  Exec_insert_UserLog('SetImageColor',DMScanImage.QrSelImageLetterID.AsInteger);
            //                  Dm.Insert_LetterEdit(DMScanImage.QrSelImageLetterID.AsInteger,'«‰ ’«» —‰ê »Â  ’ÊÌ—');
            //                    DMScanImage.QrLetterData.Close;
            //
            //               DMScanImage.QrLetterData.SQL.Text := 'Select LetterDataID ,LetterID ,PageNumber,ColorID  '+
            //                                                      'From LetterData  Where( LetterID = :Pa_LetterID )  And( Extention in (1,2) )  '+
            //                                                      'And ColorID='+Label3.Caption+' Order By PageNumber ';
            //               DMScanImage.QrLetterData.Open;
            //  //                ShowMsgString('«‰ ’«» —‰ê »« „Ê›ﬁÌ  «‰Ã«„ ‘œ');
            //              end;
            //          end
            //        except
            //
            //        end;
            //    end
            //  else
            //      ShowMsgString('„ÃÊ“  €ÌÌ—«  œ— ê—ÊÂ »‰œÌ ÅÌÊ”  Â« —« ‰œ«—Ìœ - »« „œÌ— ”Ì” „ ŒÊœ  „«” »êÌ—Ìœ');
                 try
                 if ValueColorID<>-1 then
                 except

               end ;
//                if _BaseSQLConnection.GetKeyvalue('SaveFileType')= '1' then
            end;
  if not Edit then
    if DMScanImage.QrLetterData.RecordCount = 1 then
      DBN1.VisibleButtons := [nbInsert,nbDelete,nbPost,nbEdit,nbCancel]
    else
      DBN1.VisibleButtons := [nbPrior,nbFirst,nbLast,nbNext,nbInsert,nbDelete,nbPost,nbEdit,nbCancel]
  else
      DBN1.VisibleButtons := [nbPrior,nbFirst,nbLast,nbNext];
end;


procedure TFmScanImage.ChangeMultyTifToTifsAndSave(aFileName:String);
Var
   I, TotalImages:integer; // 1391/10/11 Edited
   recCount : integer;
begin
      if aFileName <> '' then
      begin
         ImageEnMView1.Clear;
         ImageEnMView1.MIO.LoadFromFile(aFileName);
      end;
      For I:=0 to ImageEnMView1.ImageCount-1 do
      begin
         With DMScanImage do
         begin
            ImageEnMView1.MIO.SaveToFileTIFF(_TempPath+'\output'+IntToStr(i+1)+'.tif');
            ImageEnView1.io.LoadFromFileTIFF(_TempPath+'\output'+IntToStr(i+1)+'.tif');
            ImageEnView1.io.SaveToFileTIFF(_TempPath+'\output'+IntToStr(i+1)+'.tif');
            ImageEnView1.io.SaveToFileJpeg(_TempPath+'\output'+IntToStr(i+1)+'.jpg');
            ImageEnMView1.MoveImage(0,imageEnMView1.ImageCount-1);
            if QrLetterData.State=dsinsert then
            begin   ////////////////Insert
               quImage.Open;
               quImage.Insert;
               quImageLetterID.AsInteger := LetterID;
               quImagePageNumber.AsInteger := Dm.YeganehConnection.Execute('Select IsNull(Max(PageNumber),0)+1 As NextPageNumber '+
                             ' from LetterData Where LetterID = '+IntToStr(LetterID)).Fields[0].value;
               quImageDescription.AsString := aFileName;
               quImageLastUpdate.AsDateTime:= Now;
                if Get_File_Size1(_TempPath+'\output'+IntToStr(i+1)+'.tif',true)>Get_File_Size1(_TempPath+'\output'+IntToStr(i+1)+'.jpg',true) then
                begin
                  quImageextention.AsInteger := 1;
                  quImageImage.LoadFromFile(_TempPath+'\output'+IntToStr(i+1)+'.jpg');
                end
                else
                begin
                  quImageextention.AsInteger := 2;
                  quImageImage.LoadFromFile(_TempPath+'\output'+IntToStr(i+1)+'.tif');
                end;
                if ValueColorID <> -1 then
                  quImageColorID.AsInteger := ValueColorID ;//Dm.qDefineColorsID.AsInteger;

                quImage.Post;
               // quImage.Close;
                Application.ProcessMessages;
                if FileExists(_TempPath+'\output'+IntToStr(i+1)+'.tif') then
                    DeleteFile(_TempPath+'\output'+IntToStr(i+1)+'.tif');
                if FileExists(_TempPath+'\output'+IntToStr(i+1)+'.jpg') then
                    DeleteFile(_TempPath+'\output'+IntToStr(i+1)+'.jpg');
            end
            else   ///////////////// Edit
            begin
               QrSelImage.Edit;
               QrSelImageIsCorrectedImage.AsBoolean := true;
               QrSelImageLastUpdate.AsDateTime:= Now;
                if Get_File_Size1(_TempPath+'\output'+IntToStr(i+1)+'.tif',true)>Get_File_Size1(_TempPath+'\output'+IntToStr(i+1)+'.jpg',true) then
                begin
                  QrSelImageextention.AsInteger := 1;
                  QrSelImageImage.LoadFromFile(_TempPath+'\output'+IntToStr(i+1)+'.jpg');
                end
                else
                begin
                  QrSelImageextention.AsInteger := 2;
                  QrSelImageImage.LoadFromFile(_TempPath+'\output'+IntToStr(i+1)+'.tif');
                end;
                QrSelImage.Post;
              //  quImage.Close;
                Application.ProcessMessages;
                if FileExists(_TempPath+'\output'+IntToStr(i+1)+'.tif') then
                    DeleteFile(_TempPath+'\output'+IntToStr(i+1)+'.tif');
                if FileExists(_TempPath+'\output'+IntToStr(i+1)+'.jpg') then
                    DeleteFile(_TempPath+'\output'+IntToStr(i+1)+'.jpg');
            end;
         end;
      end;
      ImageEnMView1.Clear;
      PageControl1.Enabled := False;
      ControlEnabled(False);
end;

procedure TFmScanImage.SaveAsExecute(Sender: TObject);
var
   fName : string;
begin
  inherited;
  if SavePictureDialog.Execute then
  begin

     if SavePictureDialog.FilterIndex=1 then
         fName := SavePictureDialog.FileName+'.jpg'
     else if SavePictureDialog.FilterIndex=2 then
         fName := SavePictureDialog.FileName+'.tiff'
     else if SavePictureDialog.FilterIndex=3 then
         fName := SavePictureDialog.FileName+'.bmp';

     if FileExists(fName) then
     begin
         if MBaseForm.MessageShowString(' ’ÊÌ—Ì »Â «Ì‰ ‰«„ „ÊÃÊœ «” ° ¬Ì« „«Ì·Ìœ »Â Â„Ì‰ ‰«„ –ŒÌ—Â ‘Êœø', True) then
         begin
            if SavePictureDialog.FilterIndex=1 then
               ImageEnDBView1.IO.SaveToFileJpeg(fName)
            else if SavePictureDialog.FilterIndex=2 then
               ImageEnDBView1.IO.SaveToFileTIFF(fName)
            else if SavePictureDialog.FilterIndex=3 then
               ImageEnDBView1.IO.SaveToFileBMP(fName);
            ShellExecute(Handle, 'Open',Pchar(fName),nil,nil,SW_SHOWNORMAL);
         end
         else
            SaveAsExecute(sender);
     end
     else
     begin
         if SavePictureDialog.FilterIndex=1 then
            ImageEnDBView1.IO.SaveToFileJpeg(fName)
         else if SavePictureDialog.FilterIndex=2 then
            ImageEnDBView1.IO.SaveToFileTIFF(fName)
         else if SavePictureDialog.FilterIndex=3 then
            ImageEnDBView1.IO.SaveToFileBMP(fName);
         ShellExecute(Handle, 'Open',Pchar(fName),nil,nil,SW_SHOWNORMAL);
     end;
  end;

  Exec_UserLog(TAction(Sender).Name);
  //---  
end;

procedure TFmScanImage.BitBtn2Click(Sender: TObject);
begin
  inherited;
{  SignPic.Execute; //SignPicExecute
  Exec_UserLog(TBitBtn(Sender).Tag);
}
end;

procedure TFmScanImage.BitBtn3Click(Sender: TObject);
begin
  inherited;
  SpeedButton3Click(sender);
  ImageEnProc1.ConvertToGray;
end;

procedure TFmScanImage.BitBtn7Click(Sender: TObject);
begin
  inherited;
  SpeedButton3Click(sender);
  ImageEnProc1.ConvertToBWThreshold(spinedit1.value);
end;

procedure TFmScanImage.ImageEnDBView3Click(Sender: TObject);
begin
  inherited;
  ImageEnDBView1.SaveSelectionToFile('c:\1.jpeg');
end;

procedure TFmScanImage.DBN1BeforeAction(Sender: TObject;Button: TNavigateBtn);
Var
   ID:Integer;
   FilePathName : String;
begin
  inherited;

  if Button = nbFirst   then DMScanImage.NavigatorButtons:='nbFirst';
  if Button = nbPrior   then DMScanImage.NavigatorButtons:='nbPrior';
  if Button = nbNext    then DMScanImage.NavigatorButtons:='nbNext';
  if Button = nbLast    then DMScanImage.NavigatorButtons:='nbLast';
  if Button = nbInsert  then DMScanImage.NavigatorButtons:='nbInsert';
  if Button = nbDelete  then DMScanImage.NavigatorButtons:='nbDelete';
  if Button = nbEdit    then DMScanImage.NavigatorButtons:='nbEdit';
  if Button = nbPost    then DMScanImage.NavigatorButtons:='nbPost';
  if Button = nbCancel  then DMScanImage.NavigatorButtons:='nbCancel';
  if Button = nbRefresh then DMScanImage.NavigatorButtons:='nbRefresh';

  SBZoom.Click;
  SBZoom.down := True;

  if Button in [nbInsert,nbEdit] then
  begin
     PageControl1.Enabled := True;
     if Panel6.Width>0 then
     begin
            ImageEnDBVect1.LayersRemove(1);//
           ImageEnVect1.DeSelect;
           ImageEnVect1.UnSelAllObjects;
           ImageEnVect1.LayersMergeAll;
           ImageEnVect1.RemoveAllObjects;
         ImageEnVect1.Align := alClient;
         ImageEnVect1.Zoom := ImageEnView1.Zoom;
//         ImageEnVect1.IO.IEBitmap.Assign(ImageEnDBView1.IO.IEBitmap);
         ImageEnDBView1.IO.SaveToFileJpeg(_TempPath+'\t.jpg');
         ImageEnVect1.IO.LoadFromFileJpeg(_TempPath+'\t.jpg');
         ImageEnVect1.Repaint;
         ImageEnVect1.Visible := true;
     end
     else
     begin
    {    PageControl1.Enabled := False;
        ImageEnDBVect1.LayersRemove(1);//
           ImageEnVect1.DeSelect;
           ImageEnVect1.UnSelAllObjects;
           ImageEnVect1.LayersMergeAll;
           ImageEnVect1.RemoveAllObjects;
        ImageEnDBView1.IO.IEBitmap.Assign(ImageEnVect1.IO.IEBitmap);
        ImageEnVect1.Visible := false;
        ImageEnVect1.Align := alNone;  }
     end;
  end;

  if button = nbPost then
  begin
       if ImageEnVect1.Visible then
       begin
         ImageEnDBVect1.LayersRemove(1);//
           {Ranjbar 90.03.11 ID=378}
           ImageEnVect1.DeSelect;
           ImageEnVect1.UnSelAllObjects;
           ImageEnVect1.LayersMergeAll;  //????? ????? ??? ?? ?? ????? ?? ???
           ImageEnVect1.RemoveAllObjects;
//         ImageEnDBView1.IO.IEBitmap.Assign(ImageEnVect1.IO.IEBitmap);
         ImageEnVect1.Visible := false;
         ImageEnVect1.Align := alNone;
       end;
  end;

  With DMScanImage do
  begin
     if Button = nbEdit then
     begin
        QrSelImage.Edit;
        QrSelImageLastUpdate.AsDateTime := Now;
     end;

     if Button in [nbPost,nbDelete] then
     begin
        if Button = nbPost then
        begin
           if ImageEnDBView1.IsEmpty then
           begin
              MBaseForm.messageShowString('·ÿ›«  ’ÊÌ— —« ÃÂ  –ŒÌ—Â «‰ Œ«» ‰„«ÌÌœ', False);
              Abort;
           end;

           {ImageEnDBVect1.Fit;
           ImageEnDBVect1.LayersCurrent := 0;
           ImageEnDBVect1.Select(0,0,ImageEnDBVect1.IEBitmap.Width,ImageEnDBVect1.IEBitmap.Height);
           ImageEnDBVect1.Proc.Crop(Rect(ImageEnDBVect1.SelX1,ImageEnDBVect1.SelY1,ImageEnDBVect1.SelX2,ImageEnDBVect1.SelY2));
           ImageEnDBVect1.DeSelect;
           While ImageEnDBVect1.LayersCount > 1 do
              ImageEnDBVect1.LayersMerge(0,1);
           //ImageEnDBVect1.LayersMergeAll;//«‘Ì«Ì «÷«›Â ‘œÂ —« Â„  —ﬂÌ» „Ì ﬂ‰œ
           }
           ImageEnVect1.LayersRemove(1);//
           {Ranjbar 90.03.11 ID=378}
           ImageEnVect1.DeSelect;
           ImageEnVect1.UnSelAllObjects;
           ImageEnVect1.LayersMergeAll;  //«‘Ì«Ì «÷«›Â ‘œÂ —« Â„  —ﬂÌ» „Ì ﬂ‰œ
           ImageEnVect1.RemoveAllObjects;

           QrSelImageLastUpdate.AsDateTime := Now;
           QrSelImageLetterID.AsInteger := fmScanImage.LetterID;


           //Image Å” «“ ⁄„· ÊÌ—«Ì‘ Ê –ŒÌ—Â °  ’«ÊÌ—  Ê”ÿ ﬂ‰ —·
           //Ì« œ— Ê» ‰„«Ì‘ œ«œÂ ‰„Ì ‘Êœ »‰«»—«Ì‰ »«Ìœ «“ œ” Ê—«  “Ì— «” ›«œÂ ﬂ—œ
           if QrSelImage.State = dsEdit then
           begin
              FilePathName := _TempPath + 'TempEditFile.Jpg';
              DeleteFile(FilePathName);
              //Hamed_Ansari_990130_S
              ImageEnVect1.IO.SaveToFileJpeg(FilePathName);
              //ImageEnDBView1.IO.SaveToFileJpeg(FilePathName);
              ImageEnVect1.Clear;
              //ImageEnDBView1.Clear;
              //Hamed_Ansari_990130_E
//              QrSelImageImage.LoadFromFile(FilePathName);
              FillData(FilePathName);
              Application.ProcessMessages;
              DeleteFile(FilePathName);
              if QrSelImageIsCorrectedImage.AsBoolean = False then
                 QrSelImageIsCorrectedImage.AsBoolean := True;
           end;
           //---

//           QrSelImage.Post;
     //      1
     ImageEnDBVect1.FitToWidth;
           ImageEnDBView1.FitToWidth;
           ControlEnabled(False);
        end;
        if Button = nbDelete then
        begin
           if MBaseForm.messageShowString('¬Ì« „«Ì· »Â Õ–›  ’ÊÌ— Ã«—Ì Â” Ìœø', True) then
           begin
              QrSelImage.Delete;

              {Ranjbar 89.07.08 ID=12}
              //LetterEdit À»   €ÌÌ—«  «⁄„«· ‘œÂ —ÊÌ ”‰œ œ— ÃœÊ·
              Dm.Insert_LetterEdit(LetterID,'Õ–› Ìﬂ  ’ÊÌ—');
              Exec_insert_UserLog('DeleteOnePicture',LetterID);
              //---

            Dm.qSelectedColor.Close;
            Dm.qSelectedColor.Parameters.ParamByName('LetterID').Value:=LetterID;
            Dm.qSelectedColor.Open;

            Dm.qSelectedColor.Locate('ColorId',SelecttionColorId,[loCaseInsensitive]);


           ControlEnabled(False);
           qry_updatePageNumber.Close;
           qry_updatePageNumber.Parameters.ParamByName('Pa_LetterID').Value := LetterID;
           qry_updatePageNumber.ExecSQL;
           Close_Open_QrLetterData;
           end;
        end;
        ID := QrLetterDataLetterDataID.AsInteger;
        QrLetterData.Cancel;
        ControlEnabled(False);
        if ID > 0 then
           QrLetterData.Locate('LetterDataID',ID,[])
        else
           QrLetterData.Last;
        Abort;
     end;
  end;//With

end;

procedure TFmScanImage.ScanExecute(Sender: TObject);
Var
   FilenamePath, filename :String;
   i, v803 : integer;
begin
   inherited;
 if _SaveFileType='2' then
  ScanSQl
  else
  begin
   DMScanImage._IsScan:=True;
  try
   if (_MyPuletColors <> '') and (_MyPuletColors <> '›«ﬁœ —‰ê') and (_MyPuletColors <> ' „«„ „Ê«—œ') then
     Edit1.Color:= StringToColor(_MyPuletColors)
   else
    Edit1.Color:= clBtnFace;
  except
  end;
   if dm.GetValue(807) = true then
      TWAIN_SetHideUI(false)
   else
      TWAIN_SetHideUI(true);
   TWAIN_SetFileAppendFlag(false);
   //   TWAIN_SetJpegQuality((dm.GetValue(802)+1)*10); Commented By Hamed_Ansari_990130
   TWAIN_SetResolution(StrToInt(_IMGDPI));
   if TWAIN_OpenDefaultSource() then
   begin
      TWAIN_SetXferCount(-1);
      TWAIN_SetAutoScan(true);
      TWAIN_SetMultiTransfer(true);
      if dm.GetValue(801) = 0 then
         TWAIN_SetPixelType(TWPT_BW)
      else if dm.GetValue(801) = 1 then
         TWAIN_SetPixelType(TWPT_GRAY)
      else if dm.GetValue(801) = 2 then
         TWAIN_SetPixelType(TWPT_RGB);
      if (dm.GetValue(805) = 1)and(TWAIN_HasFeeder) then
         TWAIN_SelectFeeder(true)
      else
         TWAIN_SelectFeeder(false);
      If (TWAIN_GetDuplexSupport > 0) Then   // check for duplex support
      begin
         if (dm.GetValue(806) = 1)and(TWAIN_HasFeeder) then
            TWAIN_EnableDuplex(true)
         else
            TWAIN_EnableDuplex(false);
      end;
      i := 1;
      v803 := dm.GetValue(803);
      repeat
         if v803=0 then
            fileName := _TempPath +'image'+IntToStr(i)+'.jpg'
         else
            fileName := _TempPath +'image'+IntToStr(i)+'.tif';
         if (TWAIN_AcquireToFilename(self.Handle, pchar(fileName))<>0) then
            break;
           try
                ImageEnVect1.IO.LoadFromFile(filename);
                 ImageEnDBView1.IO.LoadFromFile(filename);

                Application.ProcessMessages;
              except
              end;
         LoadAndShow(fileName);
         if not(DMScanImage.QrLetterData.State in [dsedit,dsinsert]) then
            break;
         i := i+1;
                   if _BaseSQLConnection.GetKeyvalue('SaveFileType')= '1' then
                 DeleteFile(filename);
      until TWAIN_IsDone();
      TWAIN_CloseSource();
      DMScanImage.QrLetterData.Cancel;
      Close_Open_QrLetterData;
      DMScanImage.QrLetterData.Last;
   end;

   if Dm.GetValue(2104) = 0 then
     FitToPageClick(Self);
   if Dm.GetValue(2104) = 1 then
     SpeedButton5Click(Self);
   if Dm.GetValue(2104) = 2 then
     SpeedButton1Click(Self);
    LetterID:=StrToInt(_MyLetterID);

   if TWAIN_LastErrorCode()<>0 then
      TWAIN_ReportLastError(pchar('Œÿ« œ— «”ò‰  ’«ÊÌ—'+ '   '+ ' ERROR CODE : '+ inttostr(TWAIN_LastErrorCode())));

 // Exec_UserLog(TAction(Sender).Name);
    Dm.Insert_LetterEdit(LetterID,'«ÌÃ«œ  ’ÊÌ— ÃœÌœ «“ ÿ—Ìﬁ «”ò‰—');
     Exec_insert_UserLog('Scan',LetterID);
         DMScanImage._IsScan:=False;

  end;

  if not Edit then
    if DMScanImage.QrLetterData.RecordCount = 1 then
      DBN1.VisibleButtons := [nbInsert,nbDelete,nbPost,nbEdit,nbCancel]
    else
      DBN1.VisibleButtons := [nbPrior,nbFirst,nbLast,nbNext,nbInsert,nbDelete,nbPost,nbEdit,nbCancel]
  else
      DBN1.VisibleButtons := [nbPrior,nbFirst,nbLast,nbNext];
end;

procedure TFmScanImage.BrushColorClick(Sender: TObject);
begin
   inherited;
   ColorDialog1.Color := BrushColor.Color;
   if ColorDialog1.Execute then
      BrushColor.Color:=ColorDialog1.Color;
   CreateBrush(self);
end;

procedure TFmScanImage.FormCreate(Sender: TObject);
begin
  inherited;
  InitializeDBADVGroup;
  ImageEnVect1.LayersSync := false;
  ImageEnVect1.MinBitmapSize:=1;
  //ImageEnDBVect1.DisplayGrid:=true;
  ImageEnView1.Proc.Fill( CreateRGB(255,255,255) );
  ImageEnView1.Proc.AutoUndo:=False;

  Panel6.Width:=0;
  Panel7.Width:=0;

  Dm.qDefineColors.Close;
  Dm.qDefineColors.Open;
  DSForm.DataSet:=Dm.qDefineColors;

//  TDrawGrid(DBGrid1).FixedCols:=0;
  dsqSelectedColor.DataSet:=Dm.qSelectedColor;
  DBGrid2.DataSource:=dsqSelectedColor;
  N5.Enabled := Dm.GetActionAccess('SetImageColor',9);
  N6.Enabled := Dm.GetActionAccess('RemoveImageColor',9);
//  FitToPageClick(Self);
 if Dm.GetValue(2104) = 0 then
   FitToPageClick(Self);
 if Dm.GetValue(2104) = 1 then
   SpeedButton5Click(Self);
 if Dm.GetValue(2104) = 2 then
   SpeedButton1Click(Self);

end;


procedure TFmScanImage.BitBtn9Click(Sender: TObject);
begin
   inherited;
   SpeedButton3Click(sender);
   ImageEnVect1.MouseInteractVt := [miPutText];
   ImageEnVect1.ObjPenColor[-1] := FontDialog1.Font.Color;
   ImageEnVect1.ObjBrushColor[-1] := clNone;
   ImageEnVect1.ObjFontStyles[-1] := FontDialog1.Font.Style;
   ImageEnVect1.ObjFontHeight[-1] :=  FontDialog1.Font.Height;
end;

procedure TFmScanImage.ImageEnMView1ImageSelect(Sender: TObject;
  idx: Integer);
begin
  inherited;
  // Copy image
  Try
     ImageEnMView1.CopyToIEBitmap( idx, ImageEnVect1.IEBitmap );
     //ImageEnMView1.MIO.Params[idx].ImagingAnnot.CopyToTImageEnVect(ImageEnDBVect1);
     ImageEnVect1.Update;
  Except

  End;
end;

procedure TFmScanImage.RGOperationClick(Sender: TObject);
begin
  inherited;
  CreateBrush(Sender);
end;

procedure TFmScanImage.RGPenTypeClick(Sender: TObject);
begin
  inherited;
  CreateBrush(Sender);
end;

procedure TFmScanImage.SEBrushSizeChange(Sender: TObject);
begin
  inherited;
  CreateBrush(Sender);
end;

procedure TFmScanImage.ImageEnDBVect1MouseDown(Sender: TObject;
  Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  inherited;

  if SbBrush.Down then
  begin
     StartX:=X;
     startY:=Y;
     if (PageControl1.ActivePage=BrushTab) then
        ImageEnDBVect1MouseMove(self,Shift,X,Y);
  end;
end;

procedure TFmScanImage.CreateBrush(Sender: TObject);
Var
   BrushSiz:integer;
   C:TColor;
   Transpvalue:integer;
   I:integer;
   X,Y:integer;
begin
  if ImageEnVect1.LayersCount=1 then
     ImageEnVect1.LayersAdd;
  ImageEnVect1.LayersCurrent:=1;

  BrushSiz := SEBrushSize.Value;

  ImageEnVect1.Proc.ImageResize(BrushSiz,BrushSiz,iehLeft,ievTop);

  // prepare main color
  ImageEnVect1.IEBitmap.Canvas.Brush.Color:= BrushColor.Color;
  ImageEnVect1.IEBitmap.Canvas.Pen.Color:=BrushColor.Color;

  // prepare alpha channel
  ImageEnVect1.AlphaChannel.Fill(0);
  
  with ImageEnVect1.AlphaChannel.Canvas do
  begin
     Transpvalue:=255;
     C := $02000000 or (transpvalue) or (transpvalue shl 8) or (transpvalue shl 16);
     Brush.Color:= c;
     Pen.Color:=c;
  end;

  if RGPenType.ItemIndex = 0 then //„—»⁄Ì RectangleButton.Down
  begin
     ImageEnVect1.IEBitmap.Canvas.Rectangle(0,0,BrushSiz+1,BrushSiz+1);
     ImageEnVect1.AlphaChannel.Canvas.Rectangle(0,0,BrushSiz+1,BrushSiz+1);
  end
     else
        if RGPenType.ItemIndex = 1 then //œ«Ì—Â «Ì  CircleButton.Down
        begin
           ImageEnVect1.IEBitmap.Canvas.Ellipse(0,0,BrushSiz+1,BrushSiz+1);
           ImageEnVect1.AlphaChannel.Canvas.Ellipse(0,0,BrushSiz+1,BrushSiz+1);
        end;

  ImageEnVect1MouseMove(self,[],0,0); // refresh current brush
end;

procedure TFmScanImage.ImageEnDBVect1MouseMove(Sender: TObject;
  Shift: TShiftState; X, Y: Integer);
Var
  px,py:integer;
  bx,by:integer;
  op:TIERenderOperation;
  Operation : Byte;
begin
   //Œÿ ﬂ‘
  {HorizRuler.GripsPos[0] := ImageEnDBVect1.XScr2Bmp( X );
  VertRuler.GripsPos[0]  := ImageEnDBVect1.YScr2Bmp( Y );}
  //---

  if SBBrush.Down then
  begin
       Operation := 0;
       OP := TIERenderOperation(Operation);
       with ImageEnDBVect1 do
         if LayersCount=2 then
         begin
           with Layers[1] do
           begin
              bx := Bitmap.Width;
              by := Bitmap.Height;
              px := XScr2Bmp(X) - Width div 2;
              py := YScr2Bmp(Y) - Height div 2;
              PosX := px;
              PosY := py;
              Operation := op;
           end;
           if MouseCapture then  // paint the layer (the brush...)
           begin
               Layers[1].Bitmap.RenderToTIEBitmapEx( Layers[0].Bitmap, px,py,bx,by, 0,0,bx,by, 255,rfNone,op );
               Layers[1].Bitmap.MergeAlphaRectTo( Layers[0].Bitmap, 0,0,px,py, bx,by);
           end;
           Update;
         end;
     lastX:=X;
     lastY:=Y;
  end;

end;

procedure TFmScanImage.SpeedButton1Click(Sender: TObject);
begin
  inherited;
    flag := 1;
//  ImageEnDBVect1.Zoom := 100;
  ImageEnDBView1.AutoFit := False;
  ImageEnDBView1.Zoom := 100;
  if ImageEnVect1.Visible then
     ImageEnVect1.Zoom := 100;
  LabelZoom .Caption :='»“—ê‰„«ÌÌ  :    '+ FloatToStr( Round(ImageEnDBView1.Zoom) )+'%';

end;

procedure TFmScanImage.SpeedButton3Click(Sender: TObject);
begin
  inherited;
  //(Sender);
  ImageEnVect1.MouseInteractVt := [miObjectSelect];
  ControlAnable(False);
  SBBrush.Down := false;
  SpeedButton3.Down := true;
end;

procedure TFmScanImage.SBZoomClick(Sender: TObject);
begin
  inherited;
//  ImageEnDBView1.MouseInteract := [miZoom,miScroll];
   ImageEnVect1.MouseInteract := [miZoom,miScroll];
   ControlAnable(False); //HKH Sisabled
end;

procedure TFmScanImage.SpeedButton13Click(Sender: TObject);
begin
  inherited;
  //ImageEnDBVect1.RotateAllObjects(-90,ierImage);
  SpeedButton3Click(sender);
     ImageEnVect1.Proc.Rotate(-90);
end;

procedure TFmScanImage.SpeedButton12Click(Sender: TObject);
begin
  inherited;
  //ImageEnDBVect1.RotateAllObjects(90,ierImage);
  SpeedButton3Click(sender);
  ImageEnVect1.Proc.Rotate(90);

end;

procedure TFmScanImage.ImageEnDBVect1NewObject(Sender: TObject;
  hobj: Integer);
begin
  inherited;
  ImageEnVect1.MouseInteractVt := [miObjectSelect];
end;

procedure TFmScanImage.ImageEnDBVect1KeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
var
  i: integer;
begin
  inherited;
  if Key = Vk_Delete then
  begin
     For i := ImageEnDBVect1.SelObjectsCount - 1 downto 0 do
        ImageEnDBVect1.RemoveObject(ImageEnDBVect1.SelObjects[i]);
  end;

  ImageEnDBVect1.Proc.SaveUndo();
end;

procedure TFmScanImage.SpeedButton6Click(Sender: TObject);
var
  i: integer;
begin
  inherited;
  SpeedButton3Click(sender);
  For i := ImageEnVect1.SelObjectsCount - 1 downto 0 do
      ImageEnVect1.RemoveObject(ImageEnVect1.SelObjects[i]);
end;

procedure TFmScanImage.SpeedButton10Click(Sender: TObject);
var
  I, Obj: integer;
begin
  inherited;
  SpeedButton3Click(sender);
  obj := -1;
  if FontDialog1.Execute then
     For I := -1 to ImageEnVect1.SelObjectsCount - 1 do
     begin
       if I >= 0 then
          Obj := ImageEnVect1.SelObjects[I];
       ImageEnVect1.ObjPenColor[obj] := FontDialog1.Font.Color;
       ImageEnVect1.ObjFontStyles[-1] := FontDialog1.Font.Style;
       ImageEnVect1.ObjFontHeight[-1] :=  FontDialog1.Font.Height ;
     end;
end;

procedure TFmScanImage.SetTextFontColor;
begin
   ///
end;

procedure TFmScanImage.SpeedButton11Click(Sender: TObject);
begin
  inherited;
  SpeedButton3Click(sender);
  ImageEnVect1.MouseInteractVt := [miPutBox];
  ImageEnVect1.ObjBoxHighlight[-1] := True;
  ImageEnVect1.ObjBrushColor[-1] := clYellow;
  ImageEnVect1.ObjBrushStyle[-1] := bsSolid;
end;

procedure TFmScanImage.SignPicExecute(Sender: TObject);
Var
   StreamPic :TStream;
begin
  inherited;
{  Open_UserSign(_Userid);
  if dm.Select_UserSignUserSign.IsNull then
  begin
     MBaseForm.messageShowString('ò«—»— ê—«„Ì ‘„« œ«—«Ì «„÷«Ì  ’ÊÌ—Ì ‰„Ì»«‘œ', False);
     Exit;
  end;
  Try
     StreamPic := TStream.Create;
     StreamPic :=  dm.Select_UserSign.CreateBlobStream(dm.Select_UserSignUserSign,bmRead);
     ImageEnDBVect1.SetObjBitmapFromStream(-1,StreamPic,0);
     ImageEnDBVect1.MouseInteractVt := [miPutBitmap];
  Finally
     StreamPic.Free;
  End; }
end;

procedure TFmScanImage.CBHideObjectsClick(Sender: TObject);
begin
  inherited;
  SpeedButton3Click(sender);
  if CBHideObjects.Checked then
     ImageEnVect1.AllObjectsHidden := True
  else
     ImageEnVect1.AllObjectsHidden := False;
end;

procedure TFmScanImage.BBUndoClick(Sender: TObject);
begin
  inherited;
//  SpeedButton3Click(sender);
  if SBBrush.Down then
     ImageEnVect1.Proc.Undo
  else
     begin
        ImageEnVect1.ObjUndo;
        ImageEnVect1.ObjClearUndo;
     end;
end;

procedure TFmScanImage.FormKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  inherited;
  if (ssCtrl in shift)And(DMScanImage.QrLetterData.State in [dsEdit,dsInsert]) then
     if (Key = Word('z'))or(Key = Word('Z')) then
        BBUndo.Click;
  if Key = Vk_Escape then
     Close;
end;

procedure TFmScanImage.ControlAnable(anable:Boolean);
begin
   RGPenType.Enabled := anable;
   Label1.Enabled := anable;
   Label7.Enabled := anable;
   SEBrushSize.Enabled := anable;
   BrushColor.Enabled := anable;
   if not anable then
      ImageEnVect1.Cursor := 1785;
end;


procedure TFmScanImage.SBBrushClick(Sender: TObject);
begin
  inherited;

  ControlAnable(True);
  ImageEnVect1.MouseInteract := [];
  CreateBrush(Sender);
end;

procedure TFmScanImage.ImageEnIO1AcquireBitmap(Sender: TObject;
  ABitmap: TIEBitmap; var Handled: Boolean);
begin
  inherited;
  if not(DMScanImage.QrSelImage.State = dsInsert) then
     DBN1.BtnClick(nbInsert);

  DBN1.BtnClick(nbPost);
  Application.ProcessMessages;

end;

procedure TFmScanImage.AprinttExecute(Sender: TObject);
begin
   inherited;
   if DMScanImage.QrSelImage.State in [dsInsert,dsEdit] then
   begin
      MBaseForm.MessageShowString('·ÿ›« «ÿ·«⁄«  ŒÊœ —«  –ŒÌ—Â ‰„«ÌÌœ', False);
      Exit;
   end;
   FmPrint := TFmPrint.Create(nil);
   FmPrint.ShowModal;
   {Ranjbar 89.06.06 ID=3}
   //Exec_UserLog(TAction(Sender).Tag);
   Exec_UserLog(TAction(Sender).Name);
   //---
end;

procedure TFmScanImage.BBAllScanImageClick(Sender: TObject);
var
  I, RecNo:Integer;
  FilePatch,NewURL:string;
begin
   inherited;
   DMScanImage.SPAllImage.Close;
   DMScanImage.SPAllImage.Parameters.ParamByName('@LetterID').Value := LetterID;
   DMScanImage.SPAllImage.Open;
   FmAllScanImage := TFmAllScanImage.Create(Application);
   Try
      FmAllScanImage.ShowModal;
      if FmAllScanImage.Valueid = 0 then
        DMScanImage.QrLetterData.Locate('LetterDataID', DMScanImage.SPAllImageLetterDataID.AsInteger,[]);
      FmAllScanImage.Valueid := 0;
   Finally
      //
//      try
//       DMScanImage.SPAllImage.RecNo:=1;
//      for I  := 1 to DMScanImage.SPAllImage.RecordCount do
//        begin
//          try
//            with DMScanImage do
//            begin
//              if FmAllScanImage.ImageIDSelector<> SPAllImage.fieldbyname('LetterDataID').AsString then
//              begin
//
//              FilePatch:=SPAllImage.fieldbyname('Filetype').AsString;
//              DeleteFile(FilePatch);
//              Application.ProcessMessages;
//              end;
//
//            end;
//          except
//
//          end;
//          DMScanImage.SPAllImage.Next;
//        end;
//        except
//        end;
        DMScanImage.SPAllImage.Close;
   End;
end;

procedure TFmScanImage.ActSelScannerExecute(Sender: TObject);
begin
   inherited;

//   if dm.GetValue(25) then //True = Jpg , False = Tif
//   begin
//      if ImageEnIO1.SelectAcquireSource {(ieaTWain)} then
//         dm.SetValue(56 , ImageEnIO1.TWainParams.SelectedSource);
//   end
//   else
//      begin
//         (*if ImageEnMIO1.SelectAcquireSource {(ieaTWain)} then
//            dm.SetValue(56 , ImageEnMIO1.TWainParams.SelectedSource);*)
//         ImgScan.ShowSelectScanner;
//      end;
   TWAIN_SelectImageSource(self.Handle)
   //dm.SetValue(56 , );
end;

procedure TFmScanImage.SpeedButton2Click(Sender: TObject);
begin
   inherited;
      FmImageData := TFmImageData.Create(nil);
      FmImageData.ShowModal;
end;

procedure TFmScanImage.SBResizeClick(Sender: TObject);
begin
   inherited;
   SpeedButton3Click(sender);
   FmPicProgress := TFmPicProgress.Create(nil);
   FmPicProgress.PicWidth := ImageEnVect1.Bitmap.Width;
   FmPicProgress.PicHight := ImageEnVect1.Bitmap.Height;
   FmPicProgress.FormStyle := fsStayOnTop;
   FmPicProgress.Show;
end;

procedure TFmScanImage.SBDelAllDataClick(Sender: TObject);
begin
   inherited;
   if MBaseForm.MessageShowString('¬Ì« „«Ì· »Â Õ–›  „«„Ì  ’«ÊÌ— Â” Ìœø', True) then
   begin
      With DMScanImage do
      begin
         QrLetterData.First;
         while not QrLetterData.Eof do
         begin
            QrDelLetterData.Close;
            QrDelLetterData.Parameters.ParamByName('LetterDataID').Value := QrLetterDataLetterDataID.AsInteger;
            QrDelLetterData.ExecSQL;
            QrLetterData.Next;
         end;
         QrLetterData.Close;
         QrLetterData.open;
         ShowPageCount;
      end;
     { With DMScanImage do
         Try
            if QrLetterData.RecordCount = 0 then
               Exit;
            QrDelLetterData.Parameters.ParamByName('LetterID').Value := LetterID;
            QrDelLetterData.ExecSQL;
            Close_Open_QrLetterData;
            QrLetterData.Last;

         Finally
            QrDelLetterData.Close;
         end;     }
      {Ranjbar 89.07.08 ID=12}
      //LetterEdit À»   €ÌÌ—«  «⁄„«· ‘œÂ —ÊÌ ”‰œ œ— ÃœÊ·
      Dm.Insert_LetterEdit(LetterID,'Õ–›  „«„Ì  ’«ÊÌ—');
      Exec_insert_UserLog('DeleteAllPictures',letterID);
      //---
      Edit1.Color:= clBtnFace;

      Dm.qSelectedColor.Close;
      Dm.qSelectedColor.Open;
   end;
end;

procedure TFmScanImage.SBGoToPageClick(Sender: TObject);
Var
   PageNumber:String;
begin
   inherited;
   if DMScanImage.QrLetterData.RecordCount = 0 then
      Exit;
   PageNumber := InputBox('‘„«—Â ’›ÕÂ  ’ÊÌ—','·ÿ›« ‘„«—Â ’›ÕÂ —« Ê«—œ ‰„«ÌÌœ', IntToStr(DMScanImage.QrLetterData.RecNo));
   if StrToIntDef(PageNumber,0) > 0 then
      {Ranjbar 89.07.05 ID=25}
      //DMScanImage.QrLetterData.RecNo := StrToIntDef(PageNum,0);
      DMScanImage.QrLetterData.RecNo := StrToInt(PageNumber);//Locate('PageNumber',PageNumber,[]);
      //---
end;

procedure TFmScanImage.Timer1Timer(Sender: TObject);
begin
  inherited;
//   ImageEnDBVect1.FitToWidth;
   ImageEnDBView1.FitToWidth;
   Timer1.Enabled := False;
end;

procedure TFmScanImage.ASaveAllExecute(Sender: TObject);
var
   I,FirstPg,StartPg,EndPg,NextPg : Integer;
   HasPage : Boolean;
   Dir , FileName: string;
   FileNu:integer;
begin
  inherited;
  FileNu := 0;
  if DMScanImage.QrLetterData.RecordCount = 0 then
     Exit;

  Try
     BBSaveAllToFiles.Enabled := False;
     Screen.Cursor := crHourGlass;

     if SaveDialog1.Execute then
        Dir := SaveDialog1.FileName;
     //Dir := _TempPath+'YeganehPic';
     if not DirectoryExists(Dir) then
        CreateDir(Dir)
     else
        EmptyDir(Dir);

     With DMScanImage do
     begin

         QrLetterData.First;
         while not QrLetterData.Eof do
         begin
            Sleep(1);
            if QrSelImageextention.AsInteger=1 then
               FileName := Dir+'\'+Trim(QrSelImageLetterID.AsString)+'_'+IntToStr(QrLetterData.RecNo)+'.jpg'
            else
               FileName := Dir+'\'+Trim(QrSelImageLetterID.AsString)+'_'+IntToStr(QrLetterData.RecNo)+'.tiff';
//            QrSelImageImage.SaveToFile(FileName);
 ImageEnDBView1.IO.SaveToFile(FileName);
            QrLetterData.Next;
         end;
         QrLetterData.First;
         ShellExecute(Handle, 'Open',Pchar(FileName),nil,nil,SW_SHOWNORMAL);
     end;
{     With DMScanImage do
        if SelectDirectory(Dir, [sdAllowCreate, sdPerformCreate, sdPrompt],0) then
        begin
           //QrLetterData.First;

          DMScanImage.QrSelImage.Close;
          DMScanImage.QrSelImage.SQL.Clear;
          DMScanImage.QrSelImage.SQL.Add('Select * From LetterData');
          DMScanImage.QrSelImage.SQL.Add('Where LetterID ='+IntToStr(LetterID));
          DMScanImage.QrSelImage.Open;
          ShowPageFromAll;
          Close_Open_QrLetterData;
//           While Not QrLetterData.Eof do
           while not ImageEnDBVect1.DataSource.DataSet.EOF do
           begin                }
              {if QrSelImageExtention.AsInteger = 1 then
                 FileName := Trim(QrSelImageLetterID.AsString)+'_'+IntToStr(QrSelImage.RecNo)+'.Jpg'
              else
                 FileName := Trim(QrSelImageLetterID.AsString)+'_'+IntToStr(QrSelImage.RecNo)+'.Tif';}
              //QrSelImageImage.SaveToFile(Dir+'\'+ FileName);
 {             Application.ProcessMessages;
              FileNu := FileNu + 1;
              FileName := Trim(QrSelImageLetterID.AsString)+'_'+IntToStr(FileNu)+'.Jpg';
              if (FileExists(FileName))and not(File_IsInUse(FileName)) then
                 DeleteFile(FileName);
              ImageEnDBVect1.IO.SaveToFileJpeg(Dir+'\'+ FileName);

              ImageEnDBVect1.DataSource.DataSet.Next;
              //QrLetterData.Next;
           end;
           if FileExists(Dir+'\'+ FileName) then
              ShellExecute(Handle, 'Open',Pchar(Dir+'\'+ FileName),nil,nil,SW_SHOWNORMAL);
        end; }
  Finally
     BBSaveAllToFiles.Enabled := True;
     Screen.Cursor := crDefault;
  End;

end;

procedure TFmScanImage.SBReplacePicClick(Sender: TObject);
Var
   PageNumber:Integer;
   LetterDataID : Integer;
   I : Integer;
   tbl : array [1..4,1..32000] of integer;   //1-> RecNo    2-> LetterDataID  3->PageNumber  4-> New PageNumber
   RecCount : integer;
   Source: integer;
   Destination:integer;
   temp: integer;
begin
   inherited;
   if DMScanImage.QrLetterData.RecordCount = 0 then  // «ê—  ’ÊÌ— „ÊÃÊœ ‰»«‘œ
      Exit;
   LetterDataID := DMScanImage.QrLetterDataLetterDataID.AsInteger;
   Source := DMScanImage.QrLetterData.RecNo;
   Destination := StrToIntDef(InputBox('‘„«—Â ’›ÕÂ','·ÿ›« ‘„«—Â ’›ÕÂ —« «’·«Õ ‰„«ÌÌœ', DMScanImage.QrSelImagePageNumber.AsString),0);

   if Source=Destination then  // «ê— ‘„«—Â „»œ« Ê „ﬁ’œ ÌòÌ »«‘œ
      exit;
   if (Destination<1)or(Destination>DMScanImage.QrLetterData.RecordCount) then  // «ê— ‘„«—Â „ﬁ’œ Œ«—Ã «“ »«“Â »«‘œ
      exit;

   with TADOQuery.Create(nil) do
   begin
      Connection := DMScanImage.QrLetterData.Connection;
      SQL.Text := DMScanImage.QrLetterData.SQL.Text;
      Parameters[0].Value := DMScanImage.QrLetterDataLetterID.AsInteger;
      open;
      RecCount := 1;
      First;
      while not eof do
      begin
         tbl[1,RecCount] := RecNo;
         tbl[2,RecCount] := FieldByName('LetterDataID').AsInteger;
         tbl[3,RecCount] := FieldByName('PageNumber').AsInteger;
         inc(RecCount);
         Next;
      end;
   end;

   if Source>Destination then
   begin
      for i:= Source downto Destination do
         tbl[4,i] := tbl[2,i-1];
      tbl[4,Destination] := tbl[2,Source];
      for i:= Destination to Source do
         with TADOQuery.Create(nil) do
         begin
            Connection := DMScanImage.QrLetterData.Connection;
            SQL.Text := 'UPDATE LetterData SET PageNumber='+IntToStr(tbl[3,i])+' WHERE LetterDataID='+IntToStr(tbl[4,i]);
            ExecSQL;
         end;
   end
   else     //Destination > Source
   begin
      for i:= Source to Destination do
         tbl[4,i] := tbl[2,i+1];
      tbl[4,Destination] := tbl[2,Source];
      for i:= Source to Destination do
         with TADOQuery.Create(nil) do
         begin
            Connection := DMScanImage.QrLetterData.Connection;
            SQL.Text := 'UPDATE LetterData SET PageNumber='+IntToStr(tbl[3,i])+' WHERE LetterDataID='+IntToStr(tbl[4,i]);
            ExecSQL;
         end;
   end;

   DMScanImage.QrLetterData.Close;
   DMScanImage.QrLetterData.Open;
   DMScanImage.QrLetterData.Locate('LetterDataID',LetterDataID,[])

 {  With DMScanImage do
   begin
      LetterDataID := QrLetterDataLetterDataID.AsInteger;
      PageNumber := StrToIntDef(InputBox('‘„«—Â ’›ÕÂ','·ÿ›« ‘„«—Â ’›ÕÂ —« «’·«Õ ‰„«ÌÌœ', QrSelImagePageNumber.AsString),0);
      if (PageNumber>0)And(PageNumber<>QrSelImagePageNumber.AsInteger) then
      begin
         //œ— ’Ê—  ÊÃÊœ ‘„«—Â ’›ÕÂ „‘«»Â
         if QrLetterData.Locate('PageNumber',PageNumber,[]) then
         begin
            //„— » »«‘œ Order By PageNumber Õ „« »«Ìœ »— «”«” QrLetterData
            //«’·«Õ ’›ÕÂ Â«Ì »⁄œÌ
            I := PageNumber+1;
            While not QrLetterData.Eof do
            begin
               QrLetterData.Edit;
               QrLetterDataPageNumber.AsInteger := I;
               QrLetterData.Post;
               QrLetterData.Next;
               I := I+1;
            end;

            //«’·«Õ ‘„«—Â ’›ÕÂ «‰ Œ«»Ì
            QrLetterData.Locate('LetterDataID',LetterDataID,[]);
            QrLetterData.Edit;
            QrLetterDataPageNumber.AsInteger := PageNumber;
            QrLetterData.Post;
         end
         else
         begin
            QrLetterData.Edit;
            QrLetterDataPageNumber.AsInteger := PageNumber;
            QrLetterData.Post;
         end;

         Close_Open_QrLetterData;

         //«’·«Õ  „«„Ì ’›Õ«  «“ «» œ«
         I := 1;
         QrLetterData.First;
         While not QrLetterData.Eof do
         begin
            QrLetterData.Edit;
            QrLetterDataPageNumber.AsInteger := I;
            QrLetterData.Post;
            QrLetterData.Next;
            I := I+1;
         end;

         QrLetterData.Locate('LetterDataID',LetterDataID,[]);
      end;
   end;
         }

end;

procedure TFmScanImage.SpeedButton7Click(Sender: TObject);
Var
   I : Integer;
   qry1,qry2 : TADOQuery;
begin
  inherited;
   if DMScanImage.QrLetterData.RecordCount = 0 then
      Exit;

   //«’·«Õ  „«„Ì ’›Õ«  «“ «» œ«
   With DMScanImage do
   begin
      I := 1;
      qry1 := TADOQuery.Create(nil);
      qry1.Connection := QrLetterData.Connection;
      qry2 := TADOQuery.Create(nil);
      qry2.Connection := QrLetterData.Connection;
      qry1.SQL.Text := 'SELECT LetterDataID,PageNumber FROM LetterData WHERE LetterID='+QrLetterDataLetterID.AsString+' ORDER BY PageNumber';
      qry1.Open;
      While not qry1.Eof do
      begin
         qry2.SQL.Text := 'UPDATE LetterData SET PageNumber='+IntToStr(i)+' WHERE LetterDataID='+qry1.Fields.fieldbyname('LetterDataID').AsString;
         qry2.ExecSQL;
         qry1.Next;
         inc(i);
      end;
   end;
end;

procedure TFmScanImage.YRotateLabel1Click(Sender: TObject);
begin
  if Panel6.Width<=0 then
  begin
      Panel6.Width:=147;
      if PageControl1.Enabled then
      begin
         ImageEnDBVect1.LayersRemove(1);//
         ImageEnVect1.DeSelect;
         ImageEnVect1.UnSelAllObjects;
         ImageEnVect1.LayersMergeAll;
         ImageEnVect1.RemoveAllObjects;
         ImageEnVect1.Align := alClient;
         ImageEnVect1.Zoom := ImageEnView1.Zoom;
//         ImageEnVect1.IO.IEBitmap.Assign(ImageEnDBView1.IO.IEBitmap);
         ImageEnDBView1.IO.SaveToFileJpeg(_TempPath+'\t.jpg');
         ImageEnVect1.IO.LoadFromFileJpeg(_TempPath+'\t.jpg');
         ImageEnVect1.Repaint;
         ImageEnVect1.Visible := true;

      end;
  end
  else
  begin
      Panel6.Width:=0;
      if PageControl1.Enabled then
      begin
         ImageEnDBVect1.LayersRemove(1);//
           ImageEnVect1.DeSelect;
           ImageEnVect1.UnSelAllObjects;
           ImageEnVect1.LayersMergeAll;  //????? ????? ??? ?? ?? ????? ?? ???
           ImageEnVect1.RemoveAllObjects;
         ImageEnDBView1.IO.IEBitmap.Assign(ImageEnVect1.IO.IEBitmap);
         ImageEnVect1.Visible := false;
         ImageEnVect1.Align := alNone;
      end;
  end;
end;

procedure TFmScanImage.YRotateLabel2Click(Sender: TObject);
begin
  if Panel7.Width<=0 then
  begin
  Panel7.Width:=250;
  ValueColorID := Dm.qDefineColorsID.AsInteger;
  end
  else
  begin
  Panel7.Width:=0;
  ValueColorID := -1 ;
  end;
  PageControl2Change(Sender);
//  TDrawGrid(DBGrid1).FixedCols:=0;
end;

procedure TFmScanImage.DBGrid1DrawColumnCell(Sender: TObject;
  const Rect: TRect; DataCol: Integer; Column: TColumn;
  State: TGridDrawState);
begin

(*    if not Dm.qDefineColors.IsEmpty then
    if not (DBGrid1.DataSource.DataSet.State in [dsEdit,dsInsert]) then
    if UpperCase(Column.FieldName)=UpperCase('Color') then
    begin
        DBGrid1.Canvas.Brush.Color:=StringToColor(Dm.qDefineColorsColor.AsString);
        DBGrid1.Canvas.FillRect(Rect);
    end;
    ValueColorID := Dm.qDefineColorsID.AsInteger;
*)
end;

procedure TFmScanImage.acShowSelectedPagesExecute(Sender: TObject);
var
  ActionName:String;
begin
  inherited;
  ActionName:='ac'+Dm.qSelectedColorColor.AsString;
  if CheckAccessColors(ActionName) then
  begin
      DMScanImage.ColorID:=Dm.qSelectedColorColorID.AsInteger;
      if DMScanImage.ColorID=-1 then
      begin
         DMScanImage.QrLetterData.Close;
         DMScanImage.QrLetterData.SQL.Text := 'Select LetterDataID ,LetterID ,PageNumber,ColorID  '+
                                                'From LetterData  Where( LetterID = :Pa_LetterID )  And( Extention in (1,2) )  '+
                                                'Order By PageNumber ';
         DMScanImage.QrLetterData.Open;
      end
      else if DMScanImage.ColorID=0 then
      begin
         DMScanImage.QrLetterData.Close;
         DMScanImage.QrLetterData.SQL.Text := 'Select LetterDataID ,LetterID ,PageNumber,ColorID  '+
                                                'From LetterData  Where( LetterID = :Pa_LetterID )  And( Extention in (1,2) )  '+
                                                'And( (ColorID IS NULL) OR (ColorID=0) ) Order By PageNumber ';
         DMScanImage.QrLetterData.Open;
      end
      else if DMScanImage.ColorID>0 then
      begin
         DMScanImage.QrLetterData.Close;
         DMScanImage.QrLetterData.SQL.Text := 'Select LetterDataID ,LetterID ,PageNumber,ColorID  '+
                                                'From LetterData  Where( LetterID = :Pa_LetterID )  And( Extention in (1,2) )  '+
                                                'And ColorID='+IntToStr(DMScanImage.ColorID)+' Order By PageNumber ';
         DMScanImage.QrLetterData.Open;
      end;
      if not Edit then
        if DMScanImage.QrLetterData.RecordCount = 1 then
          DBN1.VisibleButtons := [nbInsert,nbDelete,nbPost,nbEdit,nbCancel]
        else
          DBN1.VisibleButtons := [nbPrior,nbFirst,nbLast,nbNext,nbInsert,nbDelete,nbPost,nbEdit,nbCancel]
      else
          DBN1.VisibleButtons := [nbPrior,nbFirst,nbLast,nbNext];
 {     DMScanImage.QrSelImage.Close;
      DMScanImage.QrSelImage.SQL.Clear;
      DMScanImage.QrSelImage.SQL.Add('Select  *  From LetterData');
      DMScanImage.QrSelImage.SQL.Add('Where LetterID ='+IntToStr(LetterID));
      DMScanImage.QrSelImage.SQL.Add(' and ColorID='+QuotedStr(IntToStr(Dm.qSelectedColorColorID.AsInteger)));
      DMScanImage.QrSelImage.Open;        }

      ShowNotPageFromAll;
  end
  else
     ShowMsgString('„ÃÊ“ „‘«ÂœÂ ÅÌÊ” Â«Ì «Ì‰ —‰ê —« ‰œ«—Ìœ - »« „œÌ— ”Ì” „ ŒÊœ  „«” »êÌ—Ìœ');
end;

procedure TFmScanImage.acShowAllPagesExecute(Sender: TObject);
begin
  inherited;
  if _CanViewAllAttachPages then
  begin
    DMScanImage.ColorID:=-1;
    DMScanImage.QrLetterData.Close;
       DMScanImage.QrLetterData.SQL.Text := 'Select LetterDataID ,LetterID ,PageNumber,ColorID  '+
                                              'From LetterData  Where( LetterID = :Pa_LetterID )  And( Extention in (1,2) )  '+
                                              'Order By PageNumber ';
       DMScanImage.QrLetterData.Open;
    if not Edit then
      if DMScanImage.QrLetterData.RecordCount = 1 then
        DBN1.VisibleButtons := [nbInsert,nbDelete,nbPost,nbEdit,nbCancel]
      else
        DBN1.VisibleButtons := [nbPrior,nbFirst,nbLast,nbNext,nbInsert,nbDelete,nbPost,nbEdit,nbCancel]
    else
        DBN1.VisibleButtons := [nbPrior,nbFirst,nbLast,nbNext];
    ShowPageFromAll;
    Close_Open_QrLetterData;
  end
  else
    ShowMsgString('„ÃÊ“ „‘«ÂœÂ  „«„ ’›Õ«  ÅÌÊ”  —« ‰œ«—Ìœ - »« „œÌ— ”Ì” „ ŒÊœ  „«” »êÌ—Ìœ');
end;

procedure TFmScanImage.acShowNotColorPagesExecute(Sender: TObject);
begin
  DMScanImage.ColorID:=0;
  DMScanImage.QrLetterData.Close;
  DMScanImage.QrLetterData.SQL.Text := 'Select LetterDataID ,LetterID ,PageNumber,ColorID  '+
                                                'From LetterData  Where( LetterID = :Pa_LetterID )  And( Extention in (1,2) )  '+
                                                'And( (ColorID IS NULL) OR (ColorID=0) ) Order By PageNumber ';
  DMScanImage.QrLetterData.Open;
  if not Edit then
    if DMScanImage.QrLetterData.RecordCount = 1 then
      DBN1.VisibleButtons := [nbInsert,nbDelete,nbPost,nbEdit,nbCancel]
    else
      DBN1.VisibleButtons := [nbPrior,nbFirst,nbLast,nbNext,nbInsert,nbDelete,nbPost,nbEdit,nbCancel]
  else
      DBN1.VisibleButtons := [nbPrior,nbFirst,nbLast,nbNext];
  ShowNotPageFromAll;
  ValueColorID:=-1;
end;

procedure TFmScanImage.ShowPageCount;
begin
  if DMScanImage.ColorID=-1 then
  begin
      if DMScanImage.QrSelImage.Active then
      begin
         Edit1.Visible:=True;
         Edit1.Text:='';
         try
          if DMScanImage.QrSelImageColorID.AsInteger > 0 then
           Edit1.Color:= StringToColor(GetColor(DMScanImage.QrSelImageColorID.AsInteger));
         except
            Edit1.Color:= Panel8.Color;
         end;
      end
      else
         ShowMessage('»Â ⁄·  »—Ê“ Œÿ« ÃœÊ· ’›Õ«  ÅÌÊ”  ‘œÂ »«“ ‰‘œ ·ÿ›« «“ ‰—„ «›“«— Œ«—Ã ‘œÂ Ê „Ãœœ«  ·«‘ ò‰Ìœ');
  end;
  if DMScanImage.ColorID=0 then
  begin
      if DMScanImage.QrSelImage.Active then
      begin
         Edit1.Visible:=True;
         Edit1.Color:= Panel8.Color;
      end
      else
         ShowMessage('»Â ⁄·  »—Ê“ Œÿ« ÃœÊ· ’›Õ«  ÅÌÊ”  ‘œÂ »«“ ‰‘œ ·ÿ›« «“ ‰—„ «›“«— Œ«—Ã ‘œÂ Ê „Ãœœ«  ·«‘ ò‰Ìœ');
  end;
  if DMScanImage.ColorID>0 then
  begin
      if DMScanImage.QrSelImage.Active then
      begin
         Edit1.Visible:=True;
         Edit1.Text:='';
       //  ShowMessage(Dm.qSelectedColorColor.AsString);
         if (Dm.qSelectedColorColor.AsString <> '') and (Dm.qSelectedColorColor.AsString <> '›«ﬁœ —‰ê') and (Dm.qSelectedColorColor.AsString <> ' „«„ „Ê«—œ') then
          Edit1.Color:= StringToColor(Dm.qSelectedColorColor.AsString);
      end
      else
         ShowMessage('»Â ⁄·  »—Ê“ Œÿ« ÃœÊ· ’›Õ«  ÅÌÊ”  ‘œÂ »«“ ‰‘œ ·ÿ›« «“ ‰—„ «›“«— Œ«—Ã ‘œÂ Ê „Ãœœ«  ·«‘ ò‰Ìœ');
  end;
end;

procedure TFmScanImage.acAttachColorExecute(Sender: TObject);
begin
  inherited;
  if _CanAttachColor then
  begin
      try
        if DMScanImage.QrSelImageLetterDataID.AsInteger>0 then
        begin
            if not Dm.qDefineColors.IsEmpty then
            begin
                qAttachColor.Close;
//                qAttachColor.Parameters.ParamByName('ColorID').Value:=Dm.qDefineColorsID.AsInteger;

                qAttachColor.Parameters.ParamByName('LetterDataID').Value:=DMScanImage.QrSelImageLetterDataID.AsInteger;
                qAttachColor.ExecSQL;
                Exec_insert_UserLog('SetImageColor',DMScanImage.QrSelImageLetterID.AsInteger);
                Dm.Insert_LetterEdit(DMScanImage.QrSelImageLetterID.AsInteger,'«‰ ’«» —‰ê »Â  ’ÊÌ—');
                ShowMsgString('«‰ ’«» —‰ê »« „Ê›ﬁÌ  «‰Ã«„ ‘œ');
            end;
        end
        else
            ShowMsgString('„Ê—œÌ ÊÃÊœ ‰œ«—œ');
      except on e:exception do
        ShowMsgString('«‘ »«Â œ— «‰ ’«» —‰ê —Œ œ«œ');
      end;
  end
  else
      ShowMsgString('„ÃÊ“  €ÌÌ—«  œ— ê—ÊÂ »‰œÌ ÅÌÊ”  Â« —« ‰œ«—Ìœ - »« „œÌ— ”Ì” „ ŒÊœ  „«” »êÌ—Ìœ');
end;

procedure TFmScanImage.ShowPageFromAll;
begin
end;

procedure TFmScanImage.ShowNotPageFromAll;
begin
  FmScanImage.StaticText1.Visible:=False;
end;

function TFmScanImage.GetColor(ColorID: Integer): String;
begin
  Result:='';
  if ColorID>0 then
  begin
      qGetColor.Close;
      qGetColor.Parameters.ParamByName('ColorID').Value:=ColorID;
      qGetColor.Open;
      if not qGetColor.IsEmpty then  Result:=qGetColorColor.AsString;
  end;
end;

procedure TFmScanImage.DBGrid2DrawColumnCell(Sender: TObject;
  const Rect: TRect; DataCol: Integer; Column: TColumn;
  State: TGridDrawState);
begin
    if not DBGrid2.DataSource.DataSet.IsEmpty then
    if DBGrid2.DataSource.DataSet.FieldValues['ColorID']>0 then
    if UpperCase(Column.FieldName)=UpperCase('Color') then
    begin
        DBGrid2.Canvas.Brush.Color:=StringToColor(Dm.qSelectedColorColor.AsString);
        DBGrid2.Canvas.FillRect(Rect);
    end;
end;

procedure TFmScanImage.PageControl2Change(Sender: TObject);
begin
  If PageControl2.ActivePageIndex=0 then
  begin
      Dm.OpenqSelectedColor(LetterID);
      ValueColorID := -1;
      Dm.qSelectedColor.Locate('Color','›«ﬁœ —‰ê',[]);
      DBGrid2DblClick(Sender);
      Edit1.Color := clBtnFace;
  end;
  PageControl2.SetFocus;
end;

procedure TFmScanImage.DBGrid2DblClick(Sender: TObject);
begin
 if DBGrid2.DataSource.DataSet.FieldValues['ColorID']>0 then
    acShowSelectedPagesExecute(Application)
 else if DBGrid2.DataSource.DataSet.FieldValues['ColorID']=0 then
 begin
    acShowNotColorPagesExecute(Application)
  end
 else if DBGrid2.DataSource.DataSet.FieldValues['ColorID']=-1 then
    acShowAllPagesExecute(Application);
 if DMScanImage.QrLetterData.IsEmpty then
 begin
   ImageEnDBView1.Clear;
   Edit1.Visible:=False;
   end;
  SelecttionColorId := Dm.qSelectedColorColorID.AsInteger;
  if (_MyPuletColors <> '') and (_MyPuletColors <> '›«ﬁœ —‰ê') and (_MyPuletColors <> ' „«„ „Ê«—œ') then
   Edit1.Color := StringToColor(_MyPuletColors)
  else
   Edit1.Color := clBtnFace;
end;

function TFmScanImage.CheckAccessColors(ActionName: String): Boolean;
begin
   Result:=False;
   if _CanViewAllAttachPages then
      Result:=True
   else
   begin
       QCheckActionAccess.Close;
       QCheckActionAccess.Parameters.ParamByName('acName').Value:=ActionName;
       QCheckActionAccess.Parameters.ParamByName('AccessID').Value:=_AccessID;
       QCheckActionAccess.Open;
       if not QCheckActionAccess.IsEmpty then
          Result:=QCheckActionAccessHasAccess.AsBoolean;
   end;
end;

procedure TFmScanImage.acDeAttachColorExecute(Sender: TObject);
begin
  inherited;
  if _CanAttachColor then
  begin
      try
        if DMScanImage.QrSelImageLetterDataID.AsInteger>0 then
        begin
            qAttachColor.Close;
            qAttachColor.Parameters.ParamByName('ColorID').Value:=Null;
            qAttachColor.Parameters.ParamByName('LetterDataID').Value:=DMScanImage.QrSelImageLetterDataID.AsInteger;
            qAttachColor.ExecSQL;
            Exec_insert_UserLog('RemoveImageColor',DMScanImage.QrSelImageLetterID.AsInteger);
            Dm.Insert_LetterEdit(DMScanImage.QrSelImageLetterID.AsInteger,'Õ–› —‰ê  ’ÊÌ—');
            ShowMsgString('⁄„·Ì«  „—»ÊÿÂ «‰Ã«„ ‘œ');
        end
        else
            ShowMsgString('„Ê—œÌ ÊÃÊœ ‰œ«—œ');
      except on e:exception do
        ShowMsgString('«‘ »«Â œ— ⁄œ„ «‰ ’«» —‰ê —Œ œ«œ');
      end;
  end
  else
      ShowMsgString('„ÃÊ“  €ÌÌ—«  œ— ê—ÊÂ »‰œÌ ÅÌÊ”  Â« —« ‰œ«—Ìœ - »« „œÌ— ”Ì” „ ŒÊœ  „«” »êÌ—Ìœ');
end;

procedure TFmScanImage.ChangeJPGToTifAndSave(FileName: String);
var
   im1,im2 :TImage;
   r1, r2: TRect;
   can1, can2: TCanvas;
   imV1,imV2: TImageEnView;
   imP1 : TImageEnProc;
begin
   imV1 := TImageEnView.Create(self);
   imV2 := TImageEnView.Create(self);
   imV2.IO.LoadFromFileJpeg(FileName);
   imV2.IO.SaveToFileBMP(_TempPath+'\tmp.bmp');
   im1 := TImage.Create(self);
   im2 := TImage.Create(self);
   im1.Picture.Bitmap.LoadFromFile(_TempPath+'\tmp.bmp');
   im2.Picture.bitmap.Height := im1.Picture.bitmap.Height;
   im2.Picture.bitmap.Width := im1.Picture.bitmap.Width;
   r1 := Rect(0,0,im1.picture.bitmap.Width,im1.picture.bitmap.Height);
   r2 := Rect(0,0,im2.picture.bitmap.Width,im2.picture.bitmap.Height);
   can1 := im1.Picture.Bitmap.Canvas;
   can2 := im2.Picture.Bitmap.Canvas;
   im2.Picture.Bitmap.PixelFormat := pf1bit;
   can2.CopyRect(r2,can1,r1);
   Im2.Picture.Bitmap.SaveToFile(_TempPath+'\tmp.bmp');
   im1.Free;
   im2.Free;
   try
      imV1.IO.LoadFromFileTIFF(_TempPath+'\4.tif');
   except
   end;
   imV2.IO.Bitmap.PixelFormat := pf1bit;
   imV2.IO.LoadFromFileBMP(_TempPath+'\tmp.bmp');
{   imP1 := TImageEnProc.Create(self);
   imP1.AttachedImageEn := imV2;
   imP1.ConvertToBWThreshold(50);  }
   imV1.IO.Bitmap.PixelFormat := pf1bit;
//   imV1.IO.Bitmap.Assign();
   imV2.IO.SaveToFileTIFF(FileName+'.tiff');
   imV1.IEBitmap.Assign(imV2.IEBitmap);
   imV1.IO.SaveToFileTIFF(FileName+'.tiff');
   imV1.Free;
   imV2.Free;
   DeleteFile(_TempPath+'\tmp.bmp');
   FillData(FileName+'.tiff');
   DeleteFile(FileName+'.tiff');
end;

procedure TFmScanImage.ImageEnVect1KeyUp(Sender: TObject; var Key: Word;
  Shift: TShiftState);
var
  i: integer;
begin
  inherited;
  if Key = Vk_Delete then
  begin
     For i := ImageEnVect1.SelObjectsCount - 1 downto 0 do
        ImageEnVect1.RemoveObject(ImageEnVect1.SelObjects[i]);
  end;
  ImageEnVect1.Proc.SaveUndo();
end;

procedure TFmScanImage.ImageEnVect1MouseDown(Sender: TObject;
  Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  inherited;
  if SbBrush.Down then
  begin
     StartX:=X;
     startY:=Y;
     if (PageControl1.ActivePage=BrushTab) then
        ImageEnVect1MouseMove(self,Shift,X,Y);
  end;
end;

procedure TFmScanImage.ImageEnVect1MouseMove(Sender: TObject;
  Shift: TShiftState; X, Y: Integer);
Var
  px,py:integer;
  bx,by:integer;
  op:TIERenderOperation;
  Operation : Byte;
begin
  if SBBrush.Down then
  begin
       Operation := 0;
       OP := TIERenderOperation(Operation);
       with ImageEnVect1 do
         if LayersCount=2 then
         begin
           with Layers[1] do
           begin
              bx := Bitmap.Width;
              by := Bitmap.Height;
              px := XScr2Bmp(X) - Width div 2;
              py := YScr2Bmp(Y) - Height div 2;
              PosX := px;
              PosY := py;
              Operation := op;
           end;
           if MouseCapture then  // paint the layer (the brush...)
           begin
               Layers[1].Bitmap.RenderToTIEBitmapEx( Layers[0].Bitmap, px,py,bx,by, 0,0,bx,by, 255,rfNone,op );
               Layers[1].Bitmap.MergeAlphaRectTo( Layers[0].Bitmap, 0,0,px,py, bx,by);
           end;
           Update;
         end;
     lastX:=X;
     lastY:=Y;
  end;
end;

procedure TFmScanImage.ImageEnVect1NewObject(Sender: TObject;
  hobj: Integer);
begin
  inherited;
  ImageEnVect1.MouseInteractVt := [miObjectSelect];
end;

procedure TFmScanImage.ImageEnVect1ViewChange(Sender: TObject;
  Change: Integer);
begin
  inherited;
  LabelZoom .Caption :='»“—ê‰„«ÌÌ  :    '+ FloatToStr( Round(ImageEnVect1.Zoom) )+'%';
end;

procedure TFmScanImage.ImageEnDBView1ViewChange(Sender: TObject;
  Change: Integer);
begin
  inherited;
    LabelZoom .Caption :='»“—ê‰„«ÌÌ  :    '+ FloatToStr( Round(ImageEnDBView1.Zoom) )+'%';
     if (Dm.GetValue(2104) = 2) and (flag = 0)  then
     begin
      ImageEnDBView1.AutoFit := False;
      ImageEnDBView1.Zoom := 100;
      if ImageEnVect1.Visible then
         ImageEnVect1.Zoom := 100;
      LabelZoom .Caption :='»“—ê‰„«ÌÌ  :    '+ FloatToStr( Round(ImageEnDBView1.Zoom) )+'%';
     end
end;

procedure TFmScanImage.BitBtn4Click(Sender: TObject);
Var
   FilenamePath, filename :String;
   i : integer;
begin
   inherited;
   TWAIN_SetHideUI(true);
   TWAIN_SetFileAppendFlag(false);
   TWAIN_SetJpegQuality((dm.GetValue(802)+1)*10);

   if TWAIN_OpenDefaultSource() then
   begin
      TWAIN_SetXferCount(-1);
      TWAIN_SetAutoScan(true);
      TWAIN_SetMultiTransfer(true);
      if dm.GetValue(801) = 0 then
         TWAIN_SetPixelType(TWPT_BW)
      else if dm.GetValue(801) = 1 then
         TWAIN_SetPixelType(TWPT_GRAY)
      else if dm.GetValue(801) = 2 then
         TWAIN_SetPixelType(TWPT_RGB);
      i := 1;
      repeat
         if dm.GetValue(803)=0 then
            fileName := _TempPath +'image'+IntToStr(i)+'.jpg'
         else
            fileName := _TempPath +'image'+IntToStr(i)+'.tif';
         if (TWAIN_AcquireToFilename(self.Handle, pchar(fileName))<>0) then
            break;
         LoadAndShow(fileName);
         if not(DMScanImage.QrLetterData.State in [dsedit,dsinsert]) then
            break;
         i := i+1;
      until TWAIN_IsDone();
      TWAIN_CloseSource();
      DMScanImage.QrLetterData.Cancel;
      Close_Open_QrLetterData;
      DMScanImage.QrLetterData.Last;
   end;
   if TWAIN_LastErrorCode()<>0 then
      TWAIN_ReportLastError(pchar('Œÿ« œ— «”ò‰  ’«ÊÌ—'+ '   '+ ' ERROR CODE : '+ inttostr(TWAIN_LastErrorCode())));
end;

procedure TFmScanImage.LoadAndShow(filename : string);
var
  SaveFileUrl,SaveFileName:String;
begin

  _JpegFIleChange.SetBMPFileDPI(filename,StrToInt(  _BaseSQLConnection.GetKeyvalue('IMGDPI')));
  DMScanImage._IsScan:=True;
   if (DMScanImage.QrLetterData.State = dsedit) then
   begin
     _BaseSQLConnection.SaveLog('Edit','');
      DMScanImage.QrSelImage.Edit;

      if (UpperCase(File_GetFileExt(filename)) = 'TIF')or(UpperCase(File_GetFileExt(filename)) = 'TIFF') then
         DMScanImage.QrSelImageExtention.AsInteger := 2 //TIFF
      else
         DMScanImage.QrSelImageExtention.AsInteger := 1; //JPEG Format
      ImageEnVect1.LayersRemove(1);
      DMScanImage.QrSelImageLastUpdate.AsDateTime := Now;
      DMScanImage.QrSelImageLetterID.AsInteger := fmScanImage.LetterID;
      DMScanImage.QrSelImageIsCorrectedImage.AsBoolean := True;
      if ValueColorID <> -1 then
         if _BaseSQLConnection.GetKeyvalue('SaveFileType')= '1' then
          begin
         SaveFileUrl:=  _MyLetterID+FormatDateTime('hhmmss',now)+ExtractFileExt(filename);

         SaveFileName:= UploadFileToFTP(filename,SaveFileUrl);
         DMScanImage.QrSelImage.FieldByName('path').Value:=SaveFileName;
         DMScanImage.QrSelImage.FieldByName('url').Value:=SaveFileName;

         end;
 DMScanImage.QrSelImage.FieldByName('Letterid').Value:=_MyLetterID;
      DMScanImage.QrSelImage.Post;
      DMScanImage.QrLetterData.Cancel;
   end
   else if (DMScanImage.QrLetterData.State = dsinsert) then
   begin
              _BaseSQLConnection.SaveLog('Inset','');
      DMScanImage.QrSelImage.Insert;
      if (UpperCase(File_GetFileExt(filename)) = 'TIF')or(UpperCase(File_GetFileExt(filename)) = 'TIFF') then
         DMScanImage.QrSelImageExtention.AsInteger := 2 //TIFF
      else
         DMScanImage.QrSelImageExtention.AsInteger := 1; //JPEG Format
      ImageEnVect1.LayersRemove(1);
      DMScanImage.QrSelImageLastUpdate.AsDateTime := Now;
      DMScanImage.QrSelImageLetterID.AsInteger := fmScanImage.LetterID;
      DMScanImage.QrSelImageIsCorrectedImage.AsBoolean := True;
      DMScanImage.QrSelImagePageNumber.AsInteger := dm.YeganehConnection.execute('select isnull(max(pagenumber),0)+1 from letterdata where letterid = '+IntToStr(fmScanImage.LetterID)).fields[0].Value;
      if ValueColorID <> -1 then
        DMScanImage.QrSelImageColorID.AsInteger := ValueColorID ;


        if _BaseSQLConnection.GetKeyvalue('SaveFileType')= '1' then
          begin

         SaveFileUrl:= _MyLetterID+ FormatDateTime('hhmmss',now)+ExtractFileExt(filename);
         SaveFileName:= UploadFileToFTP(filename,SaveFileUrl);
         DMScanImage.QrSelImage.FieldByName('path').Value:=SaveFileName;
         DMScanImage.QrSelImage.FieldByName('url').Value:=SaveFileName;

         end;
         DMScanImage.QrSelImage.FieldByName('LetterID').Value:=_MyLetterID;
         DMScanImage.QrSelImage.FieldByName('url').Value:=SaveFileName;

         DMScanImage.QrSelImage.FieldByName('LetterID').Value:=_MyLetterID;
      DMScanImage.QrSelImage.Post;
   end;
end;

procedure TFmScanImage.acSettingsExecute(Sender: TObject);
begin
  inherited;
   Settings := TSettings.Create(Nil);
   PageControl_SetTabSheet(Settings.PageControl1,'TShSystem');//PageControl «‰ Œ«» »—êÂ ò‰ —·
   Settings.ChBoFax.Font.Color := clBlue;
   Settings.HasJpg.Font.Color := clBlue;
   Settings.ShowModal;
end;

function TFmScanImage.UploadFileToFTP(Source, UploadFile: String): String;
 Var
    UploadDirectory:String;
begin
with IdFTP1 do
  begin
    try
    Host:=_DownloadSetting._FtpIP;
    Username:=_DownloadSetting._FtpUserName;//'turaj'  ;
    Password:=_DownloadSetting._FtpPassword;//'yeganeh_987' ;
    Connect();
     if Connected then
      begin
       try
          UploadDirectory :=FormatDateTime('yyyy',now);
          IdFTP1.MakeDir(UploadDirectory);
        except

        end;

        try
          UploadDirectory :=FormatDateTime('yyyy',now)+'\'+FormatDateTime('mm',now);
          IdFTP1.MakeDir(UploadDirectory);
        except

        end;

        try
          UploadDirectory :=FormatDateTime('yyyy',now)+'\'+FormatDateTime('mm',now)+'\'+FormatDateTime('dd',now);
          IdFTP1.MakeDir(UploadDirectory);
        except

        end;
           Put(Source,UploadDirectory+'\'+UploadFile);
      end;
    except
        on E:Exception Do
          _BaseSQLConnection.SaveLog(e.Message,'TFrAddLetterDataDialog.UploadFileToFT');
    end;
        disconnect;
  end;
  Result:=UploadDirectory+'\'+UploadFile;
end;

procedure TFmScanImage.ItializeDownloadSetting;
begin
 _JpegFIleChange:=TImageFile.Create;

_BaseSQLConnection:=TBaseSQLConnection.Create;
_DownloadSetting._HttpUrl:=_BaseSQLConnection.GetKeyvalue('HttpUrl');
_DownloadSetting._FtpIP:=_BaseSQLConnection.GetKeyvalue('FtpIP');
_DownloadSetting._FtpUserName:=_BaseSQLConnection.GetKeyvalue('FtpUserName');
_DownloadSetting._FtpPassword:=_BaseSQLConnection.GetKeyvalue('FtpPassword');
end;

procedure TFmScanImage.LoadImages;
var
  I:Integer;
  FilePatch,NewURL:string;
begin
//
pb1.Visible:=True;
pb1.Max:=DMScanImage.SPAllImage.RecordCount;
for I  := 1 to DMScanImage.SPAllImage.RecordCount do
  begin
    Application.ProcessMessages;
    pb1.Position:=i;
    with DMScanImage do
    begin
      FilePatch:=SPAllImage.fieldbyname('path').AsString;
      NewURL:=DownloadFiles(FilePatch);
      SPAllImage.Edit;
      SPAllImage.fieldbyname('Filetype').Value:=NewURL;
      SPAllImage.Post;
      Sleep(1000);
      SPAllImage.Next;
    end;
  end;
pb1.Visible:=False
end;

procedure TFmScanImage.DBAdvGrid1DblClick(Sender: TObject);
begin
  inherited;
// if DBAdvGrid1.DataSource.DataSet.FieldValues['ColorID']>0 then
//    acShowSelectedPagesExecute(Application)
// else if DBAdvGrid1.DataSource.DataSet.FieldValues['ColorID']=0 then
//    acShowNotColorPagesExecute(Application)
// else if DBAdvGrid1.DataSource.DataSet.FieldValues['ColorID']=-1 then
//    acShowAllPagesExecute(Application);
// if DMScanImage.QrLetterData.IsEmpty then
//   ImageEnDBView1.Clear;
//
//  SelecttionColorId := Dm.qSelectedColorColorID.AsInteger;
end;

procedure TFmScanImage.InitializeDBADVGroup;
var
I:Integer;
begin
//  Dm.qSelectedColor.RecNo:=1;
//for I := 0 to Dm.qSelectedColor.RecordCount do
//  begin
//    try
//    DBAdvGrid1.AddShape(2,i,csRectangle,StringToColor(Dm.qSelectedColor.FieldByName('Color').AsString),clBlack, haBeforeText, vaCenter);
//    except
//    end;
//    Dm.qSelectedColor.Next;
//  end;
//    InitDBGrid2;
//     DBAdvGrid1.Group(5);
////  advstringgrid1.SubGroup(1);
//  DBAdvGrid1.ContractAll;
end;

procedure TFmScanImage.InitDBGrid2;
begin
//  DBAdvGrid1.Grouping.MergeHeader := true;
//  DBAdvGrid1.Grouping.HeaderColor := clWhite;
//  DBAdvGrid1.Grouping.HeaderColorTo := clInfoBk;
//  DBAdvGrid1.SaveFixedCells := false;
//
//
//DBAdvGrid1.Group(5);
////DBAdvGrid1.SubGroup(2);
//
//  DBAdvGrid1.ContractAll;
////  DBAdvGrid1.Cells[1, 0] := 'Brand';
////  DBAdvGrid1.Cells[2, 0] := 'Type';
////  DBAdvGrid1.Cells[3, 0] := 'Cyl';
end;

procedure TFmScanImage.Button1Click(Sender: TObject);
var
  I:Integer;
begin
  inherited;
  (*Hamed_Ansari
  DBAdvGrid2.HideColumn(5);
      DBAdvGrid2.HideColumn(2);
Dm.qDefineColors.RecNo:=1;
for I := 1 to Dm.qDefineColors.RecordCount do
  begin
    try
    DBAdvGrid2.AddShape(3,i,csRectangle,StringToColor(Dm.qDefineColors.FieldByName('Color').AsString),clBlack, haBeforeText, vaCenter);
    except
    end;

    Dm.qDefineColors.Next;
  end;
   DBAdvGrid2.Grouping.MergeHeader := true;
  DBAdvGrid2.Grouping.HeaderColor := clWhite;
  DBAdvGrid2.Grouping.HeaderColorTo := clInfoBk;
  DBAdvGrid2.SaveFixedCells := false;


DBAdvGrid2.Group(2);
//DBAdvGrid1.SubGroup(2);

  DBAdvGrid2.ContractAll;
     DBAdvGrid2.Group(2);
//  advstringgrid1.SubGroup(1);
  DBAdvGrid2.ContractAll;

//    DBAdvGrid2.HideColumn(1)
*)
end;

procedure TFmScanImage.DBAdvGrid2ClickCell(Sender: TObject; ARow,
  ACol: Integer);
begin
  inherited;
  (*Hamed_Ansari
  try
  ValueColorID := StrToInt(DBAdvGrid2.Cells[4,ARow]);
  except

  end;
  Label3.Caption:=DBAdvGrid2.Cells[4,ARow];
  try
  _MyPuletColors  := DBAdvGrid2.Cells[3,ARow];
 Edit1.Color:= StringToColor(DBAdvGrid2.Cells[3,ARow]);
 except

 end;
 *)
end;

procedure TFmScanImage.DBAdvGrid2GetAlignment(Sender: TObject; ARow,
  ACol: Integer; var HAlign: TAlignment; var VAlign: TVAlignment);
begin
  inherited;
        (*Hamed_Ansari
    		VAlign := vtaCenter;
        HAlign:=taleftJustify;
        *)

end;

procedure TFmScanImage.acShowSelectedPagesExecute1(ColorID: String);
var
  ActionName:String;
begin
  DMScanImage.QrLetterData.Close;
  DMScanImage.QrLetterData.SQL.Text := 'Select LetterDataID ,LetterID ,PageNumber,ColorID  '+
                                        'From LetterData  Where( LetterID = :Pa_LetterID )  And( Extention in (1,2) )  '+
                                        'And ColorID='+ColorID+' Order By PageNumber ';
  DMScanImage.QrLetterData.Open;


  ShowNotPageFromAll;
  DMScanImage.QrLetterData.Last;
  try
   if (_MyPuletColors <> '') and (_MyPuletColors <> '›«ﬁœ —‰ê') and (_MyPuletColors <> ' „«„ „Ê«—œ') then
    Edit1.Color:= StringToColor(_MyPuletColors)
   else
    Edit1.Color := clBtnFace; 
  except
  end;

end;

procedure TFmScanImage.Action2Execute(Sender: TObject);
begin
  inherited;
 ControlEnabled(True);
   ImageEnDBVect1.LayersRemove(1);//
         ImageEnVect1.DeSelect;
         ImageEnVect1.UnSelAllObjects;
         ImageEnVect1.LayersMergeAll;
         ImageEnVect1.RemoveAllObjects;
ImageEnVect1.Proc.Rotate(-90);
ImageEnDBView1.Proc.Rotate(-90);
ControlEnabled(False);
end;

procedure TFmScanImage.SavenadLoadInDB(FileNames: String);
var
  SaveFileUrl,SaveFileName:String;
  FileName:String;
begin
  FileName:=FileNames;
  SaveFileUrl:=FileNames;
  SaveFileName:=FileNames;
  _JpegFIleChange.SetBMPFileDPI(filename,StrToInt(_IMGDPI));
  DMScanImage._IsScan:=True;
  if (DMScanImage.QrLetterData.State = dsedit) then
   begin
     _BaseSQLConnection.SaveLog('Edit','');
      DMScanImage.QrSelImage.Edit;
      DMScanImage.QrSelImageImage.LoadFromFile(filename);

      if (UpperCase(File_GetFileExt(filename)) = 'TIF')or(UpperCase(File_GetFileExt(filename)) = 'TIFF') then
         DMScanImage.QrSelImageExtention.AsInteger := 2 //TIFF
      else
         DMScanImage.QrSelImageExtention.AsInteger := 1; //JPEG Format
      ImageEnVect1.LayersRemove(1);
      DMScanImage.QrSelImageLastUpdate.AsDateTime := Now;
      DMScanImage.QrSelImageLetterID.AsInteger := fmScanImage.LetterID;
      DMScanImage.QrSelImageIsCorrectedImage.AsBoolean := True;
      if ValueColorID <> -1 then
        DMScanImage.QrSelImage.FieldByName('path').Value:=SaveFileName;
        DMScanImage.QrSelImage.FieldByName('url').Value:=SaveFileName;
        DMScanImage.QrSelImage.FieldByName('Letterid').Value:=_MyLetterID;
      DMScanImage.QrSelImage.Post;
      DMScanImage.QrLetterData.Cancel;
      ImageEnDBView1.IO.LoadFromFile(FileName);
   end
   else if (DMScanImage.QrLetterData.State = dsinsert) then
   begin
              _BaseSQLConnection.SaveLog('Inset','');
      DMScanImage.QrSelImage.Insert;
           DMScanImage.QrSelImageImage.LoadFromFile(filename);
      if (UpperCase(File_GetFileExt(filename)) = 'TIF')or(UpperCase(File_GetFileExt(filename)) = 'TIFF') then
         DMScanImage.QrSelImageExtention.AsInteger := 2 //TIFF
      else
         DMScanImage.QrSelImageExtention.AsInteger := 1; //JPEG Format
      ImageEnVect1.LayersRemove(1);
      DMScanImage.QrSelImageLastUpdate.AsDateTime := Now;
      DMScanImage.QrSelImageLetterID.AsInteger := fmScanImage.LetterID;
      DMScanImage.QrSelImageIsCorrectedImage.AsBoolean := True;
      DMScanImage.QrSelImagePageNumber.AsInteger := dm.YeganehConnection.execute('select isnull(max(pagenumber),0)+1 from letterdata where letterid = '+IntToStr(fmScanImage.LetterID)).fields[0].Value;
      if ValueColorID <> -1 then
        DMScanImage.QrSelImageColorID.AsInteger := ValueColorID ;
         DMScanImage.QrSelImage.FieldByName('path').Value:=FileName;
         DMScanImage.QrSelImage.FieldByName('LetterID').Value:=_MyLetterID;
         DMScanImage.QrSelImage.FieldByName('url').Value:=FileName;
      ImageEnDBView1.IO.LoadFromFile(FileName);
      DMScanImage.QrSelImage.Post;
   end;
         DeleteFile(filename);
end;

procedure TFmScanImage.ImageEnView1Click(Sender: TObject);
begin
  inherited;
//ShowMessage('my ImageEnView1');
end;

procedure TFmScanImage.ImageEnVect1Click(Sender: TObject);
begin
  inherited;
//ShowMessage('my ImageEnVect1');
end;

procedure TFmScanImage.ImageEnMView1Click(Sender: TObject);
begin
  inherited;
//ShowMessage('ImageEnMView');
end;

procedure TFmScanImage.ImageEnDBView1Click(Sender: TObject);
begin
  inherited;
//ShowMessage('ImageEnDBView1');
end;

procedure TFmScanImage.ScanSQl;
Var
   FilenamePath, filename :String;
   i, v803 : integer;
begin
   inherited;
   Application.ProcessMessages;
   Sleep(2000);
   if dm.GetValue(807) = true then
      TWAIN_SetHideUI(false)
   else
      TWAIN_SetHideUI(true);
   TWAIN_SetFileAppendFlag(false);
//   TWAIN_SetJpegQuality((dm.GetValue(802)+1)*10); Commented By Hamed_Ansari_990130
   TWAIN_SetResolution(StrToInt(_IMGDPI));
   if TWAIN_OpenDefaultSource() then
   begin
      TWAIN_SetXferCount(-1);
      TWAIN_SetAutoScan(true);
      TWAIN_SetMultiTransfer(true);
      if dm.GetValue(801) = 0 then
         TWAIN_SetPixelType(TWPT_BW)
      else if dm.GetValue(801) = 1 then
         TWAIN_SetPixelType(TWPT_GRAY)
      else if dm.GetValue(801) = 2 then
         TWAIN_SetPixelType(TWPT_RGB);
      if (dm.GetValue(805) = 1)and(TWAIN_HasFeeder) then
         TWAIN_SelectFeeder(true)
      else
         TWAIN_SelectFeeder(false);

      If (TWAIN_GetDuplexSupport > 0) Then   // check for duplex support
      begin
         if (dm.GetValue(806) = 1)and(TWAIN_HasFeeder) then
            TWAIN_EnableDuplex(true)
         else
            TWAIN_EnableDuplex(false);
      end;
      i := 1;
      v803 := dm.GetValue(803);
      repeat
         if v803=0 then
            fileName := _TempPath +'image'+IntToStr(i)+'.jpg'
         else
            fileName := _TempPath +'image'+IntToStr(i)+'.tif';
         if (TWAIN_AcquireToFilename(self.Handle, pchar(fileName))<>0) then
            break;
         LoadAndShow_SQL(fileName);
         if not(DMScanImage.QrLetterData.State in [dsedit,dsinsert]) then
            break;
         i := i+1;
      until TWAIN_IsDone();

      TWAIN_CloseSource();
      DMScanImage.QrLetterData.Cancel;
      Close_Open_QrLetterData;
      DMScanImage.QrLetterData.Last;
   end;

   if Dm.GetValue(2104) = 0 then
     FitToPageClick(Self);
   if Dm.GetValue(2104) = 1 then
     SpeedButton5Click(Self);
   if Dm.GetValue(2104) = 2 then
     SpeedButton1Click(Self);
   if TWAIN_LastErrorCode()<>0 then
      TWAIN_ReportLastError(pchar('Œÿ« œ— «”ò‰  ’«ÊÌ—'+ '   '+ ' ERROR CODE : '+ inttostr(TWAIN_LastErrorCode())));
end;

procedure TFmScanImage.LoadAndShow_SQL(filename: string);
begin
   if (DMScanImage.QrLetterData.State = dsedit) then
   begin
      DMScanImage.QrSelImage.Edit;
      DMScanImage.QrSelImageImage.LoadFromFile(filename);
      if (UpperCase(File_GetFileExt(filename)) = 'TIF')or(UpperCase(File_GetFileExt(filename)) = 'TIFF') then
         DMScanImage.QrSelImageExtention.AsInteger := 2 //TIFF
      else
         DMScanImage.QrSelImageExtention.AsInteger := 1; //JPEG Format
      ImageEnVect1.LayersRemove(1);
      DMScanImage.QrSelImageLastUpdate.AsDateTime := Now;
      DMScanImage.QrSelImageLetterID.AsInteger := fmScanImage.LetterID;
      DMScanImage.QrSelImageIsCorrectedImage.AsBoolean := True;
      if ValueColorID <> -1 then
        DMScanImage.QrSelImageColorID.AsInteger := ValueColorID ;
      DMScanImage.QrSelImage.Post;
      DMScanImage.QrLetterData.Cancel;
   end
   else if (DMScanImage.QrLetterData.State = dsinsert) then
   begin
      DMScanImage.QrSelImage.Insert;
      DMScanImage.QrSelImageImage.LoadFromFile(filename);
      if (UpperCase(File_GetFileExt(filename)) = 'TIF')or(UpperCase(File_GetFileExt(filename)) = 'TIFF') then
         DMScanImage.QrSelImageExtention.AsInteger := 2 //TIFF
      else
         DMScanImage.QrSelImageExtention.AsInteger := 1; //JPEG Format
      ImageEnVect1.LayersRemove(1);
      DMScanImage.QrSelImageLastUpdate.AsDateTime := Now;
      DMScanImage.QrSelImageLetterID.AsInteger := fmScanImage.LetterID;
      DMScanImage.QrSelImageIsCorrectedImage.AsBoolean := True;
      DMScanImage.QrSelImagePageNumber.AsInteger := dm.YeganehConnection.execute('select isnull(max(pagenumber),0)+1 from letterdata where letterid = '+IntToStr(fmScanImage.LetterID)).fields[0].Value;
      if DMScanImage.QrSelImagePageNumber.AsInteger =0 then
      DMScanImage.QrSelImagePageNumber.AsInteger:=1;

      if ValueColorID <> -1 then
        DMScanImage.QrSelImageColorID.AsInteger := ValueColorID ;
      DMScanImage.QrSelImage.Post;
   end;
end;

procedure TFmScanImage.OpenFileExecute_SQL(Sender: TObject);
Var
   I,j,fn,DPI :integer;
   IsJpegFormat, isEdit:Boolean;
   FileNamePath : String;
   fs : TFileStream;
   Image : TImageEn;
begin
  inherited;
  if Not(DMScanImage.QrLetterData.State in [dsEdit,dsInsert]) then
     Exit;

  IsJpegFormat :=  dm.GetValue(55);
  IsJpegFormat :=  dm.GetSystemValue(27);
  if IsJpegFormat then
     OpenPictureDialog.filterindex := 1//Filter := 'JPEG Image File (*.jpg;*.jpeg)|*.jpeg;*.jpg'
  else
     OpenPictureDialog.filterindex := 2;//Filter := 'Tiff(*.Tif)|*.Tif';

  if DMScanImage.QrLetterData.State =dsEdit then
      isEdit := true;
  if isEdit then
  begin
     OpenPictureDialog.Filter := 'JPEG Image File (*.jpg;*.jpeg)|*.jpeg;*.jpg' ;
  end
  else
  begin
     OpenPictureDialog.Filter := 'JPEG Image File (*.jpg , *.jpeg)|*.jpeg;*.jpg|Tiff(*.tif , *.tiff)|*.tif;*.tiff';
  end;
  fn := DMScanImage.QrLetterDataLetterDataID.AsInteger;
  if OpenPictureDialog.Execute then
  begin
     Try
        try
         Image := TImageEn.Create(Self);
         Image.Visible := False;
         Image.IO.LoadFromFileAuto(OpenPictureDialog.FileName);
         if Image.DpiX > StrToInt(_IMGDPI) then
           ShowMessage('«„ò«‰ «·’«ﬁ ›«Ì· »«·« — «“ '+ _IMGDPI + 'œÌ ÅÌ ¬Ì ÊÃÊœ ‰œ«—œ ° ·ÿ›«  ‰ŸÌ„«  „—»ÊÿÂ —« «⁄„«· ‰„«∆Ìœ');
        DPI := Image.DpiX;
        finally
         FreeAndNil(Image);
        end;
        if DPI> StrToInt(_IMGDPI) then
          Exit;
        Screen.Cursor := crHourGlass;
        BBOpenFile.Enabled := False;
        if (not IsJpegFormat) and (OpenPictureDialog.filterindex <> 2) then
           if MessageDlg(' ’«ÊÌ— »’Ê—  ”Ì«Â Ê ”›Ìœ –ŒÌ—Â ‘Ê‰œø',mtConfirmation,[mbYes,mbNo],0)= mrNo then
               IsJpegFormat := true;
        For I:=0 to OpenPictureDialog.Files.Count-1 do
        begin
           if FileExists(_ApplicationPath+'tmpFile'+ExtractFileExt(OpenPictureDialog.Files.Strings[I]))then
                DeleteFile(pchar(_ApplicationPath+'tmpFile'+ExtractFileExt(OpenPictureDialog.Files.Strings[I])));
            if CopyFileW( dm.replacePWC(dm.StringToPWide(OpenPictureDialog.Files.Strings[I],j)), dm.StringToPWide(_ApplicationPath+'tmpFile'+ExtractFileExt(OpenPictureDialog.Files.Strings[I]),j), False) then
               FileNamePath := _ApplicationPath+'tmpFile'+ExtractFileExt(OpenPictureDialog.Files.Strings[I])
            else if CopyFileW( dm.StringToPWide(OpenPictureDialog.Files.Strings[I],j), dm.StringToPWide(_ApplicationPath+'tmpFile'+ExtractFileExt(OpenPictureDialog.Files.Strings[I]),j), False) then
               FileNamePath := _ApplicationPath+'tmpFile'+ExtractFileExt(OpenPictureDialog.Files.Strings[I])
            else
               ShowMessage('Œÿ« œ— ŒÊ«‰œ‰ ›«Ì· „»œ«');

           if (UpperCase(File_GetFileExt(FileNamePath))='TIF')or(UpperCase(File_GetFileExt(FileNamePath))='TIFF')then
           begin
                 ChangeMultyTifToTifsAndSave(FileNamePath);  //›«Ì· TIFF œ— Â— ’Ê—  »’Ê—  TIFF –ŒÌ—Â ‘Êœ
           end
           else if IsJpegFormat then  //›«Ì· JPG œ— ’Ê— Ì òÂ ›—„  Â„ JPG »«‘œ »« »’Ê—  JPG –ŒÌ—Â ‘Êœ
           begin
                 FillData_SQL(FileNamePath);
           end
           else     // ›«Ì· JPG œ— ’Ê— Ì òÂ ›—„  TIFF »«‘œ Ê ÃÊ«» ”Ê«· »«·« YES »«‘œ »«Ìœ »’Ê—  TIFF –ŒÌ—Â ‘Êœ.
           begin
              if not FileExists(_TempPath+'\4.tif') then
              begin
                  fs:=TFileStream.Create(_TempPath+'\4.tif',fmCreate);
                  idDecoderMIME1.DecodeToStream('SUkqAPQAAADIAAAAAQAAAMgAAAABAAAA///////////////////////////////////////////////+Tf'
                        +'QMyTeYNkIHCdP1r6+vrX19fWvr6+tfXINA+vrr0v9L119del/peuvrr0v9L'
                        +'119del/peuvrr669L119dfXXpeuvrr669L119dfXXpeuvrr669L119dfXXpeuvr/S/66X/XiQUzYO6f3/v//////31/fVq1JuMDS//////////'
                        +'//////9qGFJuTDPH/////////////////////////////////////////////////////4AIAIBMA/gAEAAEAAAAAAAAAAAEEAAEAAAATAwAA'
                        +'AQEEAAEAAAATAwAAAgEDAAEAAAABAAAAAwEDAAEAAAAEAAAABgEDAAEAAAAAAAAACgEDAAEAAAABAAAAEQEEAAEAAAA'
                        +'YAAAAFQEDAAEAAAABAAAAFgEEAAEAAAATAwAAFwEEAAEAAADcAAAAGgEFAAEAAAAIAAAAGwEFAAEAAAAQAAAAHAEDAAEAAAABA'
                        +'AAAJAEEAAEAAAAAAAAAJQEEAAEAAAAAAAAAKAEDAAEAAAACAAAAKQEDAAIAAAAAAAAARwEDAAEAAAAAAAAAAAAAAA==',fs);
                  fs.WriteBuffer(fs,fs.InstanceSize);
                  fs.Destroy;
              end;
              ChangeJPGToTifAndSave(FileNamePath);
           end;
        end;
        Close_Open_QrLetterData;

        if (DMScanImage.QrLetterData.State in [dsInsert,dsEdit]) then
           DBN1.BtnClick(nbCancel);
        Close_Open_QrLetterData;
        //DMScanImage.QrLetterData.Last;
     Finally
//        ImageEnDBVect1.FitToWidth;
       // ImageEnDBView1.FitToWidth;
        BBOpenFile.Enabled := True;
        Screen.Cursor := crDefault;

       if Dm.GetValue(2104) = 0 then
         FitToPageClick(Self);
       if Dm.GetValue(2104) = 1 then
         SpeedButton5Click(Self);
       if Dm.GetValue(2104) = 2 then
         SpeedButton1Click(Self);

     End;
  end;

  {Ranjbar 89.06.06 ID=3}
  //Exec_UserLog(TAction(Sender).Tag);
  Exec_UserLog(TAction(Sender).Name);
  //---

  {Ranjbar 89.07.08 ID=12}
  //LetterEdit À»   €ÌÌ—«  «⁄„«· ‘œÂ —ÊÌ ”‰œ œ— ÃœÊ·
  Dm.Insert_LetterEdit(LetterID,'«ÌÃ«œ  ’«ÊÌ— ÃœÌœ');
  ControlEnabled(False);
  if isEdit then
      DMScanImage.QrLetterData.Locate('LetterDataID',fn,[]);
  ImageEnDBView1.FitToWidth;
  //---
 if Dm.GetValue(2104) = 0 then
   FitToPageClick(Self);
 if Dm.GetValue(2104) = 1 then
   SpeedButton5Click(Self);
 if Dm.GetValue(2104) = 2 then
   SpeedButton1Click(Self);
end;

procedure TFmScanImage.FillData_SQL(aFileName: String);
begin
 With DMScanImage do
   begin
      if Not(QrLetterData.State in [dsEdit,dsInsert]) then
         Exit;
      {Ranjbar 89.05.15}
      //QrSelImage.Append;
      if QrLetterData.State=dsinsert then
         QrSelImage.Append
      else
         QrSelImage.Edit;
      //---
      QrSelImageImage.LoadFromFile(aFileName);
      if (UpperCase(File_GetFileExt(aFileName)) = 'TIF')or(UpperCase(File_GetFileExt(aFileName)) = 'TIFF') then
         QrSelImageExtention.AsInteger := 2 //TIFF or Jpeg
      else
         QrSelImageExtention.AsInteger := 1; //JPEG Format
      ImageEnVect1.LayersRemove(1);//
      QrSelImageLastUpdate.AsDateTime := Now;
      QrSelImageLetterID.AsInteger := fmScanImage.LetterID;
      if QrSelImage.State = dsInsert then
         QrSelImagePageNumber.AsInteger := Dm.YeganehConnection.Execute('Select IsNull(Max(PageNumber),0)+1 As NextPageNumber '+
                 ' from LetterData Where Extention <3 And LetterID = '+QrSelImageLetterID.AsString).Fields[0].value;
      {Ranjbar 90.03.18 ID=378} //And ID=105
      QrSelImageIsCorrectedImage.AsBoolean := True;
      //---
      if ValueColorID <> -1 then
        QrSelImageColorID.AsInteger := ValueColorID ;
      QrSelImage.Post;
      Application.ProcessMessages;
   end;
end;

function TFmScanImage.FindColors(NodeName: String): string;
begin
Result:='0';
with TADOQuery.Create(Nil) do
  begin
    sql.Clear;
    SQL.Add('SELECT * FROM DefineColors where Descriptions = N'+QuotedStr(NodeName)+'');
    try
     Connection:=Dm.YeganehConnection;
     open;
     if not IsEmpty then
      Result:=FieldByName('color').asstring;
    except
    end;
    free;
  end;
end;

procedure TFmScanImage.AddNodeINTreeView(LDestNode: TTreeNode;_ID:String);
var
  _Query:String;
  LDestNode2:TTreeNode;
begin
   _Query:='SELECT * FROM DefineColors where parent ='+_ID;
with TADOQuery.Create(nil) do
    begin
    SQL.Clear;
    SQL.Add(_Query);
      Connection:=Dm.YeganehConnection;
     try
      open;
      if IsEmpty then
      begin
      Free;
      Exit;
      end;
         repeat
          try
            LDestNode2:= TreeView1.Items.AddChild(LDestNode, FieldByName('Descriptions').asstring);
            LDestNode2.ImageIndex := CreateBitmapSolidColor(16,16,StringToColor(FieldByName('Color').asString),'');
            AddNodeINTreeView(LDestNode2,FieldByName('ID').asstring);
          except
          end;
           Next;
         until Eof;
     except
     end;
     free
    end;
end;

procedure TFmScanImage.TreeView1Click(Sender: TObject);
begin
  inherited;
  //lblCount.Caption:=' ’›ÕÂ ' + IntToStr(DMScanImage.QrLetterData.RecNo) +' «“ '+IntToStr(DMScanImage.QrLetterData.RecordCount );
   try
    _ColorsID:=FindID('');
     ValueColorID := StrToInt(_ColorsID);
  except

  end;
{Commneted By Hamed_Ansari_990203
  Label3.Caption:=_ColorsID;
  lblCount.Caption:='';
 acShowSelectedPagesExecute1(_ColorsID) ;
 if DMScanImage.QrLetterData.IsEmpty then
 begin
   ImageEnDBView1.Clear;
   lblCount.Caption:=' ’›ÕÂ 0 «“ 0';
   Edit1.Visible:=False;
   end;
  SelecttionColorId := Dm.qSelectedColorColorID.AsInteger;
  lblCount.Caption:=' ’›ÕÂ ' + IntToStr(DMScanImage.QrLetterData.RecNo) +' «“ '+IntToStr(DMScanImage.QrLetterData.RecordCount );
 Edit1.Color:= StringToColor(_MyPuletColors) ;
 Edit1.Visible:=True;
}
end;

function TFmScanImage.FindID(_Name: String): String;
 var
  _Query:String;
begin
if  TreeView1.Selected.Level >= 1 then
 begin
 _Query:=' SELECT s.id,s.color,d.Descriptions DsName, s.Descriptions DsParent FROM DefineColors d join  DefineColors  s on d.ID = s.Parent  where d.ParentName =N' +
           QuotedStr(TreeView1.Selected.Parent.Text) +
         ' and  s.ParentName=N'+QuotedStr(TreeView1.Selected.Text) + '' ;
 end
 else
  begin
   _Query:='SELECT * FROM DefineColors  where Parent =0 and Descriptions = N'+QuotedStr(TreeView1.Selected.Text)+'';
 end;
 with TADOQuery.Create(nil) do
  begin
    SQL.Clear;
    SQL.Add(_Query);
    Connection:=Dm.YeganehConnection;
    try
      open;
      if IsEmpty then
        begin
          free;
          exit;
        end;
         _MyPuletColors :=FieldByName('color').asstring;
          Edit1.Color:= StringToColor(_MyPuletColors) ;
          Panel8.Color:= StringToColor(_MyPuletColors);
         Result:=FieldByName('ID').asstring;
    except
    end;
    free;
  end;
end;

procedure TFmScanImage.TreeView1GetSelectedIndex(Sender: TObject;
  Node: TTreeNode);
begin
  inherited;
  Node.SelectedIndex := Node.ImageIndex;
end;

procedure TFmScanImage.DBGrid2CellClick(Column: TColumn);
begin
  inherited;
 _MyPuletColors := Dm.qSelectedColorColor.AsString;
 ValueColorID := Dm.qSelectedColorColorID.AsInteger;
end;

procedure TFmScanImage.TreeView1DblClick(Sender: TObject);
var
 SelecttionColorId : Integer;
 AQry : TADOQuery;
begin
  inherited;
//Hamed_Ansari_990203_S
   if _CanAttachColor then
    begin
     if not ImageEnVect1.IO.Bitmap.Empty then
        if not Dm.qDefineColors.IsEmpty then
         begin
          AQry := TADOQuery.Create(Application);
           try
            AQry.Connection := Dm.YeganehConnection;
            AQry.Close;
            AQry.SQL.Text := 'Update LetterData Set ColorID = ' + _ColorsID + ' Where LetterDataID = ' + DMScanImage.QrLetterDataLetterDataID.AsString;
            try
             AQry.ExecSQL;
             Exec_insert_UserLog('SetImageColor',DMScanImage.QrSelImageLetterID.AsInteger);
             Dm.Insert_LetterEdit(DMScanImage.QrSelImageLetterID.AsInteger,'«‰ ’«» —‰ê »Â  ’ÊÌ—');
             Close_Open_QrLetterData;
             if DMScanImage.QrLetterData.IsEmpty then
              begin
               Edit1.Color := clBtnFace;
               ImageEnDBView1.Clear;
              end;
             except
             end;
            ShowMyMessage('ÅÌ€«„','«‰ ’«» —‰ê »« „Ê›ﬁÌ  «‰Ã«„ ‘œ',[mbOK],mtInformation);
           finally
            FreeAndNil(AQry);
           end;
         end;
    end
   else
    ShowMsgString('„ÃÊ“  €ÌÌ—«  œ— ê—ÊÂ »‰œÌ ÅÌÊ”  Â« —« ‰œ«—Ìœ - »« „œÌ— ”Ì” „ ŒÊœ  „«” »êÌ—Ìœ');
//Hamed_Ansari_990203_E
end;

procedure TFmScanImage.N11Click(Sender: TObject);
var
 Bookmark : TBookmark;
begin
  inherited;
//Hamed_Ansari_990203_S
  if _CanAttachColor then
  begin
      try
        if DMScanImage.QrLetterDataLetterDataID.AsInteger>0 then
        begin
            qAttachColor.Close;
            qAttachColor.Parameters.ParamByName('ColorID').Value:=Null;
            qAttachColor.Parameters.ParamByName('LetterDataID').Value:=DMScanImage.QrSelImageLetterDataID.AsInteger;
            qAttachColor.ExecSQL;
            Exec_insert_UserLog('RemoveImageColor',DMScanImage.QrSelImageLetterID.AsInteger);
            Dm.Insert_LetterEdit(DMScanImage.QrSelImageLetterID.AsInteger,'Õ–› —‰ê  ’ÊÌ—');
            ShowMsgString('⁄„·Ì«  „—»ÊÿÂ «‰Ã«„ ‘œ');
            Bookmark := Dm.qSelectedColor.GetBookmark;
            Dm.qSelectedColor.Close;
            Dm.qSelectedColor.Open;
            if Dm.qSelectedColor.RecordCount > 2 then
             Dm.qSelectedColor.GotoBookmark(Bookmark);
            Dm.qSelectedColor.FreeBookmark(Bookmark);
            Close_Open_QrLetterData;
            if DMScanImage.QrLetterData.IsEmpty then
             PageControl2Change(Sender);
        end
        else
            ShowMsgString('„Ê—œÌ ÊÃÊœ ‰œ«—œ');
      except 
      end;
  end
  else
      ShowMsgString('„ÃÊ“  €ÌÌ—«  œ— ê—ÊÂ »‰œÌ ÅÌÊ”  Â« —« ‰œ«—Ìœ - »« „œÌ— ”Ì” „ ŒÊœ  „«” »êÌ—Ìœ');
//Hamed_Ansari_990203_E
end;

end.





